(function(){var w=this;var k=w._;var D={};var C=Array.prototype,f=Object.prototype,r=Function.prototype;var G=C.push,o=C.slice,y=C.concat,d=f.toString,j=f.hasOwnProperty;var K=C.forEach,q=C.map,E=C.reduce,c=C.reduceRight,b=C.filter,B=C.every,p=C.some,n=C.indexOf,l=C.lastIndexOf,u=Array.isArray,e=Object.keys,F=r.bind;var L=function(M){if(M instanceof L){return M}if(!(this instanceof L)){return new L(M)}this._wrapped=M};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=L}exports._=L}else{w._=L}L.VERSION="1.4.4";var H=L.each=L.forEach=function(R,Q,P){if(R==null){return}if(K&&R.forEach===K){R.forEach(Q,P)}else{if(R.length===+R.length){for(var O=0,M=R.length;O<M;O++){if(Q.call(P,R[O],O,R)===D){return}}}else{for(var N in R){if(L.has(R,N)){if(Q.call(P,R[N],N,R)===D){return}}}}}};L.map=L.collect=function(P,O,N){var M=[];if(P==null){return M}if(q&&P.map===q){return P.map(O,N)}H(P,function(S,Q,R){M[M.length]=O.call(N,S,Q,R)});return M};var g="Reduce of empty array with no initial value";L.reduce=L.foldl=L.inject=function(Q,P,M,O){var N=arguments.length>2;if(Q==null){Q=[]}if(E&&Q.reduce===E){if(O){P=L.bind(P,O)}return N?Q.reduce(P,M):Q.reduce(P)}H(Q,function(T,R,S){if(!N){M=T;N=true}else{M=P.call(O,M,T,R,S)}});if(!N){throw new TypeError(g)}return M};L.reduceRight=L.foldr=function(S,P,M,O){var N=arguments.length>2;if(S==null){S=[]}if(c&&S.reduceRight===c){if(O){P=L.bind(P,O)}return N?S.reduceRight(P,M):S.reduceRight(P)}var R=S.length;if(R!==+R){var Q=L.keys(S);R=Q.length}H(S,function(V,T,U){T=Q?Q[--R]:--R;if(!N){M=S[T];N=true}else{M=P.call(O,M,S[T],T,U)}});if(!N){throw new TypeError(g)}return M};L.find=L.detect=function(P,O,N){var M;A(P,function(S,Q,R){if(O.call(N,S,Q,R)){M=S;return true}});return M};L.filter=L.select=function(P,O,N){var M=[];if(P==null){return M}if(b&&P.filter===b){return P.filter(O,N)}H(P,function(S,Q,R){if(O.call(N,S,Q,R)){M[M.length]=S}});return M};L.reject=function(O,N,M){return L.filter(O,function(R,P,Q){return !N.call(M,R,P,Q)},M)};L.every=L.all=function(P,O,N){O||(O=L.identity);var M=true;if(P==null){return M}if(B&&P.every===B){return P.every(O,N)}H(P,function(S,Q,R){if(!(M=M&&O.call(N,S,Q,R))){return D}});return !!M};var A=L.some=L.any=function(P,O,N){O||(O=L.identity);var M=false;if(P==null){return M}if(p&&P.some===p){return P.some(O,N)}H(P,function(S,Q,R){if(M||(M=O.call(N,S,Q,R))){return D}});return !!M};L.contains=L.include=function(N,M){if(N==null){return false}if(n&&N.indexOf===n){return N.indexOf(M)!=-1}return A(N,function(O){return O===M})};L.invoke=function(O,P){var M=o.call(arguments,2);var N=L.isFunction(P);return L.map(O,function(Q){return(N?P:Q[P]).apply(Q,M)})};L.pluck=function(N,M){return L.map(N,function(O){return O[M]})};L.where=function(N,M,O){if(L.isEmpty(M)){return O?null:[]}return L[O?"find":"filter"](N,function(Q){for(var P in M){if(M[P]!==Q[P]){return false}}return true})};L.findWhere=function(N,M){return L.where(N,M,true)};L.max=function(P,O,N){if(!O&&L.isArray(P)&&P[0]===+P[0]&&P.length<65535){return Math.max.apply(Math,P)}if(!O&&L.isEmpty(P)){return -Infinity}var M={computed:-Infinity,value:-Infinity};H(P,function(T,Q,S){var R=O?O.call(N,T,Q,S):T;R>=M.computed&&(M={value:T,computed:R})});return M.value};L.min=function(P,O,N){if(!O&&L.isArray(P)&&P[0]===+P[0]&&P.length<65535){return Math.min.apply(Math,P)}if(!O&&L.isEmpty(P)){return Infinity}var M={computed:Infinity,value:Infinity};H(P,function(T,Q,S){var R=O?O.call(N,T,Q,S):T;R<M.computed&&(M={value:T,computed:R})});return M.value};L.shuffle=function(P){var O;var N=0;var M=[];H(P,function(Q){O=L.random(N++);M[N-1]=M[O];M[O]=Q});return M};var a=function(M){return L.isFunction(M)?M:function(N){return N[M]}};L.sortBy=function(P,O,M){var N=a(O);return L.pluck(L.map(P,function(S,Q,R){return{value:S,index:Q,criteria:N.call(M,S,Q,R)}}).sort(function(T,S){var R=T.criteria;var Q=S.criteria;if(R!==Q){if(R>Q||R===void 0){return 1}if(R<Q||Q===void 0){return -1}}return T.index<S.index?-1:1}),"value")};var t=function(R,Q,N,P){var M={};var O=a(Q||L.identity);H(R,function(U,S){var T=O.call(N,U,S,R);P(M,T,U)});return M};L.groupBy=function(O,N,M){return t(O,N,M,function(P,Q,R){(L.has(P,Q)?P[Q]:(P[Q]=[])).push(R)})};L.countBy=function(O,N,M){return t(O,N,M,function(P,Q){if(!L.has(P,Q)){P[Q]=0}P[Q]++})};L.sortedIndex=function(T,S,P,O){P=P==null?L.identity:a(P);var R=P.call(O,S);var M=0,Q=T.length;while(M<Q){var N=(M+Q)>>>1;P.call(O,T[N])<R?M=N+1:Q=N}return M};L.toArray=function(M){if(!M){return[]}if(L.isArray(M)){return o.call(M)}if(M.length===+M.length){return L.map(M,L.identity)}return L.values(M)};L.size=function(M){if(M==null){return 0}return(M.length===+M.length)?M.length:L.keys(M).length};L.first=L.head=L.take=function(O,N,M){if(O==null){return void 0}return(N!=null)&&!M?o.call(O,0,N):O[0]};L.initial=function(O,N,M){return o.call(O,0,O.length-((N==null)||M?1:N))};L.last=function(O,N,M){if(O==null){return void 0}if((N!=null)&&!M){return o.call(O,Math.max(O.length-N,0))}else{return O[O.length-1]}};L.rest=L.tail=L.drop=function(O,N,M){return o.call(O,(N==null)||M?1:N)};L.compact=function(M){return L.filter(M,L.identity)};var x=function(N,O,M){H(N,function(P){if(L.isArray(P)){O?G.apply(M,P):x(P,O,M)}else{M.push(P)}});return M};L.flatten=function(N,M){return x(N,M,[])};L.without=function(M){return L.difference(M,o.call(arguments,1))};L.uniq=L.unique=function(S,R,Q,P){if(L.isFunction(R)){P=Q;Q=R;R=false}var N=Q?L.map(S,Q,P):S;var O=[];var M=[];H(N,function(U,T){if(R?(!T||M[M.length-1]!==U):!L.contains(M,U)){M.push(U);O.push(S[T])}});return O};L.union=function(){return L.uniq(y.apply(C,arguments))};L.intersection=function(N){var M=o.call(arguments,1);return L.filter(L.uniq(N),function(O){return L.every(M,function(P){return L.indexOf(P,O)>=0})})};L.difference=function(N){var M=y.apply(C,o.call(arguments,1));return L.filter(N,function(O){return !L.contains(M,O)})};L.zip=function(){var M=o.call(arguments);var P=L.max(L.pluck(M,"length"));var O=new Array(P);for(var N=0;N<P;N++){O[N]=L.pluck(M,""+N)}return O};L.object=function(Q,O){if(Q==null){return{}}var M={};for(var P=0,N=Q.length;P<N;P++){if(O){M[Q[P]]=O[P]}else{M[Q[P][0]]=Q[P][1]}}return M};L.indexOf=function(Q,O,P){if(Q==null){return -1}var N=0,M=Q.length;if(P){if(typeof P=="number"){N=(P<0?Math.max(0,M+P):P)}else{N=L.sortedIndex(Q,O);return Q[N]===O?N:-1}}if(n&&Q.indexOf===n){return Q.indexOf(O,P)}for(;N<M;N++){if(Q[N]===O){return N}}return -1};L.lastIndexOf=function(Q,O,P){if(Q==null){return -1}var M=P!=null;if(l&&Q.lastIndexOf===l){return M?Q.lastIndexOf(O,P):Q.lastIndexOf(O)}var N=(M?P:Q.length);while(N--){if(Q[N]===O){return N}}return -1};L.range=function(R,P,Q){if(arguments.length<=1){P=R||0;R=0}Q=arguments[2]||1;var N=Math.max(Math.ceil((P-R)/Q),0);var M=0;var O=new Array(N);while(M<N){O[M++]=R;R+=Q}return O};L.bind=function(O,N){if(O.bind===F&&F){return F.apply(O,o.call(arguments,1))}var M=o.call(arguments,2);return function(){return O.apply(N,M.concat(o.call(arguments)))}};L.partial=function(N){var M=o.call(arguments,1);return function(){return N.apply(this,M.concat(o.call(arguments)))}};L.bindAll=function(N){var M=o.call(arguments,1);if(M.length===0){M=L.functions(N)}H(M,function(O){N[O]=L.bind(N[O],N)});return N};L.memoize=function(O,N){var M={};N||(N=L.identity);return function(){var P=N.apply(this,arguments);return L.has(M,P)?M[P]:(M[P]=O.apply(this,arguments))}};L.delay=function(N,O){var M=o.call(arguments,2);return setTimeout(function(){return N.apply(null,M)},O)};L.defer=function(M){return L.delay.apply(L,[M,1].concat(o.call(arguments,1)))};L.throttle=function(R,T){var P,O,S,M;var Q=0;var N=function(){Q=new Date;S=null;M=R.apply(P,O)};return function(){var U=new Date;var V=T-(U-Q);P=this;O=arguments;if(V<=0){clearTimeout(S);S=null;Q=U;M=R.apply(P,O)}else{if(!S){S=setTimeout(N,V)}}return M}};L.debounce=function(O,Q,N){var P,M;return function(){var U=this,T=arguments;var S=function(){P=null;if(!N){M=O.apply(U,T)}};var R=N&&!P;clearTimeout(P);P=setTimeout(S,Q);if(R){M=O.apply(U,T)}return M}};L.once=function(O){var M=false,N;return function(){if(M){return N}M=true;N=O.apply(this,arguments);O=null;return N}};L.wrap=function(M,N){return function(){var O=[M];G.apply(O,arguments);return N.apply(this,O)}};L.compose=function(){var M=arguments;return function(){var N=arguments;for(var O=M.length-1;O>=0;O--){N=[M[O].apply(this,N)]}return N[0]}};L.after=function(N,M){if(N<=0){return M()}return function(){if(--N<1){return M.apply(this,arguments)}}};L.keys=e||function(O){if(O!==Object(O)){throw new TypeError("Invalid object")}var N=[];for(var M in O){if(L.has(O,M)){N[N.length]=M}}return N};L.values=function(O){var M=[];for(var N in O){if(L.has(O,N)){M.push(O[N])}}return M};L.pairs=function(O){var N=[];for(var M in O){if(L.has(O,M)){N.push([M,O[M]])}}return N};L.invert=function(O){var M={};for(var N in O){if(L.has(O,N)){M[O[N]]=N}}return M};L.functions=L.methods=function(O){var N=[];for(var M in O){if(L.isFunction(O[M])){N.push(M)}}return N.sort()};L.extend=function(M){H(o.call(arguments,1),function(N){if(N){for(var O in N){M[O]=N[O]}}});return M};L.pick=function(N){var O={};var M=y.apply(C,o.call(arguments,1));H(M,function(P){if(P in N){O[P]=N[P]}});return O};L.omit=function(O){var P={};var N=y.apply(C,o.call(arguments,1));for(var M in O){if(!L.contains(N,M)){P[M]=O[M]}}return P};L.defaults=function(M){H(o.call(arguments,1),function(N){if(N){for(var O in N){if(M[O]==null){M[O]=N[O]}}}});return M};L.clone=function(M){if(!L.isObject(M)){return M}return L.isArray(M)?M.slice():L.extend({},M)};L.tap=function(N,M){M(N);return N};var I=function(T,S,N,O){if(T===S){return T!==0||1/T==1/S}if(T==null||S==null){return T===S}if(T instanceof L){T=T._wrapped}if(S instanceof L){S=S._wrapped}var Q=d.call(T);if(Q!=d.call(S)){return false}switch(Q){case"[object String]":return T==String(S);case"[object Number]":return T!=+T?S!=+S:(T==0?1/T==1/S:T==+S);case"[object Date]":case"[object Boolean]":return +T==+S;case"[object RegExp]":return T.source==S.source&&T.global==S.global&&T.multiline==S.multiline&&T.ignoreCase==S.ignoreCase}if(typeof T!="object"||typeof S!="object"){return false}var M=N.length;while(M--){if(N[M]==T){return O[M]==S}}N.push(T);O.push(S);var V=0,W=true;if(Q=="[object Array]"){V=T.length;W=V==S.length;if(W){while(V--){if(!(W=I(T[V],S[V],N,O))){break}}}}else{var R=T.constructor,P=S.constructor;if(R!==P&&!(L.isFunction(R)&&(R instanceof R)&&L.isFunction(P)&&(P instanceof P))){return false}for(var U in T){if(L.has(T,U)){V++;if(!(W=L.has(S,U)&&I(T[U],S[U],N,O))){break}}}if(W){for(U in S){if(L.has(S,U)&&!(V--)){break}}W=!V}}N.pop();O.pop();return W};L.isEqual=function(N,M){return I(N,M,[],[])};L.isEmpty=function(N){if(N==null){return true}if(L.isArray(N)||L.isString(N)){return N.length===0}for(var M in N){if(L.has(N,M)){return false}}return true};L.isElement=function(M){return !!(M&&M.nodeType===1)};L.isArray=u||function(M){return d.call(M)=="[object Array]"};L.isObject=function(M){return M===Object(M)};H(["Arguments","Function","String","Number","Date","RegExp"],function(M){L["is"+M]=function(N){return d.call(N)=="[object "+M+"]"}});if(!L.isArguments(arguments)){L.isArguments=function(M){return !!(M&&L.has(M,"callee"))}}if(typeof(/./)!=="function"){L.isFunction=function(M){return typeof M==="function"}}L.isFinite=function(M){return isFinite(M)&&!isNaN(parseFloat(M))};L.isNaN=function(M){return L.isNumber(M)&&M!=+M};L.isBoolean=function(M){return M===true||M===false||d.call(M)=="[object Boolean]"};L.isNull=function(M){return M===null};L.isUndefined=function(M){return M===void 0};L.has=function(N,M){return j.call(N,M)};L.noConflict=function(){w._=k;return this};L.identity=function(M){return M};L.times=function(Q,P,O){var M=Array(Q);for(var N=0;N<Q;N++){M[N]=P.call(O,N)}return M};L.random=function(N,M){if(M==null){M=N;N=0}return N+Math.floor(Math.random()*(M-N+1))};var m={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};m.unescape=L.invert(m.escape);var J={escape:new RegExp("["+L.keys(m.escape).join("")+"]","g"),unescape:new RegExp("("+L.keys(m.unescape).join("|")+")","g")};L.each(["escape","unescape"],function(M){L[M]=function(N){if(N==null){return""}return(""+N).replace(J[M],function(O){return m[M][O]})}});L.result=function(M,O){if(M==null){return null}var N=M[O];return L.isFunction(N)?N.call(M):N};L.mixin=function(M){H(L.functions(M),function(N){var O=L[N]=M[N];L.prototype[N]=function(){var P=[this._wrapped];G.apply(P,arguments);return s.call(this,O.apply(L,P))}})};var z=0;L.uniqueId=function(M){var N=++z+"";return M?M+N:N};L.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var v=/(.)^/;var h={"'":"'","\\":"\\","\r":"r","\n":"n","\t":"t","\u2028":"u2028","\u2029":"u2029"};var i=/\\|'|\r|\n|\t|\u2028|\u2029/g;L.template=function(U,P,O){var N;O=L.defaults({},O,L.templateSettings);var Q=new RegExp([(O.escape||v).source,(O.interpolate||v).source,(O.evaluate||v).source].join("|")+"|$","g");var R=0;var M="__p+='";U.replace(Q,function(W,X,V,Z,Y){M+=U.slice(R,Y).replace(i,function(aa){return"\\"+h[aa]});if(X){M+="'+\n((__t=("+X+"))==null?'':_.escape(__t))+\n'"}if(V){M+="'+\n((__t=("+V+"))==null?'':__t)+\n'"}if(Z){M+="';\n"+Z+"\n__p+='"}R=Y+W.length;return W});M+="';\n";if(!O.variable){M="with(obj||{}){\n"+M+"}\n"}M="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+M+"return __p;\n";try{N=new Function(O.variable||"obj","_",M)}catch(S){S.source=M;throw S}if(P){return N(P,L)}var T=function(V){return N.call(this,V,L)};T.source="function("+(O.variable||"obj")+"){\n"+M+"}";return T};L.chain=function(M){return L(M).chain()};var s=function(M){return this._chain?L(M).chain():M};L.mixin(L);H(["pop","push","reverse","shift","sort","splice","unshift"],function(M){var N=C[M];L.prototype[M]=function(){var O=this._wrapped;N.apply(O,arguments);if((M=="shift"||M=="splice")&&O.length===0){delete O[0]}return s.call(this,O)}});H(["concat","join","slice"],function(M){var N=C[M];L.prototype[M]=function(){return s.call(this,N.apply(this._wrapped,arguments))}});L.extend(L.prototype,{chain:function(){this._chain=true;return this},value:function(){return this._wrapped}})}).call(this);(function(){var u=this;var B=u.Backbone;var g=[];var D=g.push;var n=g.slice;var t=g.splice;var z;if(typeof exports!=="undefined"){z=exports}else{z=u.Backbone={}}z.VERSION="1.0.0";var L=u._;if(!L&&(typeof require!=="undefined")){L=require("underscore")}z.$=u.jQuery||u.Zepto||u.ender||u.$;z.noConflict=function(){u.Backbone=B;return this};z.emulateHTTP=false;z.emulateJSON=false;var J=z.Events={on:function(M,P,O){if(!x(this,"on",M,[P,O])||!P){return this}this._events||(this._events={});var N=this._events[M]||(this._events[M]=[]);N.push({callback:P,context:O,ctx:O||this});return this},once:function(N,Q,O){if(!x(this,"once",N,[Q,O])||!Q){return this}var M=this;var P=L.once(function(){M.off(N,P);Q.apply(this,arguments)});P._callback=Q;return this.on(N,P,O)},off:function(M,V,N){var T,U,W,S,R,O,Q,P;if(!this._events||!x(this,"off",M,[V,N])){return this}if(!M&&!V&&!N){this._events={};return this}S=M?[M]:L.keys(this._events);for(R=0,O=S.length;R<O;R++){M=S[R];if(W=this._events[M]){this._events[M]=T=[];if(V||N){for(Q=0,P=W.length;Q<P;Q++){U=W[Q];if((V&&V!==U.callback&&V!==U.callback._callback)||(N&&N!==U.context)){T.push(U)}}}if(!T.length){delete this._events[M]}}}return this},trigger:function(O){if(!this._events){return this}var N=n.call(arguments,1);if(!x(this,"trigger",O,N)){return this}var P=this._events[O];var M=this._events.all;if(P){b(P,N)}if(M){b(M,arguments)}return this},stopListening:function(P,M,R){var N=this._listeners;if(!N){return this}var O=!M&&!R;if(typeof M==="object"){R=this}if(P){(N={})[P._listenerId]=P}for(var Q in N){N[Q].off(M,R,this);if(O){delete this._listeners[Q]}}return this}};var w=/\s+/;var x=function(T,R,N,Q){if(!N){return true}if(typeof N==="object"){for(var P in N){T[R].apply(T,[P,N[P]].concat(Q))}return false}if(w.test(N)){var S=N.split(w);for(var O=0,M=S.length;O<M;O++){T[R].apply(T,[S[O]].concat(Q))}return false}return true};var b=function(R,P){var S,Q=-1,O=R.length,N=P[0],M=P[1],T=P[2];switch(P.length){case 0:while(++Q<O){(S=R[Q]).callback.call(S.ctx)}return;case 1:while(++Q<O){(S=R[Q]).callback.call(S.ctx,N)}return;case 2:while(++Q<O){(S=R[Q]).callback.call(S.ctx,N,M)}return;case 3:while(++Q<O){(S=R[Q]).callback.call(S.ctx,N,M,T)}return;default:while(++Q<O){(S=R[Q]).callback.apply(S.ctx,P)}}};var C={listenTo:"on",listenToOnce:"once"};L.each(C,function(M,N){J[N]=function(Q,O,S){var P=this._listeners||(this._listeners={});var R=Q._listenerId||(Q._listenerId=L.uniqueId("l"));P[R]=Q;if(typeof O==="object"){S=this}Q[M](O,S,this);return this}});J.bind=J.on;J.unbind=J.off;L.extend(z,J);var E=z.Model=function(M,O){var P;var N=M||{};O||(O={});this.cid=L.uniqueId("c");this.attributes={};L.extend(this,L.pick(O,F));if(O.parse){N=this.parse(N,O)||{}}if(P=L.result(this,"defaults")){N=L.defaults({},N,P)}this.set(N,O);this.changed={};this.initialize.apply(this,arguments)};var F=["url","urlRoot","collection"];L.extend(E.prototype,J,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(M){return L.clone(this.attributes)},sync:function(){return z.sync.apply(this,arguments)},get:function(M){return this.attributes[M]},escape:function(M){return L.escape(this.get(M))},has:function(M){return this.get(M)!=null},set:function(U,M,Y){var S,V,W,T,R,X,O,Q;if(U==null){return this}if(typeof U==="object"){V=U;Y=M}else{(V={})[U]=M}Y||(Y={});if(!this._validate(V,Y)){return false}W=Y.unset;R=Y.silent;T=[];X=this._changing;this._changing=true;if(!X){this._previousAttributes=L.clone(this.attributes);this.changed={}}Q=this.attributes,O=this._previousAttributes;if(this.idAttribute in V){this.id=V[this.idAttribute]}for(S in V){M=V[S];if(!L.isEqual(Q[S],M)){T.push(S)}if(!L.isEqual(O[S],M)){this.changed[S]=M}else{delete this.changed[S]}W?delete Q[S]:Q[S]=M}if(!R){if(T.length){this._pending=true}for(var P=0,N=T.length;P<N;P++){this.trigger("change:"+T[P],this,Q[T[P]],Y)}}if(X){return this}if(!R){while(this._pending){this._pending=false;this.trigger("change",this,Y)}}this._pending=false;this._changing=false;return this},unset:function(M,N){return this.set(M,void 0,L.extend({},N,{unset:true}))},clear:function(N){var M={};for(var O in this.attributes){M[O]=void 0}return this.set(M,L.extend({},N,{unset:true}))},hasChanged:function(M){if(M==null){return !L.isEmpty(this.changed)}return L.has(this.changed,M)},changedAttributes:function(O){if(!O){return this.hasChanged()?L.clone(this.changed):false}var Q,P=false;var N=this._changing?this._previousAttributes:this.attributes;for(var M in O){if(L.isEqual(N[M],(Q=O[M]))){continue}(P||(P={}))[M]=Q}return P},previous:function(M){if(M==null||!this._previousAttributes){return null}return this._previousAttributes[M]},previousAttributes:function(){return L.clone(this._previousAttributes)},fetch:function(N){N=N?L.clone(N):{};if(N.parse===void 0){N.parse=true}var M=this;var O=N.success;N.success=function(P){if(!M.set(M.parse(P,N),N)){return false}if(O){O(M,P,N)}M.trigger("sync",M,P,N)};H(this,N);return this.sync("read",this,N)},save:function(Q,N,U){var R,M,T,O=this.attributes;if(Q==null||typeof Q==="object"){R=Q;U=N}else{(R={})[Q]=N}if(R&&(!U||!U.wait)&&!this.set(R,U)){return false}U=L.extend({validate:true},U);if(!this._validate(R,U)){return false}if(R&&U.wait){this.attributes=L.extend({},O,R)}if(U.parse===void 0){U.parse=true}var P=this;var S=U.success;U.success=function(W){P.attributes=O;var V=P.parse(W,U);if(U.wait){V=L.extend(R||{},V)}if(L.isObject(V)&&!P.set(V,U)){return false}if(S){S(P,W,U)}P.trigger("sync",P,W,U)};H(this,U);M=this.isNew()?"create":(U.patch?"patch":"update");if(M==="patch"){U.attrs=R}T=this.sync(M,this,U);if(R&&U.wait){this.attributes=O}return T},destroy:function(N){N=N?L.clone(N):{};var M=this;var Q=N.success;var O=function(){M.trigger("destroy",M,M.collection,N)};N.success=function(R){if(N.wait||M.isNew()){O()}if(Q){Q(M,R,N)}if(!M.isNew()){M.trigger("sync",M,R,N)}};if(this.isNew()){N.success();return false}H(this,N);var P=this.sync("delete",this,N);if(!N.wait){O()}return P},url:function(){var M=L.result(this,"urlRoot")||L.result(this.collection,"url")||r();if(this.isNew()){return M}return M+(M.charAt(M.length-1)==="/"?"":"/")+encodeURIComponent(this.id)},parse:function(N,M){return N},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},isValid:function(M){return this._validate({},L.extend(M||{},{validate:true}))},_validate:function(O,N){if(!N.validate||!this.validate){return true}O=L.extend({},this.attributes,O);var M=this.validationError=this.validate(O,N)||null;if(!M){return true}this.trigger("invalid",this,M,L.extend(N||{},{validationError:M}));return false}});var a=["keys","values","pairs","invert","pick","omit"];L.each(a,function(M){E.prototype[M]=function(){var N=n.call(arguments);N.unshift(this.attributes);return L[M].apply(L,N)}});var c=z.Collection=function(N,M){M||(M={});if(M.url){this.url=M.url}if(M.model){this.model=M.model}if(M.comparator!==void 0){this.comparator=M.comparator}this._reset();this.initialize.apply(this,arguments);if(N){this.reset(N,L.extend({silent:true},M))}};var o={add:true,remove:true,merge:true};var K={add:true,merge:false,remove:false};L.extend(c.prototype,J,{model:E,initialize:function(){},toJSON:function(M){return this.map(function(N){return N.toJSON(M)})},sync:function(){return z.sync.apply(this,arguments)},add:function(N,M){return this.set(N,L.defaults(M||{},K))},remove:function(R,P){R=L.isArray(R)?R.slice():[R];P||(P={});var Q,M,O,N;for(Q=0,M=R.length;Q<M;Q++){N=this.get(R[Q]);if(!N){continue}delete this._byId[N.id];delete this._byId[N.cid];O=this.indexOf(N);this.models.splice(O,1);this.length--;if(!P.silent){P.index=O;N.trigger("remove",N,this,P)}this._removeReference(N)}return this},set:function(N,Z){Z=L.defaults(Z||{},o);if(Z.parse){N=this.parse(N,Z)}if(!L.isArray(N)){N=N?[N]:[]}var U,Q,W,X,O,V;var P=Z.at;var T=this.comparator&&(P==null)&&Z.sort!==false;var R=L.isString(this.comparator)?this.comparator:null;var Y=[],M=[],S={};for(U=0,Q=N.length;U<Q;U++){if(!(W=this._prepareModel(N[U],Z))){continue}if(O=this.get(W)){if(Z.remove){S[O.cid]=true}if(Z.merge){O.set(W.attributes,Z);if(T&&!V&&O.hasChanged(R)){V=true}}}else{if(Z.add){Y.push(W);W.on("all",this._onModelEvent,this);this._byId[W.cid]=W;if(W.id!=null){this._byId[W.id]=W}}}}if(Z.remove){for(U=0,Q=this.length;U<Q;++U){if(!S[(W=this.models[U]).cid]){M.push(W)}}if(M.length){this.remove(M,Z)}}if(Y.length){if(T){V=true}this.length+=Y.length;if(P!=null){t.apply(this.models,[P,0].concat(Y))}else{D.apply(this.models,Y)}}if(V){this.sort({silent:true})}if(Z.silent){return this}for(U=0,Q=Y.length;U<Q;U++){(W=Y[U]).trigger("add",W,this,Z)}if(V){this.trigger("sort",this,Z)}return this},reset:function(P,N){N||(N={});for(var O=0,M=this.models.length;O<M;O++){this._removeReference(this.models[O])}N.previousModels=this.models;this._reset();this.add(P,L.extend({silent:true},N));if(!N.silent){this.trigger("reset",this,N)}return this},push:function(N,M){N=this._prepareModel(N,M);this.add(N,L.extend({at:this.length},M));return N},pop:function(N){var M=this.at(this.length-1);this.remove(M,N);return M},unshift:function(N,M){N=this._prepareModel(N,M);this.add(N,L.extend({at:0},M));return N},shift:function(N){var M=this.at(0);this.remove(M,N);return M},slice:function(N,M){return this.models.slice(N,M)},get:function(M){if(M==null){return void 0}return this._byId[M.id!=null?M.id:M.cid||M]},at:function(M){return this.models[M]},where:function(M,N){if(L.isEmpty(M)){return N?void 0:[]}return this[N?"find":"filter"](function(O){for(var P in M){if(M[P]!==O.get(P)){return false}}return true})},findWhere:function(M){return this.where(M,true)},sort:function(M){if(!this.comparator){throw new Error("Cannot sort a set without a comparator")}M||(M={});if(L.isString(this.comparator)||this.comparator.length===1){this.models=this.sortBy(this.comparator,this)}else{this.models.sort(L.bind(this.comparator,this))}if(!M.silent){this.trigger("sort",this,M)}return this},sortedIndex:function(M,P,N){P||(P=this.comparator);var O=L.isFunction(P)?P:function(Q){return Q.get(P)};return L.sortedIndex(this.models,M,O,N)},pluck:function(M){return L.invoke(this.models,"get",M)},fetch:function(M){M=M?L.clone(M):{};if(M.parse===void 0){M.parse=true}var O=M.success;var N=this;M.success=function(P){var Q=M.reset?"reset":"set";N[Q](P,M);if(O){O(N,P,M)}N.trigger("sync",N,P,M)};H(this,M);return this.sync("read",this,M)},create:function(N,M){M=M?L.clone(M):{};if(!(N=this._prepareModel(N,M))){return false}if(!M.wait){this.add(N,M)}var P=this;var O=M.success;M.success=function(Q){if(M.wait){P.add(N,M)}if(O){O(N,Q,M)}};N.save(null,M);return N},parse:function(N,M){return N},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0;this.models=[];this._byId={}},_prepareModel:function(O,N){if(O instanceof E){if(!O.collection){O.collection=this}return O}N||(N={});N.collection=this;var M=new this.model(O,N);if(!M._validate(O,N)){this.trigger("invalid",this,O,N);return false}return M},_removeReference:function(M){if(this===M.collection){delete M.collection}M.off("all",this._onModelEvent,this)},_onModelEvent:function(O,N,P,M){if((O==="add"||O==="remove")&&P!==this){return}if(O==="destroy"){this.remove(N,M)}if(N&&O==="change:"+N.idAttribute){delete this._byId[N.previous(N.idAttribute)];if(N.id!=null){this._byId[N.id]=N}}this.trigger.apply(this,arguments)}});var y=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"];L.each(y,function(M){c.prototype[M]=function(){var N=n.call(arguments);N.unshift(this.models);return L[M].apply(L,N)}});var k=["groupBy","countBy","sortBy"];L.each(k,function(M){c.prototype[M]=function(P,N){var O=L.isFunction(P)?P:function(Q){return Q.get(P)};return L[M](this.models,O,N)}});var G=z.View=function(M){this.cid=L.uniqueId("view");this._configure(M||{});this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents()};var v=/^(\S+)\s*(.*)$/;var e=["model","collection","el","id","attributes","className","tagName","events"];L.extend(G.prototype,J,{tagName:"div",$:function(M){return this.$el.find(M)},initialize:function(){},render:function(){return this},remove:function(){this.$el.remove();this.stopListening();return this},setElement:function(M,N){if(this.$el){this.undelegateEvents()}this.$el=M instanceof z.$?M:z.$(M);this.el=this.$el[0];if(N!==false){this.delegateEvents()}return this},delegateEvents:function(Q){if(!(Q||(Q=L.result(this,"events")))){return this}this.undelegateEvents();for(var P in Q){var R=Q[P];if(!L.isFunction(R)){R=this[Q[P]]}if(!R){continue}var O=P.match(v);var N=O[1],M=O[2];R=L.bind(R,this);N+=".delegateEvents"+this.cid;if(M===""){this.$el.on(N,R)}else{this.$el.on(N,M,R)}}return this},undelegateEvents:function(){this.$el.off(".delegateEvents"+this.cid);return this},_configure:function(M){if(this.options){M=L.extend({},L.result(this,"options"),M)}L.extend(this,L.pick(M,e));this.options=M},_ensureElement:function(){if(!this.el){var M=L.extend({},L.result(this,"attributes"));if(this.id){M.id=L.result(this,"id")}if(this.className){M["class"]=L.result(this,"className")}var N=z.$("<"+L.result(this,"tagName")+">").attr(M);this.setElement(N,false)}else{this.setElement(L.result(this,"el"),false)}}});z.sync=function(S,N,M){var P=j[S];L.defaults(M||(M={}),{emulateHTTP:z.emulateHTTP,emulateJSON:z.emulateJSON});var R={type:P,dataType:"json"};if(!M.url){R.url=L.result(N,"url")||r()}if(M.data==null&&N&&(S==="create"||S==="update"||S==="patch")){R.contentType="application/json";R.data=JSON.stringify(M.attrs||N.toJSON(M))}if(M.emulateJSON){R.contentType="application/x-www-form-urlencoded";R.data=R.data?{model:R.data}:{}}if(M.emulateHTTP&&(P==="PUT"||P==="DELETE"||P==="PATCH")){R.type="POST";if(M.emulateJSON){R.data._method=P}var O=M.beforeSend;M.beforeSend=function(T){T.setRequestHeader("X-HTTP-Method-Override",P);if(O){return O.apply(this,arguments)}}}if(R.type!=="GET"&&!M.emulateJSON){R.processData=false}if(R.type==="PATCH"&&window.ActiveXObject&&!(window.external&&window.external.msActiveXFilteringEnabled)){R.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")}}var Q=M.xhr=z.ajax(L.extend(R,M));N.trigger("request",N,Q,M);return Q};var j={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};z.ajax=function(){return z.$.ajax.apply(z.$,arguments)};var p=z.Router=function(M){M||(M={});if(M.routes){this.routes=M.routes}this._bindRoutes();this.initialize.apply(this,arguments)};var q=/\((.*?)\)/g;var s=/(\(\?)?:\w+/g;var d=/\*\w+/g;var h=/[\-{}\[\]+?.,\\\^$|#\s]/g;L.extend(p.prototype,J,{initialize:function(){},route:function(N,O,P){if(!L.isRegExp(N)){N=this._routeToRegExp(N)}if(L.isFunction(O)){P=O;O=""}if(!P){P=this[O]}var M=this;z.history.route(N,function(R){var Q=M._extractParameters(N,R);P&&P.apply(M,Q);M.trigger.apply(M,["route:"+O].concat(Q));M.trigger("route",O,Q);z.history.trigger("route",M,O,Q)});return this},navigate:function(N,M){z.history.navigate(N,M);return this},_bindRoutes:function(){if(!this.routes){return}this.routes=L.result(this,"routes");var N,M=L.keys(this.routes);while((N=M.pop())!=null){this.route(N,this.routes[N])}},_routeToRegExp:function(M){M=M.replace(h,"\\$&").replace(q,"(?:$1)?").replace(s,function(O,N){return N?O:"([^/]+)"}).replace(d,"(.*?)");return new RegExp("^"+M+"$")},_extractParameters:function(M,N){var O=M.exec(N).slice(1);return L.map(O,function(P){return P?decodeURIComponent(P):null})}});var i=z.History=function(){this.handlers=[];L.bindAll(this,"checkUrl");if(typeof window!=="undefined"){this.location=window.location;this.history=window.history}};var A=/^[#\/]|\s+$/g;var f=/^\/+|\/+$/g;var I=/msie [\w.]+/;var m=/\/$/;i.started=false;L.extend(i.prototype,J,{interval:50,getHash:function(N){var M=(N||this).location.href.match(/#(.*)$/);return M?M[1]:""},getFragment:function(O,N){if(O==null){if(this._hasPushState||!this._wantsHashChange||N){O=this.location.pathname;var M=this.root.replace(m,"");if(!O.indexOf(M)){O=O.substr(M.length)}}else{O=this.getHash()}}return O.replace(A,"")},start:function(O){if(i.started){throw new Error("Backbone.history has already been started")}i.started=true;this.options=L.extend({},{root:"/"},this.options,O);this.root=this.options.root;this._wantsHashChange=this.options.hashChange!==false;this._wantsPushState=!!this.options.pushState;this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var N=this.getFragment();var M=document.documentMode;var Q=(I.exec(navigator.userAgent.toLowerCase())&&(!M||M<=7));this.root=("/"+this.root+"/").replace(f,"/");if(Q&&this._wantsHashChange){this.iframe=z.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow;this.navigate(N)}if(this._hasPushState){z.$(window).on("popstate",this.checkUrl)}else{if(this._wantsHashChange&&("onhashchange" in window)&&!Q){z.$(window).on("hashchange",this.checkUrl)}else{if(this._wantsHashChange){this._checkUrlInterval=setInterval(this.checkUrl,this.interval)}}}this.fragment=N;var R=this.location;var P=R.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!P){this.fragment=this.getFragment(null,true);this.location.replace(this.root+this.location.search+"#"+this.fragment);return true}else{if(this._wantsPushState&&this._hasPushState&&P&&R.hash){this.fragment=this.getHash().replace(A,"");this.history.replaceState({},document.title,this.root+this.fragment+R.search)}}if(!this.options.silent){return this.loadUrl()}},stop:function(){z.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl);clearInterval(this._checkUrlInterval);i.started=false},route:function(M,N){this.handlers.unshift({route:M,callback:N})},checkUrl:function(N){var M=this.getFragment();if(M===this.fragment&&this.iframe){M=this.getFragment(this.getHash(this.iframe))}if(M===this.fragment){return false}if(this.iframe){this.navigate(M)}this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(O){var N=this.fragment=this.getFragment(O);var M=L.any(this.handlers,function(P){if(P.route.test(N)){P.callback(N);return true}});return M},navigate:function(O,N){if(!i.started){return false}if(!N||N===true){N={trigger:N}}O=this.getFragment(O||"");if(this.fragment===O){return}this.fragment=O;var M=this.root+O;if(this._hasPushState){this.history[N.replace?"replaceState":"pushState"]({},document.title,M)}else{if(this._wantsHashChange){this._updateHash(this.location,O,N.replace);if(this.iframe&&(O!==this.getFragment(this.getHash(this.iframe)))){if(!N.replace){this.iframe.document.open().close()}this._updateHash(this.iframe.location,O,N.replace)}}else{return this.location.assign(M)}}if(N.trigger){this.loadUrl(O)}},_updateHash:function(M,O,P){if(P){var N=M.href.replace(/(javascript:|#).*$/,"");M.replace(N+"#"+O)}else{M.hash="#"+O}}});z.history=new i;var l=function(M,O){var N=this;var Q;if(M&&L.has(M,"constructor")){Q=M.constructor}else{Q=function(){return N.apply(this,arguments)}}L.extend(Q,N,O);var P=function(){this.constructor=Q};P.prototype=N.prototype;Q.prototype=new P;if(M){L.extend(Q.prototype,M)}Q.__super__=N.prototype;return Q};E.extend=c.extend=p.extend=G.extend=i.extend=l;var r=function(){throw new Error('A "url" property or function must be specified')};var H=function(O,N){var M=N.error;N.error=function(P){if(M){M(O,P,N)}O.trigger("error",O,P,N)}}}).call(this);Backbone.$=$svjq;(function(){var e=Backbone.Model.prototype.fetch,c=Backbone.Model.prototype.save,a=Backbone.Model.prototype.destroy,b=Backbone.Collection.prototype.fetch;function d(i,f,h){var g=window.sv.ErrorUtil;if(g){g.handleBackboneError(i,f,h)}}Backbone.Model.prototype.fetch=function(f){f=f||{};f.error=f.error||d;return e.apply(this,[f])};Backbone.Model.prototype.save=function(g,h,f){if(g==null||typeof g==="object"){h=h||{};h.error=h.error||d}else{f=f||{};f.error=f.error||d}return c.apply(this,[g,h,f])};Backbone.Model.prototype.destroy=function(f){f=f||{};f.error=f.error||d;return a.apply(this,[f])};Backbone.Collection.prototype.fetch=function(f){f=f||{};f.error=f.error||d;return b.apply(this,[f])}}());(function(){var l=1,p=window.sv,n=p.ObjectUtil,f=p.Log,h=window.$svjq,o=window._;var i=function(q){var r=new RegExp("[\\?&]"+q+"=([^&#]*)").exec(window.location.href);if(!r){return null}return r[1]};var d=function(q,r){return"/modelobjectapi/"+l+"/"+p.PageContext.pageId+"/"+q+"/"+r};var c=function(q,r){return"/restapi/v"+l+"/"+p.PageContext.pageId+"/"+q+"/"+r};var g=function(r,q){return"/"+p.PageContext.pageId+"/"+r+".xml?state="+q};var k=function(t,r){var s=i("identity");var u=i("group");var q=i("tag");return"/"+p.PageContext.pageId+"/"+t+".portletresource?state="+r+(s?"&identity="+s:"")+(u?"&group="+u:"")+(q?"&tag="+q:"")};var m=function(r,s){var q=h(r);h.each(q,function(){var v=h(this);var t=v.attr("id");var u=n.getObjectId(t);b(v,"/"+p.PageContext.pageId+"/"+u+".xml"+(s||""))})};var b=function(r,s,t){var q;if(h.type(r)==="string"){q=h(r)}else{q=r}h.get(s,function(u){q.fadeOut("fast",function(){q.html(u);q.fadeIn();h.isFunction(t)&&t.call(this)})})};var j=function(q,r){h.get(r,function(s){h(q).html(s)})};var a={};var e=function(t,q){var s=t.attr("id"),r;if(!s){f.warn("portletUtil","Tried to get template from invalid element");return}s=s.replace(".","_");if(!a[s+q]){r=t.find("script.sv-tmpl-"+q);if(r.length===0){f.warn("portletUtil","Could not find template with name "+q+" for portlet "+s);return}a[s+q]=o.template(r.html())}return a[s+q]};p.PortletUtil={getModelObjectUri:d,getPortletUri:g,getPortletResourceUri:k,getUtilityApiUri:c,reloadPortletsByType:m,doGetWithFade:b,doGet:j,getTemplate:e}}());(function(){var f=window.$svjq,p=window.sv,l=p.KeyUtil,h=p.DialogUtil,k=p.PortletUtil,a=p.DateUtil,c=p.Events,s=window.moment,d=window.Backbone,i=f("html").hasClass("sv-touch"),j=function(u,t){return p.i18n.getText("common",u,t)},n;var o=d.View.extend({template:function(){return k.getTemplate(this.options.$portlet,this.templateName)},memberTemplate:function(){return k.getTemplate(this.options.$portlet,this.memberTemplateName)},participantTemplate:function(){return k.getTemplate(this.options.$portlet,this.participantTemplateName)},events:{"click [data-fn-allday]":"toggleTimeVisibility",'keyup [name="where"]':"showMapLink"},initialize:function(t){this.options=t;this.originalValues={};var u=this.template(),v=f.extend(this.model.toJSON(),this.templateHelpers);this.$el.append(u(v));this.listenTo(this.model,"invalid",this.handleErrors);this.ui={startDate:this.$el.find("[name=startDate]"),startTime:this.$el.find("[data-fn-time-value-start]"),endDate:this.$el.find("[name=endDate]"),endTime:this.$el.find("[data-fn-time-value-end]"),allDay:this.$el.find("[name=allDay]"),isDone:this.$el.find("[name=isDone]"),owner:this.$el.find("#owner"),participants:this.$el.find("#participants")}},render:function(){var y=this,x=[{text:j("cancel"),callback:function(){f(".modal").modal("hide").remove();y.restoreChanges()}}];if(this.model.isNew()){x.push({text:this.i18n("create"),skipDismiss:true,primary:true,callback:function(){y.saveChanges()}})}else{x.push({text:j("remove"),danger:true,callback:f.proxy(this.removeActivity,this)},{text:j("ok"),skipDismiss:true,primary:true,callback:function(){y.saveChanges()}})}h.showDialog({title:this.model.attributes.isTask?this.i18n("task"):this.i18n("event"),body:this.$el,buttons:x,removeOnHide:true,errorTitle:j("networkErrorTitle"),errorMsg:j("networkErrorText")});var w={format:s.langData()._longDateFormat.L.toLowerCase(),autoclose:true};this.ui.startDate.bootstrapDatepicker(w).on("change",f.proxy(function(){var A=this.ui.endDate.val(),z=this.ui.startDate.bootstrapDatepicker("getDate");if(!A&&z){this.ui.endDate.bootstrapDatepicker("setDate",z)}},this));this.ui.endDate.bootstrapDatepicker(w);var t=this.$el.parent().parent(),v={decimal:j("decimal"),mins:j("mins"),hr:j("hr"),hrs:j("hrs")},u=a.moment2PhpFormat(s.langData()._longDateFormat.LT);this.ui.startTime.timepicker({timeFormat:u,lang:v,appendTo:t,scrollDefaultNow:true}).on("timeFormatError",f.proxy(function(){var z=s();this.ui.startTime.val(z.format("LT"))},this)).on("change",f.proxy(function(){var z;if(!this.ui.endTime.val()&&this.ui.startTime.val()){z=s(this.ui.startTime.val(),"LT",true);z.add("hours",2);this.ui.endTime.val(z.format("LT"))}},this));this.ui.endTime.timepicker({timeFormat:u,lang:v,appendTo:t}).on("timeFormatError",f.proxy(function(){var B=this.ui.startTime.val();if(B){var A=s(B,"LT",true);A.add("hours",2);this.ui.endTime.val(A.format("LT"))}else{var z=s();this.ui.endTime.val(z.format("LT"))}},this));f.ajax({url:k.getPortletResourceUri(this.options.portletId,this.membersWithOwnerActionName)+((this.model.isNew())?"":"&id="+this.model.id)}).done(f.proxy(function(z){this.ui.owner.select2({allowClear:true,data:z,formatResult:this.memberTemplate(),escapeMarkup:function(A){return A}})},this));f.ajax({url:k.getPortletResourceUri(this.options.portletId,this.membersActionName)}).done(f.proxy(function(z){this.ui.participants.select2({multiple:true,data:z,formatResult:this.memberTemplate(),formatSelection:this.participantTemplate(),escapeMarkup:function(A){return A}})},this))},handleErrors:function(t,u){e(t,u,this.$el,this.i18n)},templateHelpers:{mapUrl:function(t){return r(t)},datePickerValue:function(u){var t=s(u);if(t.isValid()){return s(u).format("L")}return""},timePickerValue:function(u){var t=s(u);if(t.isValid()){return(s(u).format("LT")==="00:00"||s(u).format("LT")==="12:00 AM")?"":s(u).format("LT")}return""}},showMapLink:function(t){if(this.typingTimer){window.clearTimeout(this.typingTimer)}this.typingTimer=window.setTimeout(f.proxy(function(){var w=r(t.currentTarget.value);if(!this.$mapLink){this.$mapLink=this.$el.find("[data-fn-map-link]");if(!this.$mapLink.length){var v='<span class="help-block"><i class="halflings-icon icon-map-marker"></i> <a data-fn-map-link class="sv-map-link" target="_blank" href="'+w+'">'+this.i18n("map")+"</a></span>",u=f(v).insertAfter(t.currentTarget);this.$mapLink=u.find("[data-fn-map-link]")}}if(t.currentTarget.value){this.$mapLink.closest(".help-block").show()}else{this.$mapLink.closest(".help-block").hide()}this.$mapLink.attr("href",w)},this),1000)},toggleTimeVisibility:function(){this.ui.startTime.toggleClass("sv-hidden");this.ui.endTime.toggleClass("sv-hidden")},setAndSaveForRestore:function(t,u){if(!this.originalValues[t]){this.originalValues[t]=this.model.get(t)}this.model.set(t,u)},restoreChanges:function(){var t=this;f.each(this.originalValues,function(u,v){t.model.set(u,v)})},setAndSaveDateForRestore:function(t,v,w){if(v.length){var x=s(v,"L",true),u=s(w,"LT",true);x.hours(u.hours()).minutes(u.minutes());this.setAndSaveForRestore(t,x.valueOf())}else{this.setAndSaveForRestore(t,"")}},saveChanges:function(){var y=this;this.$el.find("[data-fn-standard-value]").each(function(){y.setAndSaveForRestore(this.name,f.trim(this.value))});var z=this.ui.allDay.prop("checked");this.setAndSaveForRestore("allDay",z);var t=f.trim(this.ui.startDate.val()),x=f.trim(this.ui.startTime.val());this.setAndSaveDateForRestore("start",t,x);var A=f.trim(this.ui.endDate.val()),w=f.trim(this.ui.endTime.val());this.setAndSaveDateForRestore("end",A,w);var v=this.ui.isDone.prop("checked");this.setAndSaveForRestore("isDone",v);var u=this.model.isNew();this.model.save(null,{wait:true,success:function(B){y.backingModel.set(B.attributes);f(".modal").modal("hide").remove();if(u){c.trigger(c.types.activityCreated,B.attributes)}else{c.trigger(c.types.activityUpdated,B.attributes)}},error:function(){f(".alert").show()}})}});var g=d.View.extend({template:function(){return k.getTemplate(this.options.$portlet,this.templateName)},events:{"click [data-fn-more]":"more","click [data-fn-remove]":"removeActivity","click [data-fn-edit]":"editActivity","mouseenter [data-participants]":"showParticipants","mouseleave [data-participants]":"hideParticipants"},initialize:function(t){this.options=t;var u=this.template(),v=f.extend(this.model.toJSON(),this.templateHelpers());n=this.options.i18n;this.$el.append(u(v));n=null;this.ui={description:this.$el.find("[data-fn-description]"),more:this.$el.find("[data-fn-more-remainder]"),participants:this.$el.find("[data-participants]")}},render:function(){var u=f("<div/>").text(this.model.get("title")).html(),t=m(this.options.$target);c.trigger(c.types.popoverCreated,this);this.options.$target.popover({html:true,title:'<button type="button" class="close">&times;</button>'+u,placement:t,content:this.el,trigger:"manual",container:this.options.popoverContainer}).popover("show");var v=this.$el.closest(".popover");if(this.options.jsEvent){var w=this.options.jsEvent.pageY;if(t==="top"){w-=v.height()+10}else{if(t==="left"||t==="right"){w-=v.height()/2}}v.css({top:w})}v.on("click",".close",f.proxy(this.closePopover,this)).on("clickoutside",f.proxy(this.closePopover,this));f(document).on("keydown",f.proxy(this.closePopoverOnEscape,this));f("[data-fn-request-focus]").focus();c.on(c.types.popoverCreated,f.proxy(this.closePopoverWhenOtherIsCreated,this));return this},templateHelpers:function(){var t={maxSizeText:function(x){var u=f("<div/>").text(x).html();var w=150;if(u.length<w){return u}var v="<span>"+u.substring(0,w)+'</span><span data-fn-more class="sv-more">&nbsp;...'+n("more")+" &raquo;</span>";v+='<span data-fn-more-remainder class="sv-hidden">'+u.substring(w)+"</span>";return v},mapUrl:function(u){return r(u)}};if(this.templateHelpers2){t=f.extend(t,this.templateHelpers2)}return t},showParticipants:function(){var t=this.model.get("participants");if(t&&t.length>0){if(this.participants){this.showParticipantsTooltip()}else{f.ajax({url:k.getPortletResourceUri(this.options.portletId,this.participantsActionName)+"&id="+this.model.id}).done(f.proxy(function(u){this.participants=u;this.showParticipantsTooltip()},this))}}},showParticipantsTooltip:function(){this.ui.participants.tooltip({html:true,title:this.participants.join("<br/>")});this.ui.participants.tooltip("show")},hideParticipants:function(){this.ui.participants.tooltip("destroy")},more:function(t){f(t.currentTarget).addClass("sv-hidden");this.ui.description.css("max-height",(this.ui.description.height()+20)+"px").addClass("sv-show-scroll");this.ui.more.removeClass("sv-hidden")},closePopover:function(){c.off(c.types.popoverCreated);f(document).off("keydown",this.closePopoverOnEscape);this.$el.closest(".popover").off("click",".close",this.closePopover).off("clickoutside",this.closePopover).remove();this.options.$target.popover("destroy")},editActivity:function(){this.model.fetch({success:f.proxy(function(t){this.createEditView(t).render();if(i){f(window).scrollTop(0)}},this)});this.closePopover();return false},closePopoverWhenOtherIsCreated:function(t){if(this!==t){this.closePopover()}},closePopoverOnEscape:function(t){if(t.keyCode===l.KEY.ESC){this.closePopover();return false}}});var q=d.Model.extend({defaults:{title:"",description:"",where:"",owner:"",participants:"",start:"",end:""},initialize:function(u,t){this.portletId=t.portletId},validate:function(u){var w=[];if(!u.title){w.push({field:"title",message:"noTitle"})}if(!u.owner){w.push({field:"owner",message:"noOwner"})}if(!this.allowEmptyStart&&!u.start){w.push({field:"start",message:"noStart"})}else{if(u.allDay||u.end){if(!u.start){w.push({field:"start",message:"noStart"})}}}if(u.start&&u.end){var t=s(u.start),v=s(u.end);if(!(u.allDay&&v.isSame(t))&&!v.isAfter(t)){w.push({field:"end",message:u.allDay?"invalidAllDayTimePeriod":"invalidTimePeriod"})}}if(!u.allDay&&u.start){if(!u.end){w.push({field:"end",message:"noEnd"})}}return w.length?w:undefined}});var e=function(v,z,x,y){var w=0,t=z.length,u;x.find(".control-group").removeClass("error").find(".help-block.error").remove();for(;w<t;w++){u=z[w];x.find('[name="'+u.field+'"]').closest(".control-group").addClass("error").find(".controls").append('<span class="help-block error">'+y(u.message)+"</span>")}};var m=function(t){if(i){return"bottom"}var w=t.offset().top-f(window).scrollTop(),u=window.innerHeight-w,y=t.offset().left-f(window).scrollLeft(),v=window.innerWidth-y,x=220;if(u>=x){return"bottom"}if(w>=x){return"top"}return(y>=v)?"left":"right"};var b=function(t,v){var u=""+s(t).year();return v.replace(new RegExp(u,"g"),"").replace(new RegExp("  ","g")," ")};var r=function(t){return"https://maps.google.se/maps?hl="+p.PageContext.userLocale+"&q="+t+"&source=calendar"};s.lang(p.PageContext.userLocale);p.ActivityUtil={showErrors:e,calculatePopoverPlacement:m,stripYear:b,ActivityModel:q,ActivityDetailView:g,ActivityEditView:o}}());(function(){var f=window.$svjq,k=window.sv,c=k.KeyUtil,g=c.KEY,m={},e,j=window._,n=function(o,p){var q;if(!p&&m[o]){return m[o]}q=k.i18n.getText("portlet.util.addgrouputil",o,p);if(!p){m[o]=q}return q},i=function(o){return k.i18n.getText("common",o)},d={success:function(){},selected:function(){},placeholder:"",groupTemplates:[],groupFolder:null,hitTemplate:j.template('<li data-group-id="<%= id %>" class="sv-clearfix <% if (isMember) { %> sv-group-member<% } %>">   <img class="sv-group-img sv-buddy-icon" src="<%= iconURL %>" />   <% if (isMember) { %><div style="float:right"><i class="halflings-icon ok"></i></div><% } %>   <div class="sv-group-info-container">     <h3 class="sv-group-name"><%- name %></h3>     <p>        <%= memberCount %> medlemmar     </p>   </div></li>')},l=j.template('<form class="form-horizontal sv-fn-create-group-form">    <div class="control-group">       <label class="control-label">'+n("name")+'</label>       <div class="controls">          <input class="input-xlarge" data-fn-groupname type="text" name="name" required value="<%= name %>" />          <span class="help-block help">'+n("nameHelp")+'</span>       </div>    </div>    <div class="control-group">       <label class="control-label">'+n("description")+'</label>       <div class="controls">          <textarea class="input-xlarge" data-fn-groupdescription data-fn-request-focus rows="3" type="text" name="description"></textarea>          <span class="help-block help">'+n("descriptionHelp")+'</span>       </div>    </div>    <% if (templates.length > 1) { %>    <div class="control-group">       <label class="control-label">'+n("template")+'</label>       <div class="controls">          <select name="template">            <% for(var idx in templates) { %>               <option value="<%= templates[idx].id %>"><%= templates[idx].name %></option>            <% } %>          </select>          <span class="help-block help">'+n("templateHelp")+'</span>       </div>    </div>    <% } else { %>    <input type="hidden" name="template" value="<%= templates[0].id %>">    <% } %>    <div class="control-group">       <label class="control-label">'+n("type")+'</label>       <div class="controls">          <select name="type">            <% for(var idx in groupTypes) { %>               <option value="<%= groupTypes[idx].key %>"><%= groupTypes[idx].value %></option>            <% } %>          </select>          <span class="help-block help">'+n("typeHelp")+"</span>       </div>    </div> </form>");var h=function(t){var w=f.extend({},d,t),q=f(w.target),r=0;if(q.hasClass("sv-fn-popover-showing")){q.popover("destroy").removeClass("sv-fn-popover-showing");return}var u='<form class="form-search" onsubmit="return false;"><input type="text" placeholder="'+(w.placeholder||"")+'" data-fn-group-search class="span2 search-query"/></form>';if(w.groupFolder){u='<form class="form-search" onsubmit="return false;"><div class="input-append"><input type="text" placeholder="'+(w.placeholder||"")+'" data-fn-group-search class="span1 search-query"/><button type="button" class="btn btn-small sv-fn-create-group">'+n("createGroup")+"</button></div></form>"}q.popover("destroy").addClass("sv-fn-popover-showing").popover({html:true,title:u,placement:"bottom",content:'<ul class="sv-group-search-list sv-defaultlist"></ul>',trigger:"manual"});q.popover("show");var s=function(x){if(!f(x.target).is(".popover *")){q.popover("destroy").removeClass("sv-fn-popover-showing");f("body").unbind("click",s)}};f("body").bind("click",s);q.parent().find("[data-fn-group-search]").focus().closest(".popover").addClass("sv-groupsearch-popover");q.parent().find(".popover").on("click",".sv-fn-create-group",function(){b({name:q.parent().find("[data-fn-group-search]").val(),folder:w.groupFolder,templates:w.groupTemplates,groupTypes:w.groupTypes,portletId:w.portletId})});var o=k.PortletUtil.getUtilityApiUri("socialsearchutil","groups"),p=q.parent().find(".popover-content").find("ul"),v=[];q.parent().find("[data-fn-group-search]").keydown(function(y){var x=c.getKeyCodeFromEvent(y);if(x===g.DOWN){r++;if(r>v.length-1){r=0}p.children().removeClass("active").eq(r).addClass("active");return false}else{if(x===g.UP){r--;if(r<0){r=v.length-1}p.children().removeClass("active").eq(r).addClass("active");return false}}}).keyup(function(z){var y=c.getKeyCodeFromEvent(z);if(y===g.ESC){q.popover("destroy");return false}else{if(y===g.RETURN){if(typeof(v[r])!=="undefined"){q.popover("destroy");w.selected&&w.selected.call(this,v[r]);return false}else{if(r===-1){b({name:f(this).val(),folder:w.groupFolder,template:w.groupTemplate,groupTypes:w.groupTypes,portletId:w.portletId})}}}else{if(c.isNonTextModifiableKeyCode(y)){return false}else{var x=this;e&&clearTimeout(e);e=setTimeout(function(){r=-1;p.empty();var A=f(x).val();f.ajax({url:o,data:{term:A}}).done(function(B){if(B.queryString===f(x).val()){r=0;p.empty();v=B.hits;f.each(v,function(C,E){var D=f(w.hitTemplate(E));p.append(D);D.click(function(){q.popover("destroy");w.selected&&w.selected.call(this,E);return false}).mouseenter(function(){p.children().removeClass("active");r=C;f(this).addClass("active")})});w.success&&w.success.call(this,v)}})},200)}}}})};function a(p){var s=0,q=p.length,o=[],r;for(;s<q;s++){r=p[s];o.push({key:r,value:n(r)})}return o}function b(o){o.groupTypes=a(o.groupTypes);var p=f(l(o));var q=[{text:i("cancel")},{text:i("ok"),skipDismiss:true,primary:true,callback:function(){var r=k.PortletUtil.getPortletResourceUri(o.portletId,"groupAdministration");f.ajax({type:"POST",dataType:"JSON",data:f(".sv-fn-create-group-form").serialize(),url:r,success:function(s){f(".modal").modal("hide");location.href=s.showGroupURL},error:function(u){f(".alert").show();var s=f.parseJSON(u.responseText);var v=f(".alert").find(".alert-title");v.data("orginal-title",v.text());var t=f(".alert").find(".alert-message");t.data("orginal-message",t.text());t.text(n(s.type.toLowerCase()));p.find("input").first().focus().closest(".control-group").addClass("error")}})}}];k.DialogUtil.showDialog({title:n("createGroupLabel"),body:p,buttons:q,removeOnHide:true,errorTitle:n("createGroupError"),errorMsg:n("groupAlreadyExists")})}k.AddGroupUtil={showSearchPopover:h}}());(function(){var c=window.$svjq,h=window._,i=window.sv,a=i.Log,l=i.Events,d=h.template('<i class="halflings-icon thumbs-up"></i><b><%= likeText %></b> (<%= likeCount %>)'),m={};var n=function(o){var p;if(m[o]){return m[o]}p=i.i18n.getText("common",o);return p};var k=function(q){var o=q.data("like-count")||0,p=!!q.data("user-likes");q.html(d({likeText:p?n("likes"):n("like"),likeCount:o,userLikes:p}));q[p?"addClass":"removeClass"]("sv-liked")};var j=function(o){o=o||c("body");if(o.is("[data-fn-likable],[data-fn-portlet-likable]")){k(o);return}o.find("[data-fn-likable],[data-fn-portlet-likable]").each(function(){k(c(this))})};var b=function(o,q,p){return c.ajax({url:o,method:p?"DELETE":"POST",dataType:"JSON",data:{likable:q}})};var f=function(o){return c.ajax({url:o,method:"GET",dataType:"JSON"})};var g=function(p,o){p.tooltip({html:true,title:o.join("<br/>")});p.tooltip("show")};var e=function(){var s=c(this),p=!!s.data("user-likes"),t=s.data("likable-id"),r,q,o;s.removeData("likes");s.tooltip("destroy");if(!t){a.warn("Trying to like object without likable-id in portlet "+s.closest(".sv-portlet").attr("id"));return}if(s.hasClass("sv-disabled")){return}s.addClass("sv-disabled");r=s.closest(".sv-portlet");q=i.ObjectUtil.getObjectId(r.attr("id"));if(p){o=i.PortletUtil.getPortletResourceUri(q,"unlike")+"&likable="+t}else{o=i.PortletUtil.getPortletResourceUri(q,"like")}b(o,t,p).done(function(u){s.data("user-likes",!p).data("like-count",u.count);k(s)}).fail(function(u){i.ErrorUtil.handleAjaxFailure(u)}).always(function(){s.removeClass("sv-disabled")});return false};i.LikableUtil={toggleLike:e};c("body").on("click.likeable","a[data-fn-likable]",e);c(document).on("mouseenter",".sv-like",function(){var t=c(this),s=t.closest(".sv-portlet"),r=i.ObjectUtil.getObjectId(s.attr("id")),u=t.data("likable-id"),p=t.data("likes"),o=t.data("like-count");if(o>0){if(p){g(t,p)}else{var q=i.PortletUtil.getPortletResourceUri(r,"likes")+"&likable="+u;f(q).done(function(v){t.data("likes",v);g(t,v)}).fail(function(v){i.ErrorUtil.handleAjaxFailure(v)})}}});c(document).on("mouseleave",".sv-like",function(){c(this).tooltip("destroy")});l.on(l.types.updateLikables,j);j()}());(function(){var a=window.sv,d=window.$svjq,e=window.moment,b=a.Events,f=d("html").attr("lang")||"en";var c=function(g){g=g||d("body");g.find("time[data-fn-relative-date]").each(function(){var k=d(this),i=k.attr("datetime"),h=k.data("short");e.lang(h?f+"-short":f);var j=e(i);if(j){k.text(j.fromNow());k.attr("title",j.format("LLLL"))}})};window.setInterval(c,60000);b.on(b.types.updateRelativeDates,c);c()}());(function(){var c=window.$svjq,a=window.sv,d=a.PortletUtil;var b=function(f){var e=d.getModelObjectUri(f.repository,"fileExists");var g=false;c.ajax({type:"PUT",url:e,dataType:"json",success:function(h){g=h.result.exists},data:JSON.stringify({fileName:f.fileName,excludeFile:f.excludeFile}),async:false});return g};a.SearchFileUtil={fileNameExists:b}}());(function(){var e=window.$svjq,i=window.sv,a=i.PortletUtil,b=i.KeyUtil,f=b.KEY,j={},d,h=window._,c={success:function(){},selected:function(){},placeholder:"",markAdmins:false,hitTemplate:h.template('<li data-user-identity="<%= id %>" class="sv-clearfix">   <img class="sv-contact-img sv-buddy-icon" src="<%= iconURL %>" />   <% if ((typeof(isMember) !== \'undefined\' && isMember) || (typeof(isAdmin) !== \'undefined\' && isAdmin) || (typeof(isContact) !== \'undefined\' && isContact)) { %><div style="float:right"><i class="halflings-icon ok"></i></div><% } %>   <div class="sv-user-info-container">     <h3 class="sv-contact-name"><%= name %></h3>     <p>     <% _.each(userfields, function(field) { %>        <%= field.value %><br/>     <% }); %>     </p>   </div></li>'),adminHitTemplate:h.template('<li data-user-identity="<%= id %>" class="sv-clearfix">   <img class="sv-contact-img sv-buddy-icon" src="<%= iconURL %>" />   <% if ((typeof(isAdmin) !== \'undefined\' && isAdmin)) { %><div style="float:right"><i class="halflings-icon ok"></i></div><% } %>   <div class="sv-user-info-container">     <h3 class="sv-contact-name"><%= name %></h3>     <p>     <% _.each(userfields, function(field) { %>        <%= field.value %><br/>     <% }); %>     </p>   </div></li>')};var k=function(l,m){var n;if(!m&&j[l]){return j[l]}n=i.i18n.getText("portlet.util.searchuserutil",l,m);if(!m){j[l]=n}return n};var g=function(o){var p=e.extend({},c,o),n=e(p.target),s=0;if(n.hasClass("sv-fn-popover-showing")){e(".popover").remove();n.removeClass("sv-fn-popover-showing");return}e(".popover").remove();n.addClass("sv-fn-popover-showing").popover({html:true,container:n.closest(".modal").length>0?n.closest(".modal"):false,title:'<input type="text" placeholder="'+(p.placeholder||"")+'" data-fn-user-search class="input-medium search-query"/>',placement:"bottom",content:'<ul class="sv-user-search-list sv-defaultlist"></ul>',trigger:"manual"});n.popover("show");var m=function(t){if(!e(t.target).is(".popover *")){e(".popover").remove();n.removeClass("sv-fn-popover-showing");e("body").unbind("click",m)}};e("body").bind("click",m);e("[data-fn-user-search]").focus().closest(".popover").addClass("sv-usersearch-popover");var r=a.getUtilityApiUri("socialsearchutil","contacts")+"?userfields=true",q=e(".popover-content").find("ul"),l=[];if(p.group){r+="&group="+p.group}if(p.userIdentity){r+="&identity="+p.identity}q.css("max-height",((window.innerHeight-q.offset().top)-10)+"px");e("[data-fn-user-search]").keydown(function(u){var t=b.getKeyCodeFromEvent(u);if(t===f.DOWN){s++;if((p.searchUrl&&s>l.length)||(!p.searchUrl&&s>l.length-1)){s=0}q.children().removeClass("active").eq(s).addClass("active");return false}else{if(t===f.UP){s--;if(s<0){s=p.searchUrl?l.length:l.length-1}q.children().removeClass("active").eq(s).addClass("active");return false}}}).keyup(function(v){var u=b.getKeyCodeFromEvent(v);if(u===f.ESC){e(".popover").remove();n.removeClass("sv-fn-popover-showing");return false}else{if(u===f.RETURN){if(s===l.length){if(s>0&&typeof(q.children().eq(s).find("a").attr("href"))!=="undefined"){location.href=q.children().eq(s).find("a").attr("href")}else{if(e(this).val()!==""){location.href=p.searchUrl+"&query="+e(this).val()}}return false}else{if(typeof(l[s])!=="undefined"){e(".popover").remove();n.removeClass("sv-fn-popover-showing");p.selected&&p.selected.call(this,l[s]);return false}}}else{if(b.isNonTextModifiableKeyCode(u)){return false}else{var t=this;d&&clearTimeout(d);d=setTimeout(function(){s=0;q.empty();var w=e(t).val();if(w!==""){e.ajax({url:r,data:{term:w}}).done(function(z){if(z.queryString===e(t).val()){s=0;q.empty();l=z.hits;e.each(l,function(A,C){var B=p.markAdmins?e(p.adminHitTemplate(C)):e(p.hitTemplate(C));q.append(B);B.click(function(){e(".popover").remove();n.removeClass("sv-fn-popover-showing");p.selected&&p.selected.call(this,C);return false}).mouseenter(function(){q.children().removeClass("active");s=A;e(this).addClass("active")})});if(p.searchUrl&&l.length>0){var x=k("showAll");if(l.length<10){x=k("showAsList")}var y=e('<li class="sv-showmore"><a href="'+p.searchUrl+"&query="+w+'">'+x+"</a></li>");y.appendTo(q).mouseenter(function(){q.children().removeClass("active");s=l.length}).click(function(){location.href=e(this).find("a").attr("href");return false});s=l.length}q.children().eq(s).addClass("active");p.success&&p.success.call(this,l)}})}},200)}}}})};i.SearchUserUtil={showSearchPopover:g}}());(function(){var l=window.sv,i=window.Backbone,k=window._,h,j,d=window.$svjq,c=0,b=0;var a=i.Model.extend({defaults:{fields:[],contacts:0,groups:0},toEscapedJSON:function(){var o={};k.each(this.attributes,function(q,p){o[p]=this.sanitize(q)},this);return o},sanitize:function(r){var o,q=0,p;if(k.isArray(r)){o=[];p=r.length;for(;q<p;q++){o.push(k.escape(r[q]))}}else{o=k.escape(r)}return o},url:function(){return"/restapi/v1/"+l.PageContext.pageId+"/userinformation/status?id="+this.id}});var f=i.View.extend({tagName:"div",template:k.template('<img style="float:left; margin-right:8px;" class="sv-buddy-icon" src="<%= largeBuddyIcon %>" /><div style="overflow: hidden" class="sv-userfields">    <% _.each(fields, function(field) { %>       <%= field %><br/>    <% }); %></div><div style="clear:left; padding-top:5px; margin-bottom:3px" class="sv-clearfix"><div style="float:left"><img src="/sitevision/core/<%= status %>.png"/></div><div style="float:left"><small><%= statusText %></small></div></div>'),getContent:function(){return this.template(this.model.toEscapedJSON())}});var n=function(){d(".popover.sv-user-info").remove();d("body").unbind("click",n);d("body").off("mousemove",m);c=0;b=0};var m=function(o){c=o.pageX;b=o.pageY};var e=function(o){var p=o.offset();if(c<p.left){return false}if(c>(p.left+o.width())){return false}if(b<p.top){return false}if(b>(p.top+o.height())){return false}return true};var g=function(o){n();d("body").on("mousemove",m);h=setTimeout(function(){var q=o.attr("title")||o.data("orginal-title"),p=o.data("fn-show-user-popup-subtitle");if(!e(o)){n();clearTimeout(h);return}n();if(q){q=k.escape(q);o.data("orginal-title",q);o.removeAttr("title")}if(p){q+="<small> "+p+"</small>"}o.popover({trigger:"manual",placement:function(){var r=o.offset().left;if(window.innerWidth-r<=400){if(r>400){return"left"}else{return"top"}}return"right"},title:q,container:o.closest(".modal").length>0?o.closest(".modal"):false,html:true,content:function(){return o.data("content")}});o.popover("show");o.siblings(".popover").addClass("sv-user-info");d("body").bind("click",n);if(j){clearTimeout(j)}j=setTimeout(n,10000)},500)};d("body").on("mouseenter","[data-user-identity][data-fn-show-user-popup]",function(){var p=d(this),r=p.data("user-identity"),q,o;if(!p.data("content")){q=new a({id:r});q.fetch({success:function(){o=new f({model:q});p.data("content",o.getContent());g(p)}})}else{g(p)}}).on("mouseleave","[data-user-identity][data-fn-show-user-popup]",function(){if(h){clearTimeout(h)}if(j){clearTimeout(j)}n()})}());(function(){var a=window.sv,h=a.PortletUtil,e=a.DialogUtil,b=window.$svjq,f=function(i){return a.i18n.getText("portlet.social.userfields.userfields",i)};var d=function(i){return a.i18n.getText("common",i)};var g=function(j){var i=true;if(typeof j.checkValidity==="function"){i=j.checkValidity()}return i};var c=function(i){var k=b("<div/>").addClass("sv-userfields-content"),j=a.PageContext.pageId;var l=b("<form/>").addClass("form-horizontal sv-userfields-form");k.append(l);b.ajax({type:"GET",dataType:"json",url:"/restapi/v1/"+j+"/userfield/getuserfields",data:{fields:i||"all"},success:function(o){b.each(o.fields,function(w,z){var y=b("<div/>").addClass("control-group");l.append(y);var v=b("<label/>").addClass("control-label").text(z.name);y.append(v);var u=b("<div/>").addClass("controls");y.append(u);if(z.writeable==="true"){var t;if(z.type==="text_field"){t=b("<textarea/>").attr({rows:"3",id:z.id,name:z.id,"data-errorMsg":z.validationErrorMessage}).addClass("input-xlarge");if(z.validationType!=="no_validation"){if(z.validationType==="reg_exp_validation"&&z.regularExpression){t.attr("pattern",z.regularExpression)}if(z.value){t.attr("required","")}t.attr("data-validation","true")}u.append(t);if(z.value){t.val(z.value)}}else{t=b("<input/>").attr({type:z.type,id:z.id,name:z.id,"data-errorMsg":z.validationErrorMessage}).addClass("input-xlarge");if(z.validationType!=="no_validation"){if(z.validationType==="reg_exp_validation"&&z.regularExpression){t.attr("pattern",z.regularExpression)}if(z.value){t.attr("required","")}t.attr("data-validation","true")}u.append(t);if(z.value){t.val(z.value)}if(z.description){var x=b("<span/>").addClass("help-block help").text(z.description);u.append(x)}}}else{if(z.value){u.append(b("<label/>").attr({title:z.description}).css("padding-top","5px").text(z.value))}}});if(o.passwordRequired){var s=b("<div/>").addClass("control-group").addClass("well");l.append(s);var p=b("<label/>").addClass("control-label").text(f("password_field_title"));s.append(p);var n=b("<div/>").addClass("controls");s.append(n);var m=b("<input/>").attr({id:"password",name:"password",type:"password"}).addClass("input-xlarge");n.append(m);var r=b("<span/>").addClass("help-block help").text(f("password_field_description"));n.append(r)}l.find("input").not('[type="password"]').on("keyup",function(u){var t=b(u.target);if(t.val().length&&t.attr("data-validation")){t.attr("required","required")}else{t.removeAttr("required")}});var q=[{text:d("cancel")},{text:d("ok"),skipDismiss:true,primary:true,callback:function(){b(".help-block").remove(".error");b(".help-block").remove(".serverside-error");b(".control-group").removeClass("error");b(".alert").hide();if(g(l.get(0))){b.ajax({type:"POST",dataType:"JSON",url:"/restapi/v1/"+j+"/userfield/setuserfields",data:l.serialize(),success:function(v){if(v.success){h.reloadPortletsByType(".sv-userfields-portlet");b(".modal").modal("hide")}else{if(v.serverError){b(".alert").show();b(".alert").find(".alert-title").text(d("error"));b(".alert").find(".alert-message").text(f(v.serverError));if(v.serverError==="wrong_password"){var u=k.find("#password");u.parents(".control-group").addClass("error");u.focus()}}else{b.each(v.failedFields,function(y,x){var w=b("#"+x);w.parents(".control-group").addClass("error");if(!w.nextAll(".serverside-error").length){w.nextAll(".help-block.error").remove();w.after(b("<span/>").addClass("help-block help serverside-error").text(w.attr("data-errorMsg")))}})}}},error:function(){b(".alert").show()}})}else{var t=b("#password");if(t.length&&!g(t.get(0))){t.get(0).focus();t.parents(".control-group").addClass("error");b(".alert").show();b(".alert").find(".alert-title").text(d("error"));b(".alert").find(".alert-message").text(f("wrong_password"))}b.each(o.fields,function(u,v){t=b("#"+v.id);if(v.writeable==="true"&&!g(t.get(0))){t.get(0).focus();t.parents(".control-group").addClass("error");if(!t.nextAll(".serverside-error, .error").length){t.after(b("<span/>").addClass("help-block help error").text(t.attr("data-errorMsg")))}}})}}}];e.showDialog({title:f("dialogTitle"),body:k,buttons:q,removeOnHide:true,errorTitle:f("errorTitle"),errorMsg:f("errorMsg")})}})};a.UserSettingsUtil={popupUserSettingsDialog:c}}());(function(){var b=window.sv;var f=function(h,g){window.location.hash="#"+h+"/"+g};var e=function(g){var h=window.location.hash;var i=2+g.length;if(h.indexOf("#"+g+"/")===0&&h.length>i){return h.substring(i)}else{return}};var a=function(){window.location.hash=""};var d=function(){var g=window.location.hash;return g.indexOf("#")===0&&g.indexOf("/")>1};var c=function(){location.reload()};b.WindowLocationUtil={setHashValue:f,getHashValue:e,clearHashValue:a,hasHashValue:d,reloadPage:c}}());(function(){var c=window.$svjq,b=window.sv.i18n,a=window.sv.ClientUtil;c(".sv-archive-portlet").on("click",".sv-create-article-entry",function(i){var h=c(this),g=h.hasClass("sv-use-blog-editor"),j=h.attr("href"),d=h.parent(),f=c("<div>").addClass("sv-loading-icon").text(b.getText("portlet.archive.archive","creatingArticle"));d.empty().append(f);c.ajax({type:"GET",dataType:"JSON",url:j,success:function(e){if(e.success){if(i.shiftKey||g||a.isMobileDevice){window.location.href=e.blogEditorURL}else{window.location.href=e.editorURL}}}});return false})}());(function(){var b=window.$svjq,a=window.sv.i18n;b(".sv-blog-portlet").on("click",".sv-create-blog-entry",function(){var e=b(this),f=e.attr("href"),c=e.parent(),d=b("<div>").addClass("sv-loading-icon").text(a.getText("portlet.blog.blog","creatingBlogEntry"));c.empty().append(d);b.ajax({type:"GET",dataType:"JSON",url:f,success:function(g){if(g.success){window.location.href=g.blogEditorURL}}});return false})}());(function(){var q=window.sv,i=q.PortletUtil,l=q.ObjectUtil,a=q.Events,k=q.KeyUtil,c=k.KEY,e=window.$svjq,b=window.Backbone,m={},f;var n=function(t,u){var v;if(!u&&m[t]){return m[t]}v=q.i18n.getText("portlet.comments2.comments",t,u);if(!u){m[t]=v}return v};var d=function(t,u){t.find("a[data-user-identity]").each(function(){var v=e(this);v.attr("href",u+"?identity="+v.data("user-identity"))})};var s=function(t,u){t.find("a[data-social-tag-id]").each(function(){var v=e(this);v.attr("href",u+"?tag="+v.data("social-tag-name"))})};var p=b.Model.extend({url:function(){if(this.collection){return this.collection.url()+"&commentId="+this.get("id")}return"?commentId="+this.get("id")}});var h=b.Collection.extend({model:p,initialize:function(u,t){this.options=t;this.bindServerEvents()},bindServerEvents:function(){var t=this;a.on("server-pagecomment-added-"+q.PageContext.pageId,function(u){t.add(u.data.content,{append:true})})},url:function(){return i.getPortletResourceUri(this.options.portletId,"comment")+"&file="+this.options.id}});var g=b.View.extend({tagName:"li",className:function(){return this.model.get("hidden")?"sv-comment2-comment sv-comment-hidden":"sv-comment2-comment"},events:{"click [data-fn-destroy-comment]":"showDestroyDialog","click [data-fn-hide-comment]":"doHide","click [data-fn-show-comment]":"doHide"},initialize:function(){this.listenTo(this.model,"destroy",this.remove,this);this.listenTo(this.model,"change:hidden",this.hide,this)},showDestroyDialog:function(){var t=this;q.DialogUtil.showConfirmDialog(n("removeCommentTitle"),n("removeCommentBody"),function(u){if(u){t.model.destroy({wait:true})}});return false},doHide:function(t){t.preventDefault();this.model.set({hidden:!this.model.get("hidden")});this.model.save()},hide:function(){if(this.model.get("hidden")){this.$el.addClass("sv-comment-hidden");this.$el.attr("title",n("hiddenComment"));this.$el.find("[data-fn-hide-comment]").addClass("sv-hidden");this.$el.find("[data-fn-show-comment]").removeClass("sv-hidden");this.$el.find(".sv-comments2-hidden-comment-text").removeClass("sv-hidden")}else{this.$el.removeClass("sv-comment-hidden");this.$el.removeAttr("title");this.$el.find("[data-fn-hide-comment]").removeClass("sv-hidden");this.$el.find("[data-fn-show-comment]").addClass("sv-hidden");this.$el.find(".sv-comments2-hidden-comment-text").addClass("sv-hidden")}},render:function(){this.$el.html(this.options.template(this.model.toJSON()));if(this.model.toJSON().hidden){this.$el.attr("title",n("hiddenComment"))}d(this.$el,this.options.profilePageURL);s(this.$el,this.options.tagResultPageURL);return this}});var r=b.View.extend({initialize:function(){this.$list=this.$el.find("[data-fn-comments2]");this.collection.on("add",this.addNewComment,this);this.$el.find("[data-fn-comments2-input]").triggeredInput({triggers:{"@":{source:i.getUtilityApiUri("socialsearchutil","contacts"),searchKey:"term",allowWhiteSpace:true,parse:function(t){return t.hits}}},minLength:2,replacer:function(t){return t.trigger+'{"value":"'+t.name+'","id":"'+t.id+'"}'}});if(this.collection.length>0){this.render()}},render:function(){this.clearList();this.collection.each(function(t){this.appendOne(t)},this);a.trigger(a.types.updateRelativeDates,this.$el);a.trigger(a.types.updateLikables,this.$el)},clearList:function(){this.$list.empty()},appendOne:function(y){var u=new g({model:y,template:this.options.commentTemplate,profilePageURL:this.options.profilePageURL,tagResultPageURL:this.options.tagResultPageURL});var x=u.render().$el;var t=x.find(".sv-comments2-content");var w=t.find(".sv-truncate-more"),v;if(w.length>0){this.addShowMoreLink(w);v=true}this.$list.append(x);if(v){this.bindShowMoreEvents(x)}},bindShowMoreEvents:function(v){var u={moreText:n("showMore"),lessText:n("showLess")};var x=e(".sv-truncate-more-link",v),w=e(".sv-truncate-more",v),t=e(".sv-truncate-ellipsis",v);x.on("click",function(y){y.preventDefault();if(x.text()===u.moreText){w.show();x.text(u.lessText);t.css("display","none")}else{w.hide();x.text(u.moreText);t.css("display","inline")}})},addShowMoreLink:function(t){e('<span class="sv-truncate-ellipsis">...</span>').insertBefore(t);e('<div><a href="#" class="sv-truncate-more-link">'+n("showMore")+"</a></div>").insertAfter(t);t.css("display","none")},addNewComment:function(t){if(t.toJSON().author!==undefined){this.appendOne(t)}else{a.trigger(a.types.notifyUser,{type:"default",heading:n("moderatedHeading"),message:n("moderatedBody"),"transient":true})}a.trigger(a.types.updateRelativeDates,this.$el);a.trigger(a.types.updateLikables,this.$el)},getLoader:function(){if(!this.$loader){this.$loader=e('<img src="/sitevision/util/images/loading_16_grey.gif" />').css("vertical-align","middle").appendTo(this.$el.find("[data-fn-comment-input]").parent())}return this.$loader},events:{"focus [data-fn-comments2-input]":"expandTextfield","click [data-fn-comments2-input]":"expandTextfield","keyup [data-fn-comments2-input]":"countdownCharactersLeft","keyup [data-fn-comments2-input-name]":"countdownCharactersLeft","keydown [data-fn-comments2-input]":"checkKeyDown","submit [data-fn-comments2-form]":"postComment"},expandTextfield:function(t){e(t.currentTarget).addClass("sv-message-input-expanded");this.$el.find(".sv-submit-controls").show();this.countdownCharactersLeft(t)},shrinkTextfield:function(){this.$el.find(".sv-message-input-expanded").removeClass("sv-message-input-expanded");this.$el.find(".sv-submit-controls").hide()},getTextField:function(){if(!this.$textField){this.$textField=this.$el.find("[data-fn-comments2-input]")}return this.$textField},countdownCharactersLeft:function(v){var t=e(v.currentTarget),w=t.val(),u=f-w.length,x=this.$el.find("[data-fn-comments2-input-size]");if(u<0){x.addClass("sv-character-limit-exceeded")}else{x.removeClass("sv-character-limit-exceeded")}x.text(u);if(t.val()!==""&&u>=0&&!this.activeConnection){this.enableSubmitButton()}else{this.disableSubmitButton()}},checkKeyDown:function(u){var t=k.getKeyCodeFromEvent(u);if(t===c.RETURN&&u.ctrlKey){this.getSubmitButton().focus();this.$el.find("[data-fn-comments2-form]").submit();return false}},postComment:function(z){var w=this,y,A,v,x,t;if(!(z.isPropagationStopped()||z.isDefaultPrevented())){z.preventDefault();if(this.activeConnection){return false}y=this.$el.find("[data-fn-comments2-input]");t=w.getNameField();v=y.val().length;if(t.length===1&&t.val().length===0){a.trigger(a.types.notifyUser,{type:"default",heading:n("noNameHeading"),message:n("noNameBody"),"transient":true});return false}if(v>0&&v<=f){this.disableSubmitButton();this.activeConnection=true;A=new p({comment:y.triggeredInput("getRichContent"),fullName:t.val()});var u=w.$el.find("[data-sv-spam-marker]");if(u.length>0){A.attributes[u.attr("name")]=u.val()}x=setTimeout(function(){w.getLoader().show()},400);this.collection.create(A,{wait:true,success:function(){y.val("");w.activeConnection=false;w.getLoader().hide();clearTimeout(x);e.cookie("fullName",t.val())},error:function(){w.activeConnection=false;w.getLoader().hide();clearTimeout(x);w.enableSubmitButton();a.trigger(a.types.notifyUser,{type:"error",heading:n("postFailedHeading"),message:n("postFailedBody"),"transient":true})}});this.shrinkTextfield()}else{if(v>f){a.trigger(a.types.notifyUser,{type:"default",heading:n("commentToLongHeading"),message:n("commentToLongBody"),"transient":true})}}return false}},getSubmitButton:function(){if(!this.$submitButton){this.$submitButton=this.$el.find("[data-fn-comments2-submit]")}return this.$submitButton},getNameField:function(){if(!this.$NameField){this.$NameField=this.$el.find("[data-fn-comments2-input-name]")}return this.$NameField},disableSubmitButton:function(){this.getSubmitButton().addClass("disabled").attr("disabled","disabled")},nameFieldOK:function(){var t=this.getNameField();if(t.length!==0&&!t.val()){return false}return true},enableSubmitButton:function(){var t=this.getTextField();if(t.val()!==""&&this.nameFieldOK()){this.getSubmitButton().removeClass("disabled").removeAttr("disabled")}}});e(".sv-comments2-portlet").each(function(){var t=e(this);j(t)});function j(A){var w=A.find("[data-comments2-entry]");o(A);if(w.length===0){return}var B=l.getObjectId(A.attr("id"));var v=w.data("js-namespace"),y=B,u=w.data("profilepageurl"),C=w.data("tagresultpageurl"),z=new h(q[v].comments||[],{id:y,portletId:B});f=q[v].maxCharacterCount;new r({el:A,collection:z,commentTemplate:i.getTemplate(A,"comments2-comment"),portletId:B,profilePageURL:u,tagResultPageURL:C});var x=A.find(".sv-comments2-comments");if(x.length>0){d(x,u);s(x,C)}var t=e.cookie("fullName");if(t!==null&&t.length>0){A.find("[data-fn-comments2-input-name]").val(t)}A.find(".sv-comment-hidden").attr("title",n("hiddenComment"))}function o(u){var t=l.getObjectId(u.attr("id"));u.off("click","[data-fn-comment2-toggle-close]");u.on("click","[data-fn-comment2-toggle-close]",function(w){w.preventDefault();var v=i.getPortletUri(t,"toggleVisible");e.get(v,function(x){u.find(".sv-comments2-portlet-content").html(x);j(u)})});u.off("click","[data-fn-comment2-toggle-mutable]");u.on("click","[data-fn-comment2-toggle-mutable]",function(w){w.preventDefault();var v=i.getPortletUri(t,"toggleMutable");e.get(v,function(){if(u.find("[data-sv-comments2-closed-title]").hasClass("sv-hidden")){u.find("[data-sv-comments2-closed-title]").removeClass("sv-hidden");u.find(".sv-comments2-form").addClass("sv-hidden");u.find("[data-sv-comments2-disallow-comments]").addClass("sv-hidden");u.find("[data-sv-comments2-allow-comments]").removeClass("sv-hidden")}else{u.find("[data-sv-comments2-closed-title]").addClass("sv-hidden");u.find(".sv-comments2-form").removeClass("sv-hidden");u.find("[data-sv-comments2-disallow-comments]").removeClass("sv-hidden");u.find("[data-sv-comments2-allow-comments]").addClass("sv-hidden")}})})}}());(function(){var c=window.$svjq;var b=window.sv;var e;var a=function(l){var y=l.portletId;var j=l.inputField;var p=l.resultDiv;var m=-1,i=-1;var s='<div class="sv-searchform2-message">   <<%= noHitsTag %> class="<%= noHitsClass %>"><%= noHitsText %></<%= noHitsTag %>></div>';var w=function(C,E){var D='<div class="sv-border-box sv-searchform2-facet-column'+C+'" style="width: '+E+'px">   <<%= facetTag %> class="<%= facetTagClass %>"><%= name %></<%= facetTag %>>   <ul class="sv-defaultlist sv-user-search-list sv-searchform2-search-list sv-searchform2-search-list-column'+C+'">      <% _.each(hits, function(hit){ %>         <li class="sv-clearfix sv-searchform2-search-hit">            <img class="sv-buddy-icon sv-searchform2-user-img" src="<%= hit.iconURL %>" />            <% if (hit.isContact) { %><div style="float:right"><i class="halflings-icon ok"></i></div><% } %>            <div class="sv-searchform2-user-container">               <<%= userBlockTag %> class="sv-searchform2-user-name <%= userTagClass %>"><a href="<%= hit.profileURL %>" onclick="<%= hit.onClick %>"><%= hit.name %></a></<%= userBlockTag %>>               <% if (typeof(hit.userfields) !== \'undefined\') { %>                  <ul class="sv-searchform2-userfield-list">                     <% _.each(hit.userfields, function(userfield){ %>                     <li class="<%= textTagClass %>"><%= userfield.value %></li>                     <% }); %>                  </ul>               <% } %>            </div>         </li>      <% }); %>      <% if (showDetails) { %>         <li class="sv-clearfix sv-searchform2-search-hit sv-searchform2-more-hits"><<%= textTag %> class="<%= textTagClass %>"><a href="<%= showDetailsURL %>"><%= showDetailsText %></a></<%= textTag %>></li>      <% } %>   </ul></div>';return D};var q=function(C,E){var D='<div class="sv-border-box sv-searchform2-facet-column'+C+'" style="width: '+E+'px">   <<%= facetTag %> class="<%= facetTagClass %>"><%= name %></<%= facetTag %>>   <ul class="sv-defaultlist sv-user-search-list sv-searchform2-search-list sv-searchform2-search-list-column'+C+'">      <% _.each(hits, function(hit){ %>         <li class="sv-searchform2-search-hit"><a class="sv-vamiddle <%= contentTagClass %>" href="<%= hit.URL %>" onclick="<%= hit.onClick %>"><%= hit.name %></a><% if (typeof(hit.iconURL) !== \'undefined\') { %><img alt="<%= hit.iconDescription %>" class="sv-noborder-vamiddle" src="<%= hit.iconURL %>" style="margin-left: 3px;"><% } %></li>      <% }); %>      <% if (showDetails) { %>         <li class="sv-clearfix sv-searchform2-search-hit sv-searchform2-more-hits"><<%= textTag %> class="<%= textTagClass %>"><a href="<%= showDetailsURL %>"><%= showDetailsText %></a></<%= textTag %>></li>      <% } %>   </ul></div>';return D};var z=function(){p.hide()};c("body").bind("click",z);var u=function(C){if(C.hasClass("sv-searchform2-result-container-alignment-left")){return"left"}else{return"right"}};var o=function(D){var C=D.parent();if(C.hasClass("sv-searchform2-search-list-column0")){return 0}else{if(C.hasClass("sv-searchform2-search-list-column1")){return 1}else{return -1}}};var t=function(D,C){return D<A(C)};var h=function(C){return C.index()};var x=function(E,D){if(E>-1){var C=D.find(".sv-searchform2-search-list-column"+E);if(C.length===1){return C}}return};var B=function(D,C){if(D>-1&&D<C.children().length){return c(C.children()[D])}else{return}};var k=function(E,F,D){var C=x(E,D);if(C!==undefined){return B(F,C)}else{return}};var A=function(C){return C.children().length};var f=function(E){var F=0;var D=x(0,E);var C=x(1,E);if(D!==undefined){F++}if(C!==undefined){F++}return F};var r=function(C){C.children().removeClass("active")};var g=function(C){C.addClass("active")};var v=function(C){C.removeClass("active")};var n=function(C){return C.find("a").attr("href")};j.keydown(function(H){var G=b.KeyUtil.getKeyCodeFromEvent(H);var F=x(0,p);var C=x(1,p);if(F!==undefined&&C!==undefined){if(G===b.KeyUtil.KEY.RIGHT&&i===0){i=1;m=-1;r(F);G=b.KeyUtil.KEY.DOWN}else{if(G===b.KeyUtil.KEY.LEFT&&i===1){i=0;m=-1;r(C);G=b.KeyUtil.KEY.DOWN}}}if(G===b.KeyUtil.KEY.DOWN||G===b.KeyUtil.KEY.UP){var E;if(i===0&&F!==undefined){E=F}else{if(i===1&&C!==undefined){E=C}else{if(i===-1){if(u(p)==="left"){if(F!==undefined){i=0;E=F}}else{if(C!==undefined){i=1;E=C}else{if(F!==undefined){i=0;E=F}}}}}}if(G===b.KeyUtil.KEY.DOWN&&E!==undefined&&t(m+1,E)){var D=B(m+1,E);m++;r(E);g(D)}else{if(G===b.KeyUtil.KEY.UP&&E!==undefined&&m>-1){m--;r(E);if(m>=0){var I=B(m,E);g(I)}else{i=-1}}}return false}}).keyup(function(F){var E=b.KeyUtil.getKeyCodeFromEvent(F);if(E===b.KeyUtil.KEY.ESC){z();return false}else{if(E===b.KeyUtil.KEY.RETURN){var G=k(i,m,p);if(G!==undefined){location.href=n(G)}else{if(f(p)===1){var D=x(0,p);var C=D.find(".sv-searchform2-more-hits");if(C.length===1){location.href=C.find("a").attr("href")}}}return false}else{if(b.KeyUtil.isNonTextModifiableKeyCode(E)){return false}else{if(e!==undefined){clearTimeout(e)}e=setTimeout(function(){var I=j.val();m=-1;i=-1;if(I===""||I.length<2){p.css("display","none")}else{var H=b.PortletUtil.getPortletResourceUri(y,"query");c.ajax({url:H,data:{term:I}}).fail(function(J){p.html('<div class="sv-searchform2-message">'+b.i18n.getText("portlet.search.searchform2.searchform2","searchFailed",J.status)+"</div>")}).done(function(V){if(I===V.term){var P=V.facets;p.empty();p.css("width","auto");if(P.length===0){var R=window._.template(s);p.append(c(R(V)))}else{var T=document.documentElement.clientWidth;var K=V.width/2;var N=K*P.length;if(N>T){if(T>300){K=T/2;N=K*P.length}else{if(K>T){K=T;N=T}else{N=K}}}for(var O=0;O<P.length;O++){var J=P[O];var Q;if(J.type==="content"){Q=q(O,K)}else{if(J.type==="users"){Q=w(O,K)}else{Q="";b.Log.error("Skipping unsupported facet type "+J.type)}}var U=window._.template(Q);p.css("width",N);p.append(c(U(J)))}var M=p.find("ul.sv-user-search-list");M.find("li.sv-searchform2-search-hit").mouseenter(function(){var W=c(this);i=o(W);m=h(W);r(M);g(W)}).mouseleave(function(){i=-1;m=-1;v(c(this))}).click(function(W){if(!c(W.target).is("a")){var X=c(this);location.href=n(X)}})}var S=V.facetAlignment+" top";var L=V.facetAlignment+" bottom";p.show();p.position({my:S,at:L,of:j,offset:"0 1",collision:"none"})}})}},200);return false}}}})};var d=c(".sv-searchform2-portlet");d.each(function(){var i=c(this);var h=b.ObjectUtil.getObjectId(i.attr("id"));var g=i.find(".sv-searchform2-result-container");var f=i.find(".sv-searchform2-input");f.attr("autocomplete","off");a({portletId:h,inputField:f,resultDiv:g})})}());(function(){var s=window.sv,h=window.$svjq,w=window._,l=s.PortletUtil,n=s.ObjectUtil,m=s.KeyUtil,i=s.DialogUtil,b=s.Events,e=s.ActivityUtil,c=window.Backbone,u=window.moment,j=h("html").hasClass("sv-touch"),p={type:"all",mine:false},k=function(z,y){return s.i18n.getText("common",z,y)},o=function(z,y){return s.i18n.getText("portlet.social.calendar.calendar",z,y)};var r=function(y){var z=this;h(".modal").modal("hide").remove();if(this.model.get("isTask")){i.showDialog({title:o("confirmRemoveTaskTitle"),body:o("confirmRemoveTaskMessage"),buttons:[{text:k("cancel"),callback:function(){h.proxy(y,z)()}},{text:o("confirmRemoveTaskRemove"),callback:function(){z.model.destroy({success:function(A){b.trigger(b.types.activityDeleted,A.attributes)}});h.proxy(y,z)()}},{text:o("confirmRemoveTaskSaveInTasks"),callback:function(){z.model.allowEmptyStart=true;z.model.set({start:"",end:"",allDay:false});z.model.save(null,{success:function(A){b.trigger(b.types.activityUpdated,A.attributes)}});h.proxy(y,z)()}}],errorTitle:k("networkErrorTitle"),errorMsg:k("networkErrorText")})}else{i.showConfirmDialog(o("confirmRemoveTitle"),o("confirmRemoveMessage"),function(A){if(A){z.model.destroy({success:function(B){b.trigger(b.types.activityDeleted,B.attributes)}});h.proxy(y,z)()}})}return false};var x=e.ActivityModel.extend({allowEmptyStart:false,url:function(){return l.getPortletResourceUri(this.portletId,"events")+(this.has("id")?"&id="+this.get("id"):"")},toFullCalendar:function(){var z=this.toJSON(),A=z.start,y=z.end;z.start=A?A/1000:A;z.end=y?y/1000:y;return z}});var q=c.Collection.extend({model:x,url:function(){return l.getPortletResourceUri(this.portletId,"events")},initialize:function(z,y){this.portletId=y.portletId},toFullCalendar:function(){return this.map(function(y){return y.toFullCalendar()})}});var v=e.ActivityEditView.extend({templateName:"edit",memberTemplateName:"member",participantTemplateName:"participant",membersActionName:"members",membersWithOwnerActionName:"membersWithOwner",i18n:o,removeActivity:function(){h.proxy(r,this,function(){h(".modal").modal("hide").remove()})()}});var t=c.View.extend({template:function(){return l.getTemplate(this.options.$portlet,"create")},events:{"keyup [data-fn-event-title]":"keyUp","submit form":"cancelOnSubmit","click [data-fn-create]":"createOnClick","click [data-fn-edit]":"edit"},initialize:function(y){this.options=y;var z=this.template();this.$el.append(z(this.model.toJSON()));this.listenTo(this.model,"invalid",this.handleErrors);this.ui={title:this.$el.find("[data-fn-event-title]")}},render:function(){b.trigger(b.types.popoverCreated,this);this.options.$target.popover({html:true,title:o("createEvent")+'<button type="button" class="close">&times;</button>',placement:e.calculatePopoverPlacement(this.options.$target),content:this.$el,trigger:"manual",container:this.options.popoverContainer}).popover("show");this.$el.closest(".popover").on("click",".close",h.proxy(this.closePopover,this)).on("clickoutside",h.proxy(this.closePopover,this));h(document).on("keydown",h.proxy(this.closePopoverOnEscape,this));h("[data-fn-request-focus]").focus();b.on(b.types.popoverCreated,h.proxy(this.closePopoverWhenOtherIsCreated,this));return this},handleErrors:function(y,z){e.showErrors(y,z,this.$el,o)},keyUp:function(y){if(m.getKeyCodeFromEvent(y)===m.KEY.RETURN){this.createOnClick()}if(m.getKeyCodeFromEvent(y)===m.KEY.ESC){this.closePopover()}this.handleRegularChange(y);return},cancelOnSubmit:function(){return false},setModelData:function(){this.model.set({title:h.trim(this.ui.title.val()),owner:this.options.user,isTask:false})},createOnClick:function(){this.setModelData();this.options.collection.create(this.model,{wait:true,success:h.proxy(function(y){this.closePopover();b.trigger(b.types.activityCreated,y.attributes)},this)});return false},edit:function(){this.closePopover();this.setModelData();var y=new v({portletId:this.options.portletId,$portlet:this.options.$portlet,model:new x(this.model.attributes,{portletId:this.options.portletId})});y.backingModel=this.model;y.render();if(j){h(window).scrollTop(0)}return false},closePopover:function(y){if(y&&y.type==="clickoutside"&&h(y.target).hasClass("fc-view")){return false}b.off(b.types.popoverCreated);h(document).off("keydown",this.closePopoverOnEscape);this.$el.closest(".popover").off("click",".close",this.closePopover).off("clickoutside",this.closePopover).remove();this.options.$target.popover("destroy")},closePopoverWhenOtherIsCreated:function(y){if(this!==y){this.closePopover()}},closePopoverOnEscape:function(y){if(y.keyCode===m.KEY.ESC){this.closePopover();return false}},handleRegularChange:function(y){this.model.set(y.currentTarget.name,y.currentTarget.value)}});var a=e.ActivityDetailView.extend({templateName:"details",participantsActionName:"participants",createEditView:function(y){var z=new v({model:new x(y.attributes,{portletId:this.options.portletId}),portletId:this.options.portletId,$portlet:this.options.$portlet});z.backingModel=y;return z},i18n:o,removeActivity:function(){h.proxy(r,this,function(){this.closePopover()})()},templateHelpers2:{timeSpan:function(E,z,C){var y=C?"ll":"lll",D=u(E),B=e.stripYear(E,D.format(y));if(z){var A=u(z);if(D.format("YYYY-MM-DD")===A.format("YYYY-MM-DD")){if(!C){return B+" - "+A.format("LT")}}else{if(D.format("YYYY")===A.format("YYYY")){return B+" - "+e.stripYear(z,A.format(y))}else{return B+" - "+A.format(y)}}}return B}}});var d=c.View.extend({initialize:function(y){this.options=y;w.bindAll(this);this.collection.bind("add",this.addOne);this.collection.bind("reset",this.addAll);this.collection.bind("change",this.change);this.collection.bind("destroy",this.destroy);this.collection.bind("remove",this.destroy);b.on(b.types.activityUpdated,h.proxy(this.activityUpdated,this));b.on(b.types.activityCreated,h.proxy(this.activityCreated,this));b.on(b.types.activityDeleted,h.proxy(this.activityDeleted,this));this.selectionFilterContent=l.getTemplate(this.options.$portlet,"filter")();b.on(b.types.groupPageViewed,h.proxy(function(){this.collection.each(function(z){z.set("markAsUnread",false)},this)}),this)},render:function(){this.$el.fullCalendar({header:{left:"prev,next today",center:"",right:"month,agendaWeek,agendaDay,agendaList svFilter",ignoreTimezone:false},editable:this.options.editable,weekNumbers:true,selectable:this.options.editable,selectHelper:this.options.editable,firstDay:1,droppable:this.options.editable,monthNames:[o("january"),o("february"),o("march"),o("april"),o("may"),o("june"),o("july"),o("august"),o("september"),o("october"),o("november"),o("december")],monthNamesShort:[o("jan"),o("feb"),o("mar"),o("apr"),o("may"),o("jun"),o("jul"),o("aug"),o("sep"),o("oct"),o("nov"),o("dec")],dayNames:[o("sunday"),o("monday"),o("tuesday"),o("wednesday"),o("thursday"),o("friday"),o("saturday")],dayNamesShort:[o("sun"),o("mon"),o("tue"),o("wed"),o("thu"),o("fri"),o("sat")],weekNumberTitle:o("week"),allDayText:o("allday"),axisFormat:o("axisFormat"),titleFormat:{month:o("titleMonth"),week:o("titleWeek"),day:o("titleDay"),agendaList:o("titleMonth")},columnFormat:{month:o("columnMonth"),week:o("columnWeek"),day:o("columnDay")},timeFormat:{"":o("timeFormat"),agenda:o("timeFormatAgenda")},buttonText:{today:o("buttonTextToday"),month:o("buttonTextMonth"),week:o("buttonTextWeek"),day:o("buttonTextDay"),agendaList:o("buttonTextAgendaList")},select:this.select,eventClick:this.eventClick,eventDrop:this.eventDropOrResize,eventResize:this.eventDropOrResize,eventRender:this.handleEventRender,eventAfterRender:this.handleEventAfterRender,eventMouseover:this.handleEventMouseover,drop:this.handleDrop,filter:this.renderSelectionFilter});this.$el.find(".fc-content").addClass(this.options.textClassName);if(this.collection.length){this.addAll()}},activityUpdated:function(y){var z=this.collection.get(y.id);if(z){z.set(y)}else{this.collection.add(new x(y,{portletId:this.options.portletId}))}},activityCreated:function(y){var z=this.collection.get(y.id);if(!z){this.collection.add(new x(y,{portletId:this.options.portletId}))}},activityDeleted:function(y){var z=this.collection.get(y.id);if(z){this.collection.remove(z)}},handleDrop:function(A,F,D){var y=h(D.target).data("eventObject"),C=u(A);if(!y.editable){return false}if(y.start){var z=u(y.start),B=y.end?u(y.end).diff(z):null;if(F){z.year(C.year());z.month(C.month());z.date(C.date());y.start=z.valueOf();if(y.end){y.end=z.add("ms",B).valueOf()}}else{y.start=f(A);if(y.end){y.end=u(y.start).add("ms",B).valueOf()}else{y.end=u(A).add("h",2).valueOf()}}}else{y.start=f(A);y.allDay=F;if(!F){y.end=C.add("h",2).valueOf()}}var G=this.collection.get(y.id);if(G){G.save(y,{wait:true,success:function(H){b.trigger(b.types.activityUpdated,H.attributes)}})}else{var E=new x(y,{portletId:this.options.portletId});E.save(y,{success:function(H){b.trigger(b.types.activityUpdated,H.attributes)}});this.collection.add(E)}},select:function(y,B,A,z){new t({$portlet:this.options.$portlet,portletId:this.options.portletId,user:this.options.user,popoverContainer:this.options.$portlet.find(".bootstrap"),$target:h(z.target),collection:this.collection,model:new x({start:f(y),end:B.getTime()===y.getTime()?"":f(B),allDay:A},{portletId:this.options.portletId})}).render()},addOne:function(y){this.$el.fullCalendar("renderEvent",y.toFullCalendar(),true)},addAll:function(){this.$el.fullCalendar("addEventSource",this.collection.toFullCalendar())},change:function(z){var y=this.$el.fullCalendar("clientEvents",z.get("id"))[0];y.title=z.get("title");y.location=z.get("where");y.description=z.get("description");y.start=z.get("start")?z.get("start")/1000:z.get("start");y.end=z.get("end")?z.get("end")/1000:z.get("end");y.allDay=z.get("allDay");y.owner=z.get("owner");y.participants=z.get("participants");y.eventState=z.get("eventState");y.ownerOrParticipant=z.get("ownerOrParticipant");y.markAsUnread=z.get("markAsUnread");y.isTask=z.get("isTask");this.$el.fullCalendar("updateEvent",y)},destroy:function(y){this.$el.fullCalendar("removeEvents",y.id)},eventDropOrResize:function(z){if(!z.editable){return false}var A=this.collection.get(z.id),B=z.allDay,y=f(z.start),C;if(z.end){C=f(z.end)}else{C=u(z.start).add("h",2).valueOf()}A.set({allDay:B,start:y,end:C});A.save(null,{wait:true,success:function(D){b.trigger(b.types.activityUpdated,D.attributes)}})},handleExternalEventDrop:undefined,eventClick:function(A,y){var z=this.collection.get(A.id);if(A.editable&&h(y.target).hasClass("fc-event-title")){z.fetch({success:h.proxy(function(B){var C=new v({model:new x(B.attributes,{portletId:this.options.portletId}),$portlet:this.options.$portlet,portletId:this.options.portletId});C.backingModel=B;C.render();if(j){h(window).scrollTop(0)}},this)})}else{new a({model:z,$portlet:this.options.$portlet,portletId:this.options.portletId,popoverContainer:this.options.$portlet.find(".bootstrap"),$target:h(y.target),jsEvent:y,i18n:o}).render()}return false},handleEventAfterRender:function(B,A){var C=A.find(".fc-event-title");if(C.length===0){var z=A.find(".fc-event-time"),y=A.find(".sv-calendar-user-icon");y.prependTo(z)}},handleEventRender:function(z,y){this.renderFilterOptions(z,y);this.renderColor(z,y);this.renderOwnerIcon(z,y);this.renderHover(z,y);this.renderTime(z,y);this.renderIsNew(z,y);this.filterEvent(z,y)},renderIsNew:function(z,y){y.find(".fc-agendalist-title,.fc-event-inner").toggleClass("sv-new",z.markAsUnread)},renderFilterOptions:function(z,y){if(z.ownerOrParticipant){y.addClass("sv-my-event")}if(z.isTask){y.addClass("sv-event-task")}else{y.addClass("sv-event")}},filterEvent:function(B,z){var A=p.mine,C=p.type==="all"||p.type==="tasks",y=p.type==="all"||p.type==="events";if(B.isTask){z.toggleClass("sv-hidden",!C)}else{z.toggleClass("sv-hidden",!y)}if(!B.ownerOrParticipant&&A){z.addClass("sv-hidden")}},renderColor:function(z,y){if(z.isTask){y.css({"background-color":this.options.eventTaskColor,"border-color":this.options.eventTaskColor});if(g(y)){y.find(".fc-agendalist-title").css("border-left","4px solid "+this.options.eventTaskColor)}}else{y.css({"background-color":this.options.eventColor,"border-color":this.options.eventColor});if(g(y)){y.find(".fc-agendalist-title").css("border-left","4px solid "+this.options.eventColor)}}},renderOwnerIcon:function(z,y){if(z.ownerOrParticipant){if(g(y)){y.find(".fc-agendalist-title").prepend('<i class="halflings-icon user sv-calendar-user-icon"/>')}else{y.find(".fc-event-inner").prepend('<i class="halflings-icon white user sv-calendar-user-icon"/>')}}},renderHover:function(z,y){if(z.editable){y.find(".fc-event-title").addClass("sv-event-title-owner")}},renderTime:function(C,B){var A=B.find(".fc-event-time");if(!C.allDay){var z=u(C.start).format("LT"),y=u(C.end).format("LT");A.html(z+" - "+y);A.append("<br />")}},renderSelectionFilter:function(y){y.append(this.selectionFilterContent);y.on("click","[data-fn-filter-mine]",this.toggleOnlyMyEventsAndTasks);y.on("click","[data-fn-filter]",this.setFilter)},setFilter:function(B){var y=h(B.currentTarget),A=y.closest(".dropdown-menu"),C=y.data("fn-action"),z=A.find("[data-fn-action="+p.type+"]");if(p.type===C){return}p.type=C;this.selectFilterValue(z,false);this.selectFilterValue(y,true);this.doFiltering();A.closest(".btn-group").removeClass("open");return false},selectFilterValue:function(z,y){z.find("i").toggleClass("sv-empty-icon",!y);z.find("i").toggleClass("halflings-icon ok",y)},doFiltering:function(){var z=p.mine,A=p.type==="all"||p.type==="tasks",y=p.type==="all"||p.type==="events";this.$el.find(".sv-event").each(function(){var B=h(this),C=B.hasClass("sv-my-event");B.toggleClass("sv-hidden",!y);if(z){if(!C){B.addClass("sv-hidden")}}});this.$el.find(".sv-event-task").each(function(){var B=h(this),C=B.hasClass("sv-my-event");B.toggleClass("sv-hidden",!A);if(z){if(!C){B.addClass("sv-hidden")}}})},toggleOnlyMyEventsAndTasks:function(B){var y=h(B.currentTarget),A=y.closest(".dropdown-menu"),z=y.contents().last()[0];p.mine=!p.mine;if(p.mine){if(z.textContent){z.textContent=o("filterMine")}else{z.nodeValue=o("filterMine")}}else{if(z.textContent){z.textContent=o("filterAll")}else{z.nodeValue=o("filterAll")}}this.doFiltering();A.closest(".btn-group").removeClass("open");return false}});function g(y){if(y.hasClass("fc-agendalist-day-item")){return true}return false}function f(y){return u(y).valueOf()}h(".sv-calendar-portlet").each(function(){var F=h(this),G=n.getObjectId(F.attr("id")),E=F.find(".sv-fn-calendar"),z=E.data("text-classname"),H=E.data("event-color"),D=E.data("event-task-color"),A=E.data("js-namespace"),B=E.data("editable"),C=E.data("user");var y=new q(s[A]||[],{portletId:G});new d({el:E,collection:y,portletId:G,textClassName:z,eventColor:H,eventTaskColor:D,$portlet:F,editable:B,user:C}).render()})}());(function(){var g=window.$svjq,k=window.sv,j=k.ObjectUtil,a=k.PortletUtil,c=k.KeyUtil,h=c.KEY,l={},e,i=window._,d={success:function(){},selected:function(){},placeholder:"",hitTemplate:i.template('<li data-fn-user-identity="<%= id %>" class="sv-clearfix">   <img class="sv-contact-img sv-buddy-icon" src="<%= iconURL %>" />   <% if (typeof(isContact) !== \'undefined\' && isContact) { %><div style="float:right"><i class="halflings-icon ok"></i></div><% } %>   <div class="sv-social-contactsearch-user-container">     <h3 class="sv-social-contactsearch-name <%= nameFont%>"><%= name %></h3>     <ul class="sv-social-contactsearch-userfield">     <% _.each(userfields, function(field) { %>     <li class="sv-social-contactsearch-userfield <%= fieldFont%>">        <%= field.value %>     </li>     <% }); %>   </div></li>')};var b=g("[data-fn-contactsearch]");var m=function(n,o){var p;if(!o&&l[n]){return l[n]}p=k.i18n.getText("portlet.social.contactsearch.contactsearch",n,o);if(!o){l[n]=p}return p};var f=function(v){var y=g.extend({},d,v),p=g(y.target),r=0;var t=p.closest(".sv-contactsearch-portlet");var o=p.data("fn-profile-page-max-items");var w=t.find(".sv-social-contactsearch-result");var u=v.portletId;var s=function(z){if(z&&!g(z.target).is(".sv-social-contactsearch-form *")){p.removeAttr("sv-fn-has-selected");w.hide()}else{if(z===undefined){p.removeAttr("sv-fn-has-selected");w.hide()}}};g("body").bind("click",s);var n=a.getPortletResourceUri(u,"query");var q=w.find(".sv-user-search-list"),x=[];p.keydown(function(B){var A=c.getKeyCodeFromEvent(B),z;if(A===h.DOWN){p.attr("sv-fn-has-selected",true);r++;if((y.searchUrl&&r>x.length)||(!y.searchUrl&&r>x.length-1)){r=0}q.children().removeClass("active");z=q.children().eq(r);if(!z.hasClass("sv-contactsearch-nohits")){z.addClass("active")}return false}else{if(A===h.UP){p.attr("sv-fn-has-selected",true);r--;if(r<0){r=y.searchUrl?x.length:x.length-1}q.children().removeClass("active");z=q.children().eq(r);if(!z.hasClass("sv-contactsearch-nohits")){z.addClass("active")}return false}}}).keyup(function(B){var A=c.getKeyCodeFromEvent(B);if(A===h.ESC){s();return false}else{if(A===h.RETURN){if(r===x.length){location.href=q.children().eq(r).find("a").attr("href");return false}else{if(typeof(x[r])!=="undefined"){y.selected&&y.selected.call(this,x[r]);return false}}}else{if(c.isNonTextModifiableKeyCode(A)){return false}else{var z=this;e&&clearTimeout(e);e=setTimeout(function(){r=-1;q.empty();var C=g(z).val();if(C!==""){g.ajax({url:n,data:{term:C}}).done(function(G){if(G.queryString===g(z).val()){x=G.hits;g(".popover").remove();w.show();w.position({my:"left top",at:"left bottom",of:p,offset:"0 1",collision:"fit"});r=-1;q.empty();g.each(x,function(H,K){var I=p.data("fn-namefontclass");var L=p.data("fn-fieldfontclass");g.extend(K,{nameFont:I,fieldFont:L});var J=g(y.hitTemplate(K));q.append(J);J.click(function(){y.selected&&y.selected.call(z,K);return false}).mouseenter(function(){q.children().removeClass("active");r=H;g(this).addClass("active")})});if(y.searchUrl&&x.length>0){var F;var D=y.searchUrl+"?query="+C;if(y.selectedIdentity){D=D+"&identity="+y.selectedIdentity}if(x.length===o){F=g('<li class="sv-showmore"><a class="'+p.data("fn-fieldfontclass")+'"href="'+D+'">'+m("showAll")+"</a></li>")}else{F=g('<li class="sv-showmore"><a class="'+p.data("fn-fieldfontclass")+'" href="'+D+'">'+m("showList")+"</a></li>")}F.click(function(){location.href=D});F.appendTo(q).mouseenter(function(){q.children().removeClass("active");r=x.length;g(this).addClass("active")})}else{if(x.length===0){var E=g('<li class="sv-contactsearch-nohits"><span class="'+p.data("fn-fieldfontclass")+'">'+m("noHits")+"</span></li>");q.append(E);E.appendTo(q).mouseenter(function(){q.children().removeClass("active")})}}y.success&&y.success.call(z,x)}})}else{s()}},200)}}}})};b.each(function(){var q=g(".sv-contactsearch-portlet");var o=j.getObjectId(q.attr("id"));var s=g(this),r=s.data("fn-result-page-url"),p=s.data("fn-profile-page-url"),n=s.data("selected-identity");s.closest("form").submit(function(t){if(!s.is("[sv-fn-has-selected]")){t.preventDefault();location.href=r+"?query="+s.val()}else{t.preventDefault()}});f({target:s,profilePageURL:p,searchUrl:r,portletId:o,selectedIdentity:n,selected:function(u){var v=g(this).data("fn-user-identity");if(v===undefined){v=u.id}var t=p+"?identity="+v;location.href=t}})})}());(function(){var e=window.$svjq,b=window.sv,h=b.PortletUtil,g=b.ObjectUtil,c=b.KeyUtil,f=e(".sv-contactsearchall-portlet");f.each(function(){var q=e(this),A=q.find("[data-fn-search-form]"),t=q.find("[data-fn-search-field]"),v=q.find("[data-fn-no-result-container]"),z=q.find("[data-fn-search-result-container]"),r=q.find("[data-fn-load-more-container]"),w=A.data("search-mode"),o=v.length>0,y=g.getObjectId(q.attr("id")),n=h.getTemplate(q,"social-entry"),x=h.getTemplate(q,"social-entry-connected"),j=h.getTemplate(q,"more-hits"),B,m,s,u,k,p,l,i="/"+b.PageContext.pageId+"/"+y+".xml?state=",C;if(w==="group"){m=A.attr("data-group-id");s=q.find("[data-select-all-container]");u=q.find("[data-add-members-container]");k=i+"ajaxAddMembers&group="+m+"&identitiesParam=";l=i+"ajaxQuery&group="+m+"&query=";a(s,z,u)}else{p=i+"ajaxAddContact&identitiesParam=";l=i+"ajaxQuery&query="}if(o){B=h.getTemplate(q,"error")}t.attr("autocomplete","off");A.submit(function(){return false});t.keyup(function(E){var D=c.getKeyCodeFromEvent(E);if(c.isNonTextModifiableKeyCode(D)){return false}C&&clearTimeout(C);C=setTimeout(function(){var H=t.val(),F=H.length;if(o){v.empty()}if(F===0||H==="*"||H==="+"||H==="-"){z.empty();r.empty();if(w==="group"){a(s,z,u)}}else{var I=encodeURIComponent(H);var G=l+I;e.ajax({dataType:"json",url:G,success:function(J){if(J.queryString===t.val()||J.queryString===encodeURIComponent(t.val())){z.empty();r.empty();if(J.hits){e.each(J.hits,function(K,L){z.append(n(L))});if(J.hasMoreHits){r.append(j(J))}}else{if(o&&J.message){v.empty().append(B(J))}}if(w==="group"){a(s,z,u)}}}})}},200);return false});r.on("click","[data-fn-load-more]",function(){var G=e(this),E=t.val(),D=G.attr("data-next-hit"),F=l+encodeURIComponent(E)+"&startAtHit="+D;G.attr("disabled","disabled");e.ajax({dataType:"json",url:F,success:function(H){r.empty();if(H.hits){e.each(H.hits,function(I,J){z.append(n(J))});if(H.hasMoreHits){r.append(j(H))}}else{if(o&&H.message){v.empty().append(B(H))}}if(w==="group"){a(s,z,u)}}})});if(w==="contact"){z.on("click","[data-fn-add-contact]",function(){var F=e(this),D=F.data("contact-id"),E=p+D;F.attr("disabled","disabled");e.ajax({dataType:"json",url:E,success:function(H){var G;if(H.added){G='[data-contact-id="'+H.added+'"]';e(G).closest(".sv-function-container").html(x(H))}}})})}else{if(w==="group"){s.on("click","[data-fn-select-all]",function(){var E=e(this),D=E.attr("data-toggle-status");z.find("[data-fn-select-member]").each(function(){var F=e(this);if(D==="off"){F.removeAttr("checked")}else{F.attr("checked","checked")}});a(s,z,u)});z.on("change","[data-fn-select-member]",function(){a(s,z,u)});u.on("click","[data-fn-add-members]",function(){var F=e(this),E=z.find("[data-fn-select-member]:checked");if(E.length>0){var D=k;F.attr("disabled","disabled");E.each(function(){var H=e(this),G=H.attr("data-contact-id");if(G){D+=G+"_"}});e.ajax({dataType:"json",url:D,success:function(H){var G;if(H.added){G='[data-contact-id="'+H.added.join('"],[data-contact-id="')+'"]';e(G).closest(".sv-function-container").html(x(H))}a(s,z,u)}})}})}}});function d(n,j){var m=n.data("on-status-text"),l=n.data("off-status-text"),i=n.html(),k;n.attr("data-toggle-status",j);if(j==="on"){if(i.indexOf(m)===-1){k=i.replace(l,m);n.html(k)}}else{if(i.indexOf(l)===-1){k=i.replace(m,l);n.html(k)}}}function a(j,k,n){var l=e(j.find("[data-fn-select-all]")[0]),m=e(n.find("[data-fn-add-members]")[0]),q=k.find("[data-fn-select-member]"),r=k.find("li").length>0,i=q.length>0;if(r){l.removeClass("svhidden");m.removeClass("svhidden");if(i){l.removeAttr("disabled");m.removeAttr("disabled");var o=q.length,p=0;q.each(function(){if(e(this).is(":checked")){p++}});if(p===0){m.attr("disabled","disabled");d(l,"on")}else{if(p===o){d(l,"off")}}}else{d(l,"on");l.attr("disabled","disabled");m.attr("disabled","disabled")}}else{l.addClass("svhidden");m.addClass("svhidden")}}}());(function(){var c=window.$svjq,a=window.sv,f=a.PortletUtil,d=a.ObjectUtil;var b=function(i,k){var j=i.attr("data-contact-id"),g=i.closest(".sv-contactstatus-portlet").attr("id"),h=d.getObjectId(g);f.doGetWithFade("#"+g,"/"+a.PageContext.pageId+"/"+h+".xml?identity="+j+"&contactStatusCommand="+k,function(){if("add"===k||"remove"===k){location.reload()}});return false};var e=c(".sv-contactstatus-portlet");e.on("click",".sv-fn-contactstatus-add",function(){return b(c(this),"add")});e.on("click",".sv-fn-contactstatus-remove",function(){return b(c(this),"remove")});e.on("click",".sv-fn-contactstatus-mute",function(){return b(c(this),"mute")});e.on("click",".sv-fn-contactstatus-unmute",function(){return b(c(this),"unmute")})}());(function(){var m=window.Backbone,o=window.sv,a=o.PortletUtil,p=o.Events,n=o.ObjectUtil,b=o.ErrorUtil,g=window.$svjq,f=null,k=function(s,r){return o.i18n.getText("portlet.social.filelist.filelist",s,r)},l=function(s,r){return o.i18n.getText("common",s,r)},e=function(r,s){p.trigger(p.types.notifyUser,{type:"error",heading:s?s:l("error"),message:r});return false};var d=function(w,r,s,u){var t=false;var v=encodeURIComponent(w);g.ajax({type:"GET",url:o.PortletUtil.getPortletResourceUri(u,"verifyUpload")+"&repository="+s+"&name="+v+"&size="+r,async:false,success:function(x){t=x.verified},error:function(x){o.ErrorUtil.handleAjaxFailure(x)}});return t};var j=m.Model.extend({defaults:{name:"",iconURL:"/",url:"/",viewURL:"/"},getViewUrl:function(){return this.get("viewURL")},url:function(){if(this.collection){return this.collection.url()+"&file="+this.get("id")}return"?file="+this.get("id")}});var h=m.Collection.extend({model:j,initialize:function(s,r){this.id=r.id;this.portletId=r.portletId;this.groupId=r.groupId},url:function(){return a.getPortletResourceUri(this.portletId,"files")+"&id="+this.id+(this.groupId?"&group="+this.groupId:"")}});var i=m.View.extend({tagName:"li",className:"sv-clearfix sv-file-listitem",events:{"click [data-fn-destroy]":"destroy",click:"navigate"},initialize:function(){this.bindModelEvents()},bindModelEvents:function(){this.model.on("filter",this.toggleVisible,this)},destroy:function(){this.model.destroy({wait:true,error:function(s,t,r){b.handleBackboneError(s,t,r)}});return false},navigate:function(r){if(!g(r.target).data("fn-download")){window.location.href=this.model.getViewUrl()}return},toggleVisible:function(r){this.$el.toggleClass("sv-hidden",!this.isVisible(r.filter))},isVisible:function(s){var r=this.model.get("name");return !s||(r&&r.toLowerCase().indexOf(s.toLowerCase())!==-1)},render:function(){this.$el.html(this.options.template(this.model.toJSON()));return this}});var c=m.View.extend({events:{"keyup [data-fn-filter]":"setFilter","change [data-fn-filter]":"setFilter","blur [data-fn-filter]":"setFilter"},initialize:function(){this.$list=this.options.list;this.portletId=this.options.portletId;if(this.collection.length>0){this.render()}this.bindCollectionEvents();var r=this;p.on(p.types.groupPageViewed,function(){r.$list.find(".sv-new").removeClass("sv-new")})},bindCollectionEvents:function(){this.collection.on("add",this.prependOne,this)},render:function(){this.clearList();this.collection.each(function(r){this.appendOne(r)},this);p.trigger(p.types.updateRelativeDates,this.$list)},appendOne:function(s){var r=new i({model:s,portletId:this.options.portletId,template:this.options.fileTemplate,editable:this.options.editable});this.$list.append(r.render().el)},prependOne:function(s){var r=new i({model:s,portletId:this.options.portletId,template:this.options.fileTemplate,editable:this.options.editable});this.$list.prepend(r.render().el);p.trigger(p.types.updateRelativeDates,this.$list)},addNewFile:function(r){var s=new j({id:r});this.collection.create(s,{wait:true,silent:true});p.trigger(p.types.updateRelativeDates,this.$list)},clearList:function(){this.$list.empty()},setFilter:function(s){var r=this;if(f!==null){clearTimeout(f);f=null}f=setTimeout(function(){r.collection.fetch({reset:true,data:{term:s.currentTarget.value}}).done(function(){r.render()})},200)}});var q=g(".sv-fileshare-portlet");q.each(function(){var A=g(this),B=n.getObjectId(A.attr("id")),w=A.find("ol"),t=w.data("editable"),G=w.data("template"),v=w.data("repository"),D=w.data("file-repository"),u=w.data("group"),z=a.getModelObjectUri(D,"fileUpload"),s=A.find(".sv-fn-upload"),r=w.data("js-namespace"),E=a.getTemplate(A,G),C=A.find(".sv-fn-upload-progress"),x=null,F=new h(o[r]||[],{id:D,portletId:B,groupId:u}),y=new c({el:A,list:w,collection:F,fileTemplate:E,portletId:B,editable:t});o.Events.on(o.Events.types.fileAdded,function(){y.setFilter.call(y)});o.Events.on("server-file-added-"+D,function(){y.setFilter.call(y)});s.fileupload({dataType:"json",url:z,replaceFileInput:true,formAcceptCharset:"utf-8",submit:function(K,J){var I=J.files[0],H=I.size;if(!H){H=1}if(!d(I.name,H,v,B)){return false}x=setTimeout(function(){C.removeClass("svhidden")},500)},done:function(){y.setFilter.call(y)},fail:function(){return e(k("error-unknown"))},always:function(){if(x!==null){clearTimeout(x)}C.addClass("svhidden")}})})}());(function(){var J=window.Backbone,n=window.sv,F=window.$svjq,g=n.ClientUtil,O=n.ObjectUtil,L,A=n.Events,f=false,aa=function(ag,ah){A.trigger(A.types.notifyUser,{type:"error",heading:ah?ah:X("error"),message:ag});return false};var af=function(ah,ag){F.cookie("sv-fileview-clipboard-items-"+ag,JSON.stringify(ah))};var C=function(ah){var ag=F.cookie("sv-fileview-clipboard-items-"+ah);if(ag){return JSON.parse(ag)}else{return{}}};var Y=function(ah){var ag=C(ah);return !F.isEmptyObject(ag)};var r=function(ag){af({},ag)};var k=function(ag){return ag.find(".sv-file-checkbox:checked").length>0};var i=function(ag){return ag.find(".sv-file-checkbox:checked").length>0};var j=function(ag){return ag.find(".sv-file-checkbox:not(:checked)").length>0};var a=function(ah,ag){return n.i18n.getText("portlet.social.fileview.browse",ah,ag)};var X=function(ah,ag){return n.i18n.getText("common",ah,ag)};var s=function(ag){ag.val("")};var D=function(ag){ag.find("li.active").removeClass("active")};var m=function(ag){return ag.find("a").attr("data-fn-file-tag")};var N=function(ag){return ag.find("a").html()};var Q=function(ai,ah){var ag;ah.find("li").each(function(){var aj=F(this);if(ai===m(aj)){ag=aj;return false}});return ag};var p=function(ag){return ag.hasClass("active")};var H=function(ag){if(ag.hasClass("sv-hidden")){ag.removeClass("sv-hidden")}};var ab=function(ag){if(!ag.hasClass("sv-hidden")){ag.addClass("sv-hidden")}};var B=function(ag,ah){if(ag){H(ah)}else{ab(ah)}};var V=function(ah,ag){ag.find(ah).each(function(){var ai=F(this);ab(ai)})};var o=function(ah,ag){ag.find(ah).each(function(){var ai=F(this);H(ai)})};var M=function(ag,ai){var ah=ai.closest("li");B(ag,ah)};var y=function(ag){V(".sv-fileview-breadcrumb-node",ag)};var c=function(ag){o(".sv-fileview-breadcrumb-node",ag)};var w=function(ag){V(".sv-fileview-breadcrumb-search-result",ag)};var I=function(ag){o(".sv-fileview-breadcrumb-search-result",ag)};var u=function(ag){V(".sv-fileview-breadcrumb-tag",ag)};var ae=function(ag,ai){o(".sv-fileview-breadcrumb-tag",ai);var ah=N(ag);ai.find(".sv-fileview-breadcrumb-tag-name").html("#"+ah)};var Z=function(ag){return ag.addClass("active")};var E=function(ah){var ag=ah.find("li.active:first");if(ag.length===1){return ag}else{return}};var ac=function(ah){var ag=ah.val();return ag!==""&&ag.length>0?ag:undefined};var W=function(ag){ag.collection.fetch({reset:true,wait:true,success:function(){ag.render();v(ag);l(ag);T(ag);z(ag)}})};var T=function(ag){F(ag.getTable()).find(".sv-fileview-tooltip").each(function(){F(this).tooltip()})};var z=function(ah){var ag=C(ah.getRepositoryId());F.each(ag,function(ai){F('input[data-id="'+ai+'"]').prop("checked",true).closest("tr").addClass("sv-cut")})};var l=function(aG){var aB=aG.getTable(),aF=aG.getTagList(),ao=aG.getSearchInputField(),az=aG.getRepositoryId(),ag=aG.getFolderId(),aq=ag!==undefined,ay=ac(ao)!==undefined,at=E(aF)!==undefined,aC=(!ay&&!at),al=(F(aG.getTable()).find(".sv-cut").length>0);var ap=C(az),an=n.CollectionUtil.getKeys(ap),ai=an.length>0,ax=(ag!==undefined&&n.CollectionUtil.contains(ag,an)),aE=k(aB),aD=(ai&&!ax&&!al&&aC),ak=j(aB),av=(aE||aD||ak);M(aE,aB.find("[data-fn-cut]"));M(aD,aB.find("[data-fn-paste]"));M(ak,aB.find("[data-fn-select-all]"));var am=aC,aA=(aq&&aC),ah=(am||aA);B(ah&&av,aB.find(".sv-fileview-menu-group2-separator"));M(am,aB.find("[data-fn-create-folder]"));M(aA,aB.find("[data-fn-rename-folder]"));var au=i(aB),aw=(au&&aC),ar=aw;B(ar&&(av||ah),aB.find(".sv-fileview-menu-group3-separator"));M(aw,aB.find("[data-fn-delete]"));var aj=aB.find(".sv-fileview-dropdown-link");if(av||ah||ar){H(aj)}else{ab(aj)}};var t=function(ag){var ah=F(ag);if(ah.data("size")){return ah.data("size")}else{if(ah.find("time").length>0){return n.DateUtil.fromISO(ah.find("time").attr("datetime")).getTime()}}return ah.text()};var v=function(ah){var aj=ah.getTable(),ai=ah.getEditable(),ak,ag;if(ai){ak={0:{sorter:false}};ag=[[1,0]]}else{ag=[[0,0]]}if(f){aj.trigger("updateAll",[true,function(){}])}else{aj.tablesorter({headers:ak,sortList:ag,textExtraction:function(al){return t(al)}});f=true}};var d=function(ai,ag,ah){n.DialogUtil.showInputDialog(a("createFolderTitle"),a("createFolderMessage"),false,"",function(aj){if(aj.result){var al=aj.text;var ak=new h({name:al});ah.collection.create(ak,{wait:true,success:function(){s(ai);D(ag);W(ah)}})}})};var S=function(ai,ag,ah){F.ajax({type:"PUT",url:n.PortletUtil.getPortletResourceUri(ah,"renameFolder")+"&folder="+ag+"&folderName="+ai,success:function(){n.WindowLocationUtil.reloadPage()},error:function(aj){n.ErrorUtil.handleAjaxFailure(aj)}})};var ad=function(ag){return ag.data("id")};var U=function(ag){return ag.data("name")};var G=function(ai,ah){var ag={};ai.find(".sv-file-checkbox").each(function(){var ak=F(this);var aj=ak.closest("tr");if(ak.prop("checked")){ag[ad(ak)]=U(ak);if(!aj.hasClass("sv.cut")){aj.addClass("sv-cut")}}else{if(aj.hasClass("sv-cut")){aj.removeClass("sv-cut")}}});af(ag,ah)};var P=function(ah,ak,al,aj){var ai=C(ak);var ag=n.CollectionUtil.getKeys(ai);if(ag.length>0){var am=(ag.length===1?a("moveNodeSingleMessage",ai[ag[0]]):a("moveNodeMultiMessage",ag.length));n.DialogUtil.showConfirmDialog(a("moveNodeTitle"),am,function(an){if(an){F.ajax({type:"POST",data:{folder:ah,repository:ak,node:ag},url:n.PortletUtil.getPortletResourceUri(al,"moveNode"),success:function(){r(ak);W(aj)},error:function(ao){n.ErrorUtil.handleAjaxFailure(ao)}})}})}};var b=function(ak,ah,am,ao){var an=C(ah);var ag=[];var aj=[];var ai=[];ak.find(".sv-file-checkbox:checked").each(function(){var ap=F(this);var aq=ad(ap);aj.push(aq);ai.push(U(ap));if(an[aq]!==undefined){ag.push(aq)}});if(aj.length>0){var al=(aj.length===1?a("deleteNodeSingleMessage",ai[0]):a("deleteNodeMultiMessage",aj.length));n.DialogUtil.showConfirmDialog(a("deleteNodeTitle"),al,function(ap){if(ap){F.ajax({type:"DELETE",url:n.PortletUtil.getPortletResourceUri(am,"list")+"&repository="+ah+"&nodes="+aj.join(","),success:function(){if(ag.length>0){var aq=n.CollectionUtil.removeAll(an,ag);af(aq,ah)}W(ao)},error:function(aq){n.ErrorUtil.handleAjaxFailure(aq)}})}})}};var K=function(an,ag,ah,aj,al){var ak=false;var ai="";var am=encodeURIComponent(an);if(ah!==undefined){ai="&folder="+ah}F.ajax({type:"GET",url:n.PortletUtil.getPortletResourceUri(al,"verifyUpload")+ai+"&repository="+aj+"&name="+am+"&size="+ag,async:false,success:function(ao){ak=ao.verified},error:function(ao){n.ErrorUtil.handleAjaxFailure(ao)}});return ak};var h=J.Model.extend({defaults:{name:"",iconURL:"/",url:"/",viewURL:"/"},getViewUrl:function(){return this.get("viewURL")},url:function(){if(this.collection){var ag=this.get("id");if(ag){return this.collection.url()+"&file="+ag}else{return this.collection.url()}}return"?fileId="+this.get("id")}});var e=J.Collection.extend({model:h,initialize:function(ah,ag){this.id=ag.id;this.portletId=ag.portletId;this.searchInputField=ag.searchInputField;this.folderId=ag.folderId;this.tagList=ag.tagList;this.table=ag.table;this.breadcrumbList=ag.breadcrumbList;this.fileUploadButton=ag.fileUploadButton},url:function(){var aj=ac(this.searchInputField);var ah=E(this.tagList);var ai="";if(this.folderId!==undefined){ai="&folder="+this.folderId}if(ah!==undefined){var ak=m(ah);ab(this.fileUploadButton);y(this.breadcrumbList);w(this.breadcrumbList);ae(ah,this.breadcrumbList);n.WindowLocationUtil.setHashValue("tag",ak);return n.PortletUtil.getPortletResourceUri(this.portletId,"tagSearch")+ai+"&tag="+ak}else{if(aj!==undefined){ab(this.fileUploadButton);y(this.breadcrumbList);u(this.breadcrumbList);I(this.breadcrumbList);var ag=encodeURIComponent(aj);n.WindowLocationUtil.setHashValue("term",ag);return n.PortletUtil.getPortletResourceUri(this.portletId,"search")+ai+"&term="+ag}else{H(this.fileUploadButton);w(this.breadcrumbList);u(this.breadcrumbList);c(this.breadcrumbList);n.WindowLocationUtil.clearHashValue();return n.PortletUtil.getPortletResourceUri(this.portletId,"list")+ai}}}});var q=J.View.extend({tagName:"tr",className:"",events:{"click [data-fn-destroy]":"destroy"},destroy:function(){this.model.destroy({wait:true});return false},navigate:function(){window.location.href=this.model.getViewUrl();return},render:function(){this.$el.html(this.options.template(this.model.toJSON()));return this}});var R=J.View.extend({events:{"keyup [data-fn-search-filter]":"setSearchFilter","click [data-fn-file-tag]":"setTagFilter"},initialize:function(){this.$list=this.options.list;this.portletId=this.options.portletId;this.searchInputField=this.options.searchInputField;this.tagList=this.options.tagList;this.table=this.options.table;this.editable=this.options.editable;if(this.collection.length>0){this.render()}this.collection.on("add",this.prependOne,this)},getTable:function(){return this.table},getSearchInputField:function(){return this.searchInputField},getTagList:function(){return this.tagList},getRepositoryId:function(){return this.table.data("repository")},getFolderId:function(){return this.table.data("folder")},getEditable:function(){return this.editable},render:function(){this.clearList();this.collection.each(function(ag){this.appendOne(ag)},this);A.trigger(A.types.updateRelativeDates,this.$list)},appendOne:function(ah){var ag=new q({model:ah,portletId:this.options.portletId,template:this.options.fileTemplate,editable:this.options.editable,table:this.options.table});this.$list.append(ag.render().el)},prependOne:function(ah){var ag=new q({model:ah,portletId:this.options.portletId,template:this.options.fileTemplate,editable:this.options.editable});this.$list.prepend(ag.render().el);A.trigger(A.types.updateRelativeDates,this.$list)},clearList:function(){this.$list.empty()},filterOne:function(ag,ah){ag.trigger("filter",{filter:ah})},filterAll:function(ag){this.collection.each(function(ah){this.filterOne(ah,ag)},this)},setTagFilter:function(ai){var ag=F(ai.currentTarget).closest("li");var aj=p(ag);s(this.searchInputField);D(this.tagList);if(!aj){Z(ag)}var ah=this;W(ah);return false},setSearchFilter:function(){var ag=this;if(L!==undefined){clearTimeout(L)}D(this.tagList);L=setTimeout(function(){W(ag)},200)}});var x=F(".sv-fileshareall-portlet");x.each(function(){var an=F(this),ay=O.getObjectId(an.attr("id")),aB=an.find("table.sv-file-list"),az=aB.data("repository"),am=an.find(".sv-search-filter-field"),aD=an.find(".sv-filebrowse-taglist"),ao=an.find(".sv-breadcrumb"),aw=aB.data("editable"),ag=(aB.data("folder")!==""?aB.data("folder"):undefined),al=aB.data("template"),at=aB.data("container"),ah=n.PortletUtil.getModelObjectUri(at,"fileUpload"),aq=an.find(".sv-fileview-upload-form"),av=aq.find(".sv-fileview-upload-button"),aj=an.find(".sv-fileview-upload-progress"),ak=null,ap=aB.data("js-namespace"),aC=n.PortletUtil.getTemplate(an,al),aA=new e(n[ap+"_files"]||[],{id:at,portletId:ay,folderId:ag,searchInputField:am,tagList:aD,table:aB,breadcrumbList:ao,fileUploadButton:av}),ai=new R({el:an,list:aB.find("tbody"),collection:aA,fileTemplate:aC,portletId:ay,editable:aw,searchInputField:am,table:aB,tagList:aD});if(!g.supportsPlaceholder){an.find(".sv-search-filter-label").removeClass("sv-hidden")}if(aA.length>0){v(ai)}if(n.WindowLocationUtil.hasHashValue()){var au=n.WindowLocationUtil.getHashValue("term");var ax=n.WindowLocationUtil.getHashValue("tag");if(au!==undefined){var ar=decodeURIComponent(au);if(ar.length>0){am.val(ar);am.focus();W(ai)}}else{if(ax!==undefined){var aE=Q(ax,aD);if(aE!==undefined){Z(aE);W(ai)}}}}if(aw){if(Y(az)){z(ai)}an.on("click","[data-fn-cut]",function(){G(aB,az)});an.on("click","[data-fn-paste]",function(){P(at,az,ay,ai)});an.on("click","[data-fn-select-all]",function(){F(".sv-file-checkbox").prop("checked",true)});an.on("click","[data-fn-create-folder]",function(){d(am,aD,ai)});an.on("click","[data-fn-rename-folder]",function(){var aF=F(this);n.DialogUtil.showInputDialog(a("renameFolderTitle"),a("renameFolderMessage"),false,aF.data("name"),function(aG){if(aG.result){S(aG.text,ag,ay)}})});an.on("click","[data-fn-delete]",function(){b(aB,az,ay,ai)});an.on("click",".sv-fileview-dropdown-link",function(){l(ai)});an.on("click",".sv-file-checkbox",function(){if(F(this).closest(".sv-cut").length>0){F(this).closest(".sv-cut").removeClass("sv-cut");G(aB,az)}})}n.Events.on(n.Events.types.fileAdded,function(){ai.setSearchFilter.call(ai)});aq.fileupload({dataType:"json",url:ah,replaceFileInput:true,formAcceptCharset:"utf-8",submit:function(aI,aH){var aG=aH.files[0],aF=aG.size;if(!aF){aF=1}if(!K(aG.name,aF,ag,az,ay)){return false}ak=setTimeout(function(){H(aj)},500)},done:function(){D(aD);s(am);W(ai)},fail:function(){return aa(X("error-unknown"))},always:function(){if(ak!==null){clearTimeout(ak)}ab(aj)}})})}());(function(){var p=window.sv,j=p.PortletUtil,l=p.ObjectUtil,a=p.Events,k=p.KeyUtil,c=k.KEY,f=window.$svjq,b=window.Backbone,m={},e,g;var n=function(s,t){var u;if(!t&&m[s]){return m[s]}u=p.i18n.getText("portlet.social.fileview.file",s,t);if(!t){m[s]=u}return u};var d=function(s,t){s.find("a[data-user-identity]").each(function(){var u=f(this);u.attr("href",t+"?identity="+u.data("user-identity"))})};var r=function(s,t){s.find("a[data-social-tag-id]").each(function(){var u=f(this);u.attr("href",t+"?tag="+u.data("social-tag-name"))})};var o=b.Model.extend({url:function(){if(this.collection){return this.collection.url()+"&commentId="+this.get("id")}return"?commentId="+this.get("id")}});var i=b.Collection.extend({model:o,initialize:function(t,s){this.options=s},url:function(){return j.getPortletResourceUri(this.options.portletId,"comment")+"&file="+this.options.id}});var h=b.View.extend({tagName:"li",className:"sv-file-comment",events:{"click [data-fn-destroy-comment]":"showDestroyDialog"},initialize:function(){this.model.on("destroy",this.remove,this)},showDestroyDialog:function(){var s=this;p.DialogUtil.showConfirmDialog(n("removeCommentTitle"),n("removeCommentBody"),function(t){if(t){s.model.destroy({wait:true})}});return false},render:function(){this.$el.html(this.options.template(this.model.toJSON()));d(this.$el,this.options.profilePageURL);r(this.$el,this.options.tagResultPageURL);return this}});var q=b.View.extend({initialize:function(){this.$list=this.$el.find("[data-fn-comments]");this.collection.on("add",this.addNewComment,this);this.collection.on("add",this.updateCommentCount,this);this.collection.on("destroy",this.updateCommentCount,this);this.getTextField().triggeredInput({triggers:{"@":{source:j.getUtilityApiUri("socialsearchutil","contacts"),searchKey:"term",allowWhiteSpace:true,parse:function(s){return s.hits}}},minLength:2,replacer:function(s){return s.trigger+'{"value":"'+s.name+'","id":"'+s.id+'"}'}}).elastic();this.getTextField().css("height","20px");if(this.collection.length>0){this.render()}},render:function(){this.clearList();this.collection.each(function(s){this.appendOne(s)},this);a.trigger(a.types.updateRelativeDates,this.$el);a.trigger(a.types.updateLikables,this.$el)},clearList:function(){this.$list.empty()},updateCommentCount:function(){var s=this.$el.find("[data-fn-message-comment-count]");s.text(this.collection.length)},appendOne:function(x){var t=new h({model:x,template:this.options.commentTemplate,profilePageURL:this.options.profilePageURL,tagResultPageURL:this.options.tagResultPageURL});var w=t.render().$el;var s=w.find(".sv-message-content");var v=s.find(".sv-truncate-more"),u;if(v.length>0){this.addShowMoreLink(v);u=true}this.$list.append(w);if(u){this.bindShowMoreEvents(w)}},bindShowMoreEvents:function(u){var t={moreText:n("showMore"),lessText:n("showLess")};var w=f(".sv-truncate-more-link",u),v=f(".sv-truncate-more",u),s=f(".sv-truncate-ellipsis",u);w.on("click",function(x){x.preventDefault();if(w.text()===t.moreText){v.show();w.text(t.lessText);s.css("display","none")}else{v.hide();w.text(t.moreText);s.css("display","inline")}})},addShowMoreLink:function(s){f('<span class="sv-truncate-ellipsis">...</span>').insertBefore(s);f('<div><a href="#" class="sv-truncate-more-link">'+n("showMore")+"</a></div>").insertAfter(s);s.css("display","none")},addNewComment:function(s){this.appendOne(s);a.trigger(a.types.updateRelativeDates,this.$el);a.trigger(a.types.updateLikables,this.$el)},getLoader:function(){if(!this.$loader){this.$loader=f('<img src="/sitevision/util/images/loading_16_grey.gif" />').css("vertical-align","middle").appendTo(this.$el.find("[data-fn-comment-input]").parent())}return this.$loader},countdownCharactersLeft:function(u){var s=f(u.currentTarget),v=s.val(),t=g-v.length,w=this.$el.find("[data-fn-comment-input-size]");if(t<0){w.addClass("sv-character-limit-exceeded")}else{w.removeClass("sv-character-limit-exceeded")}w.text(t);if(v!==""&&t>=0&&!this.activeConnection){this.getSubmitButton().removeClass("disabled").removeAttr("disabled")}else{this.getSubmitButton().addClass("disabled").attr("disabled","disabled")}},getSubmitButton:function(){if(!this.$submitButton){this.$submitButton=this.$el.find("[data-fn-comment-submit]")}return this.$submitButton},getTextField:function(){if(!this.$textField){this.$textField=this.$el.find("[data-fn-comment-input]")}return this.$textField},getSubmitControls:function(){if(!this.$submitControls){this.$submitControls=this.$el.find(".sv-submit-controls")}return this.$submitControls},events:{"click [data-fn-share]":"shareEntry","keyup [data-fn-comment-input]":"countdownCharactersLeft","click [data-fn-comment-submit]":"postComment","keydown [data-fn-comment-input]":"expandTextfield"},checkKeyDown:function(t){var s=k.getKeyCodeFromEvent(t);if(s===c.RETURN&&t.ctrlKey){this.postComment(t)}},expandTextfield:function(s){f(s.currentTarget).addClass("sv-comment-input-expanded");this.getSubmitControls().show();this.countdownCharactersLeft(s);this.checkKeyDown(s)},postComment:function(w){var t=this,v,x,s,u;w.preventDefault();if(this.activeConnection){return false}v=this.getTextField();s=v.val().length;if(s>0&&s<=g){this.activeConnection=true;x=new o({comment:v.triggeredInput("getRichContent")});u=setTimeout(function(){t.getLoader().show()},400);this.collection.create(x,{wait:true,success:function(){v.val("").focus().css("height","20px");t.activeConnection=false;t.getLoader().hide();clearTimeout(u);t.getSubmitControls().hide()},error:function(){t.activeConnection=false;t.getLoader().hide();clearTimeout(u)}})}else{if(s>g){a.trigger(a.types.notifyUser,{type:"default",heading:n("commentToLongHeading"),message:n("commentToLongBody"),"transient":true})}}return false},shareEntry:function(){var w=this,u=f("<div/>").addClass("sv-timelineentry-portlet"),z=f("<div/>").addClass("sv-timline"),A=f("<blockquote/>").addClass("sv-clearfix sv-timeline-entry").css({margin:"1em 0",padding:"0",border:"none"}),v;var t=this.$el.find("[data-fn-shared-entry]");if(t.length>0){v=t}else{v=this.$el}A.append(v.find("a").first().clone()).append(v.find("h3,h4").first().clone().css("margin","0")).append(v.find("p").first().clone());A.find("img").css({"margin-right":"1em",width:"48px"});z.append(A);u.append(z);var y=f("<label/>").attr("for","sharecomment").text(n("shareComment"));u.append(y);var s=f("<textarea/>").attr("id","sharecomment").addClass("sv-timeline-input sv-border-box").css("width","100%");u.append(s);var x=[{text:n("share"),callback:function(){f.ajax({type:"POST",dataType:"JSON",url:j.getPortletResourceUri(w.options.portletId,"shareTimelineEntry"),data:{message:s.val(),entry:t.length>0?t.data("entry-id"):this.collection.options.id},success:function(){a.trigger(a.types.notifyUser,{type:"success",heading:n("sharedMessageTitle"),message:n("sharedMessageContent")})}})}}];p.DialogUtil.showDialog({title:n("shareEntry"),body:u,buttons:x});return false}});f(".sv-fileshareall-portlet").each(function(){var y=f(this),v=y.find("[data-fn-file-entry]");if(v.length===0){return}var z=l.getObjectId(y.attr("id")),u=v.data("js-comments-namespace"),w=v.data("file-id"),s=v.data("profilepageurl"),A=v.data("tagresultpageurl"),x=new i(p[u].comments||[],{id:w,portletId:z}),t;g=p[u].maxCharacterCount;new q({el:y,collection:x,commentTemplate:j.getTemplate(y,"file-comment"),portletId:z,profilePageURL:s,tagResultPageURL:A});e=v.data("user-identity");t=y.find(".sv-file-comments");if(t.length>0){d(t,s);r(t,A)}})}());(function(){var sv=window.sv,portletUtil=sv.PortletUtil,objectUtil=sv.ObjectUtil,events=sv.Events,$=window.$svjq,OfficeOpen=window.OfficeOpen,log=sv.Log,i18cache={};var i18n=function(selector,args){var translated;if(!args&&i18cache[selector]){return i18cache[selector]}translated=sv.i18n.getText("portlet.social.fileview.file",selector,args);if(!args){i18cache[selector]=translated}return translated};var i18nCommon=function(key,args){return sv.i18n.getText("common",key,args)};var handleError=function(message,heading){events.trigger(events.types.notifyUser,{type:"error",heading:heading?heading:i18nCommon("error"),message:message});return false};var split=function(val){return val.split(/,\s*/)};var isFileEditable=function(filename){var ext=filename.substring(filename.lastIndexOf(".")+1).toLowerCase(),openofficeTypes="sxd;sxm;sxi;sxc;sxw;odb;odf;odt;ott;oth;and;odm;stw;sxg ;doc;dot;docx;docm;dotx;dotm;wpd;wps;sdw;sgl;vor;uot;uof;jtd;jtt;hwp;602;pdb;psw;ods;ots;stc;xls;xlw;xlt;xlsx;xlsm;xltx;xltm;xlsb;wks;sdc;dbf;slk;uos;pxl;odp;odg;std;otp;otg;sti;ppt;pps;pot;pptx;pptm;potx;potm;ppsx;sda;sdd;sdp",msOfficeTypes="pot,potm,potx,ppa,ppam,pps,ppsm,ppsx,ppt,pptm,pptx,pptx,xla,xlam,xls,xlsb,xlsm,xlsx,xlt,xltm,xltx,xlw,doc,docm,docx,dot,dotm,dotx";log.info(this,"ms office plugin: "+isMSPluginInstalled()+" type: "+(msOfficeTypes.split(",").indexOf(ext)>=0));if(msOfficeTypes.split(",").indexOf(ext)>=0&&isMSPluginInstalled()){return true}if(openofficeTypes.split(";").indexOf(ext)>=0){return true}return false};var getOfficePlugin=function(){if(window.ActiveXObject||"ActiveXObject" in window){var sharePointControl;for(var i=5;i>0;i--){try{sharePointControl=new ActiveXObject("SharePoint.OpenDocuments."+i);break}catch(e){}}return sharePointControl}else{var plugin=document.getElementById("sv-sharePointPlugin");if(plugin===null){if(navigator.mimeTypes["application/x-sharepoint"]){var pluginObject=document.createElement("object");pluginObject.id="sv-sharePointPlugin";pluginObject.type="application/x-sharepoint";pluginObject.width=0;pluginObject.height=0;pluginObject.style.setProperty("visibility","hidden","");document.body.appendChild(pluginObject)}plugin=document.getElementById("sv-sharePointPlugin")}return plugin}return null};var isMSPluginInstalled=function(){return getOfficePlugin()!==null};var openDocument=function(e,webdavUrl){if(e.shiftKey){if(sv.ClientUtil.isJavaInstalled){OfficeOpen.OpenFileWith(webdavUrl,1)}else{location.href=webdavUrl}return true}var plugin=getOfficePlugin();if(plugin!==null){try{plugin.EditDocument(webdavUrl);return true}catch(error){}}if(sv.ClientUtil.isJavaInstalled){OfficeOpen.OpenFileWith(webdavUrl,1)}else{location.href=webdavUrl}return false};var createDocument=function(templateUrl,folderUrl){var plugin=getOfficePlugin();if(plugin!==null){try{plugin.CreateNewDocument(templateUrl,folderUrl);return true}catch(e){}}return false};var verifyFileUpload=function(aName,aSize,aFileId,aPortletId){var verified=false;$.ajax({type:"GET",url:sv.PortletUtil.getPortletResourceUri(aPortletId,"verifyUploadVersion")+"&file="+aFileId+"&name="+aName+"&size="+aSize,async:false,success:function(aResponse){verified=aResponse.verified},error:function(aResponse){sv.ErrorUtil.handleAjaxFailure(aResponse)}});return verified};var lockfile=function($portlet,fileId,callback){$.ajax({type:"POST",dataType:"JSON",data:{file:fileId},url:sv.PortletUtil.getPortletResourceUri(objectUtil.getObjectId($portlet.attr("id")),"lockFile"),success:function(aResponse){if(aResponse.wasLocked){events.trigger(events.types.notifyUser,{type:"success",message:i18n("lockMessage",aResponse.lockInfo.displayName),timer:5});$portlet.find(".sv-lockinfo-container").html(portletUtil.getTemplate($portlet,"lockinfo")(aResponse.lockInfo));$portlet.find("[data-fn-fileshare-unlock]").removeClass("sv-hidden");$portlet.find("[data-fn-fileshare-lock]").addClass("sv-hidden")}else{events.trigger(events.types.notifyUser,{type:"error",message:i18n("lockErrorMessage",aResponse.lockInfo.displayName),timer:5})}callback&&callback.call(this,aResponse)},error:function(aResponse){sv.ErrorUtil.handleAjaxFailure(aResponse)}})};var unlockfile=function($portlet,fileId){$.ajax({type:"POST",dataType:"JSON",data:{file:fileId},url:sv.PortletUtil.getPortletResourceUri(objectUtil.getObjectId($portlet.attr("id")),"unlockFile"),success:function(aResponse){if(aResponse.wasUnlocked){events.trigger(events.types.notifyUser,{type:"success",message:i18n("unLockMessage"),timer:5});$portlet.find(".sv-lockinfo-container").empty();$portlet.find("[data-fn-fileshare-unlock]").addClass("sv-hidden");$portlet.find("[data-fn-fileshare-lock]").removeClass("sv-hidden")}else{events.trigger(events.types.notifyUser,{type:"error",message:i18n("unlockErrorMessage",aResponse.lockInfo.displayName),timer:5})}reloadPortlet($portlet)},error:function(aResponse){sv.ErrorUtil.handleAjaxFailure(aResponse)}})};var toggleVersioned=function($portlet,fileId){$.ajax({type:"POST",dataType:"JSON",data:{file:fileId},url:sv.PortletUtil.getPortletResourceUri(objectUtil.getObjectId($portlet.attr("id")),"toggleVersioned"),success:function(data){$portlet.find(".sv-lockinfo-container").empty();if(data.versioned){$portlet.find("[data-fn-fileshare-notversioned]").addClass("sv-hidden");$portlet.find("[data-fn-fileshare-versioned]").removeClass("sv-hidden")}else{$portlet.find("[data-fn-fileshare-versioned]").addClass("sv-hidden");$portlet.find("[data-fn-fileshare-notversioned]").removeClass("sv-hidden")}reloadPortlet($portlet)},error:function(aResponse){sv.ErrorUtil.handleAjaxFailure(aResponse)}})};var deleteFile=function($portlet,fileId){$.ajax({type:"DELETE",dataType:"JSON",url:sv.PortletUtil.getPortletResourceUri(objectUtil.getObjectId($portlet.attr("id")),"delete")+"&file="+fileId,success:function(aResponse){window.location=aResponse.browseParentURL},error:function(aResponse){sv.ErrorUtil.handleAjaxFailure(aResponse)}})};var reloadPortlet=function(){location.reload()};var deleteFileVersion=function($portlet,elem,fileId,uuid){$.ajax({type:"DELETE",dataType:"JSON",url:sv.PortletUtil.getPortletResourceUri(objectUtil.getObjectId($portlet.attr("id")),"deleteVersion")+"&file="+fileId+"&version="+uuid,success:function(){var table=elem.closest("table");elem.remove();var versionCount=table.find("tr[data-uuid]").length;var draftCount=table.find("tr[data-draft-uuid]").length;$("[data-fn-message-version-count]").text(versionCount+draftCount);if(versionCount===1){table.find("[data-fn-fileshare-delete-version-divider],[data-fn-fileshare-delete-version]").hide()}reloadPortlet($portlet)},error:function(aResponse){sv.ErrorUtil.handleAjaxFailure(aResponse)}})};var renameFile=function($portlet,fileId,aNewName){$.ajax({type:"POST",dataType:"JSON",data:{file:fileId,name:aNewName},url:sv.PortletUtil.getPortletResourceUri(objectUtil.getObjectId($portlet.attr("id")),"rename"),success:function(){reloadPortlet($portlet)},error:function(aResponse){sv.ErrorUtil.handleAjaxFailure(aResponse)}})};var toggleSelectedVersion=function($portlet,fileId,uuid){$.ajax({type:"POST",dataType:"JSON",data:{file:fileId,version:uuid},url:sv.PortletUtil.getPortletResourceUri(objectUtil.getObjectId($portlet.attr("id")),"selectVersion"),success:function(){reloadPortlet($portlet)},error:function(aResponse){sv.ErrorUtil.handleAjaxFailure(aResponse)}})};$(".sv-fileshareall-portlet").each(function(){var $portlet=$(this),$fileEntry=$portlet.find("[data-fn-file-entry]");if($fileEntry.length===0){return}var webdavUrl=$fileEntry.data("webdav-url"),downloadUrl=$fileEntry.data("url"),locked=$fileEntry.data("locked"),editable=$fileEntry.data("editable"),selfLocked=$fileEntry.data("self-locked"),lockOverride=$fileEntry.data("lock-override"),modelObjectUrl=portletUtil.getModelObjectUri($fileEntry.data("file-id"),"fileUpdate"),fileUploadElem=$portlet.find(".sv-fn-update"),progressElem=$portlet.find(".sv-fn-upload-progress"),progressTimer=null,displayName=$fileEntry.data("file-name"),tags=$.cookie("sv-tags")?split($.cookie("sv-tags")):[];$.fn.editable.defaults.mode="inline";$('a[data-toggle="tab"]').on("shown",function(e){$.cookie("last_tab",$(e.target).attr("href"))});var lastTab=$.cookie("last_tab");if(lastTab){$("ul.nav-tabs").children().removeClass("active");$("a[href="+lastTab+"]").parents("li:first").addClass("active");$("div.tab-content").children().removeClass("active");$(lastTab).addClass("active")}$(".sv-open-document").click(function(e){if($(this).hasClass("sv-force-download")){location.href=downloadUrl}else{if(!openDocument(e,webdavUrl,displayName)){lockfile($portlet,$fileEntry.data("file-id"))}}return false}).each(function(){if(!isFileEditable(displayName)||(locked&&!selfLocked)){$(this).text(i18n("download")).addClass("sv-force-download")}});if((editable&&(!locked||selfLocked))||lockOverride){if(!locked||selfLocked){$(".sv-metadata-editable-text, .sv-metadata-editable-date").editable({emptytext:i18n("emptyText"),url:sv.PortletUtil.getPortletResourceUri(objectUtil.getObjectId($portlet.attr("id")),"setMetadata"),params:function(params){params.file=$fileEntry.data("file-id");return params}});$(".sv-version-description-editable").each(function(){$(this).editable({emptytext:i18n("emptyDescription"),placement:"right",mode:"popup",url:sv.PortletUtil.getPortletResourceUri(objectUtil.getObjectId($portlet.attr("id")),"setVersionDescription"),params:function(params){params.file=$fileEntry.data("file-id");params.version=$(this).data("pk");return params}})});$(".sv-metadata-editable-select").each(function(){$(this).editable({emptytext:i18n("emptyText"),url:sv.PortletUtil.getPortletResourceUri(objectUtil.getObjectId($portlet.attr("id")),"setMetadata"),source:eval($(this).data("alternatives")),params:function(params){params.file=$fileEntry.data("file-id");return params}})});$(".sv-metadata-editable-tags").editable({inputclass:"input-large",emptytext:i18n("emptyText"),url:sv.PortletUtil.getPortletResourceUri(objectUtil.getObjectId($portlet.attr("id")),"setTags"),select2:{tags:tags,formatNoMatches:function(){return""},tokenSeparators:[","," "],openOnEnter:false},params:function(params){params.file=$fileEntry.data("file-id");return params}}).on("save",function(e,params){var result=$.cookie("sv-tags")?split($.cookie("sv-tags")).concat(params.newValue):params.newValue;var saveItems=[];$.each(result,function(index,item){if($.inArray(item,saveItems)===-1&&item!==""){saveItems.push(item)}});$.cookie("sv-tags",saveItems.join(","),{expires:365,path:"/"})}).on("shown",function(){window.setTimeout(function(){$(".select2-search-field input").focus()},200)});$(".sv-fn-create-word").click(function(){createDocument()});$portlet.find("[data-fn-fileshare-rename]").click(function(){sv.DialogUtil.showInputDialog(i18n("renameFileTitle"),i18n("renameFileMessage"),false,displayName,function(data){if(data.result){renameFile($portlet,$fileEntry.data("file-id"),data.text)}})})}$portlet.find("[data-fn-fileshare-unlock]").click(function(){unlockfile($portlet,$fileEntry.data("file-id"))});$portlet.find("[data-fn-fileshare-lock]").click(function(){lockfile($portlet,$fileEntry.data("file-id"))});if(!locked||selfLocked){$portlet.find("[data-fn-fileshare-versioned],[data-fn-fileshare-notversioned]").click(function(){if($fileEntry.data("versioned")){sv.DialogUtil.showConfirmDialog(i18n("versioning"),i18n("disableVersioning"),function(result){if(result){toggleVersioned($portlet,$fileEntry.data("file-id"))}})}else{toggleVersioned($portlet,$fileEntry.data("file-id"))}});$portlet.find("[data-fn-fileshare-delete-version]").click(function(){var elem=$(this).closest("tr"),uuid=elem.data("uuid");sv.DialogUtil.showConfirmDialog(i18n("remove"),i18n("removeVersion"),function(result){if(result){deleteFileVersion($portlet,elem,$fileEntry.data("file-id"),uuid)}});return false});$portlet.find("[data-fn-fileshare-delete]").click(function(){sv.DialogUtil.showConfirmDialog(i18n("remove"),i18n("removeFile"),function(result){if(result){deleteFile($portlet,$fileEntry.data("file-id"))}})});$portlet.find("[data-fn-fileshare-select]").click(function(){toggleSelectedVersion($portlet,$fileEntry.data("file-id"),$(this).closest("tr").data("uuid"));var deselected=$(this).closest("tr").hasClass("success");$portlet.find("tr.success").removeClass("success");$portlet.find("[data-fn-fileshare-select] i").removeClass("halflings-icon ok").addClass("sv-empty-icon");$portlet.find("i.sv-selection-marker").addClass("sv-empty-icon").removeClass("halflings-icon ok");if(!deselected){$(this).find("i").removeClass("sv-empty-icon").addClass("halflings-icon ok");$(this).closest("tr").find("td i.sv-selection-marker").removeClass("sv-empty-icon").addClass("halflings-icon ok");$(this).closest("tr").addClass("success")}$(this).closest("tr").find(".dropdown-toggle").dropdown("toggle");return false})}}fileUploadElem.fileupload({dataType:"json",url:modelObjectUrl,replaceFileInput:true,formAcceptCharset:"utf-8",submit:function(e,data){var file=data.files[0],fileSize=file.size;if(!fileSize){fileSize=1}if(!verifyFileUpload(file.name,fileSize,$fileEntry.data("file-id"),objectUtil.getObjectId($portlet.attr("id")))){return false}progressTimer=setTimeout(function(){progressElem.removeClass("svhidden")},500)},done:function(){reloadPortlet($portlet)},fail:function(){return handleError(i18n("error-unknown"))},always:function(){if(progressTimer!==null){window.clearTimeout(progressTimer)}progressElem.addClass("svhidden")}})})}());(function(){var e=window.$svjq,i=window.sv,g=window.Backbone,j=i.Events,h=i.ObjectUtil,b=i.PortletUtil,k={};var m=function(n,o){var p;if(!o&&k[n]){return k[n]}p=i.i18n.getText("portlet.social.groupadminall.groupadminall",n,o);if(!o){k[n]=p}return p};var c=g.Model.extend({url:function(){var n=this.get("id");if(this.collection){return this.collection.url()+"&member="+n}else{return"?member="+n}}});var d=g.Collection.extend({model:c,initialize:function(o,n){this.portletId=n.portletId},url:function(){return b.getPortletResourceUri(this.portletId,"groupMembers")}});var a=g.View.extend({tagName:"li",className:"sv-groupadmin-member",initialize:function(){this.template=this.options.template},render:function(){this.$el.html(this.template(this.model.toJSON(),this.model));return this}});var f=g.View.extend({tagName:"ol",events:{"click .sv-fn-groupadmin-add-member":"addNewMember"},initialize:function(){this.memberTemplate=this.options.memberTemplate;this.list=this.options.list;this.searchUrl=this.options.searchUrl;this.groupId=this.options.groupId;this.collection.on("add",this.prependOne,this)},addNewMember:function(o){var n=this;i.SearchUserUtil.showSearchPopover({target:o.currentTarget,searchUrl:n.searchUrl,group:n.groupId,placeholder:m("searchUser"),selected:function(p){var q=new c(p);n.collection.create(q,{wait:true,success:function(){j.trigger(j.types.notifyUser,{type:"success",heading:m("successAddMessageTitle"),message:m("successAddMessage",p.name),"transient":true,timer:5})}})}});return false},render:function(){this.clearList();this.collection.each(function(n){this.appendOne(n)},this)},appendOne:function(o){var n=new a({model:o,template:this.memberTemplate});this.list.append(n.render().el)},prependOne:function(o){var n=new a({model:o,template:this.memberTemplate});this.list.prepend(n.render().el)},clearList:function(){this.list.empty()}});var l=e(".sv-groupadmin-portlet");l.each(function(){var u=e(this),t=h.getObjectId(u.attr("id")),o=u.find("ol.sv-groupmember-list"),s=o.data("search-url"),q=o.data("group"),w=o.data("js-namespace"),v=b.getTemplate(u,"groupadmin-listitem"),r=window.sv[w];var p=new d(r,{portletId:t});var n=new f({el:u,collection:p,memberTemplate:v,portletId:t,searchUrl:s,groupId:q,list:o});n.render()})}());(function(){var j=window.Backbone,l=window.sv,b=l.PortletUtil,i=l.ClientUtil,n=l.Events,k=l.ObjectUtil,c=l.ErrorUtil,d=window.$svjq,m={};var o=function(p,q){var r;if(!q&&m[p]){return m[p]}r=l.i18n.getText("portlet.social.groupadminall.groupadminall",p,q);if(!q){m[p]=r}return r};var g=j.Model.extend({defaults:{fullName:"",profileImageURL:"",userFields:[]},getProfilePageUrl:function(){return this.get("showProfileURL")},url:function(){var p=this.get("id");if(this.collection){return this.collection.url()+"&member="+p}else{return"?member="+p}}});var f=j.Collection.extend({model:g,initialize:function(q,p){this.id=p.id;this.portletId=p.portletId},url:function(){return b.getPortletResourceUri(this.portletId,"members")},comparator:function(p){if(p.get("fullName")!==null){return p.get("fullName").toLowerCase()}else{return null}}});var a=j.View.extend({tagName:"li",className:"sv-clearfix sv-social-contact sv-groupadminall-member",events:{"click [data-fn-destroy]":"destroy","mousedown [data-fn-downdown-toggle]":"openMenu",click:"navigate"},initialize:function(){this.bindModelEvents()},bindModelEvents:function(){this.model.on("filter",this.toggleVisible,this);this.model.on("destroy",this.remove,this)},openMenu:function(p){this.$el.find(".downdown-toggle").dropdown("toggle");p.stopPropagation();return false},destroy:function(){this.model.destroy({wait:true,error:function(q,r,p){c.handleBackboneError(q,r,p)}});return false},navigate:function(p){if((i.isMac&&p.metaKey)||(!i.isMac&&p.ctrlKey)||p.shiftKey){window.open(this.model.getProfilePageUrl())}else{window.location.href=this.model.getProfilePageUrl()}return},toggleVisible:function(p){this.$el.toggleClass("sv-hidden",!this.isVisible(p.filter))},isVisible:function(q){var p=this.model.get("fullName")+this.model.get("memberStatus")+this.model.get("userFields").join("|");return !q||(p&&p.toLowerCase().indexOf(q.toLowerCase())!==-1)},remove:function(){var p=this;this.$el.fadeOut("3000",function(){p.$el.remove();n.trigger(n.types.notifyUser,{type:"success",message:o("successMessage",p.model.get("fullName")),"transient":true,timer:5})})},render:function(){this.$el.html(this.options.template(this.model.toJSON()));return this}});var h=j.View.extend({events:{"click [data-fn-switch-list-style]":"setListStyle","click [data-fn-add-member]":"addNewMember","keyup [data-fn-filter]":"setFilter","change [data-fn-filter]":"setFilter","blur [data-fn-filter]":"setFilter"},initialize:function(){this.$list=this.$el.find("ol");this.listStyle=this.options.listStyle;this.portletId=this.options.portletId;this.groupId=this.options.groupId;this.searchResultURL=this.options.searchResultURL;if(this.collection.length>0){this.render()}this.bindCollectionEvents()},addNewMember:function(q){var p=this;l.SearchUserUtil.showSearchPopover({target:q.currentTarget,searchUrl:p.searchResultURL,group:p.groupId,placeholder:o("searchUser"),selected:function(r){var s=new g(r);p.collection.create(s,{wait:true,success:function(){n.trigger(n.types.notifyUser,{type:"success",message:o("successAddMessage",r.name),"transient":true,timer:5})},error:function(u,v,t){c.handleBackboneError(u,v,t)}})}});return false},bindCollectionEvents:function(){this.collection.on("add",this.appendOne,this)},render:function(){this.clearList();this.collection.each(function(p){this.appendOne(p)},this)},appendOne:function(q){var p=new a({model:q,portletId:this.options.portletId,template:this.options.memberTemplate});this.$list.append(p.render().el)},filterOne:function(q,p){q.trigger("filter",{filter:p})},filterAll:function(p){this.collection.each(function(q){this.filterOne(q,p)},this)},clearList:function(){this.$list.empty()},setListStyle:function(q){var p=d(q.currentTarget).data("list-style");this.$list.removeClass(this.listStyle).addClass(p);this.listStyle=p},setFilter:function(p){this.filterAll(p.currentTarget.value)}});var e=d(".sv-groupadminall-portlet");e.each(function(){var w=d(this),t=k.getObjectId(w.attr("id")),q=w.find("ol"),r=q.data("group"),u=q.data("search-result-url"),p=q.data("js-namespace"),s=b.getTemplate(w,"member"),v=new f(l[p]||[],{id:r,portletId:t});new h({el:w,collection:v,groupId:r,listStyle:"sv-list-2-columns",memberTemplate:s,portletId:t,searchResultURL:u});w.find("li.sv-groupadminall-member").css("height",q.data("item-height"));if(!i.supportsPlaceholder){w.find(".sv-filter-label").removeClass("sv-hidden")}})}());(function(){var c=window.$svjq,a=window.sv,f=a.PortletUtil,d=a.ObjectUtil;var b=function(i,k,l){var j=i.attr("data-identity-id"),g=i.closest(".sv-groupmemberstatus-portlet").attr("id"),h=d.getObjectId(g);f.doGetWithFade("#"+g,"/"+a.PageContext.pageId+"/"+h+".xml?identity="+j+"&groupStatusCommand="+k,l);return false};var e=c(".sv-groupmemberstatus-portlet");e.on("click",".sv-fn-groupmemberstatus-add",function(){return b(c(this),"add",function(){window.location.reload()})});e.on("click",".sv-fn-groupmemberstatus-remove",function(){var g=c(this).attr("data-profile-page");return b(c(this),"remove",function(){if(g===""){window.location.reload()}else{window.location.href=g}})});e.on("click",".sv-fn-groupmemberstatus-mute",function(){return b(c(this),"mute",function(){})});e.on("click",".sv-fn-groupmemberstatus-unmute",function(){return b(c(this),"unmute",function(){})});e.on("click",".sv-fn-groupmemberstatus-eavesdrop",function(){return b(c(this),"eavesdrop",function(){})});e.on("click",".sv-fn-groupmemberstatus-uneavesdrop",function(){return b(c(this),"uneavesdrop",function(){})})}());(function(){var f=window.$svjq,k=window.sv,i=window.Backbone,b=k.PortletUtil,j=k.ObjectUtil,d=false,o=function(p){return k.i18n.getText("portlet.social.grouptypeselector.grouptypeselector",p)},h=function(p){return k.i18n.getText("common",p)};var c=i.Model.extend({url:function(){var p=this.get("id");if(this.collection){return this.collection.url()+"&member="+p}else{return"?member="+p}}});var m=i.Collection.extend({model:c,initialize:function(q,p){this.portletId=p.portletId},url:function(){return b.getPortletResourceUri(this.portletId,"groupAdmins")}});var a=i.View.extend({tagName:"li",className:"sv-groupadmin-item",initialize:function(){this.template=this.options.template},render:function(){this.$el.html(this.template(this.model.toJSON(),this.model));return this}});var l=i.View.extend({tagName:"ol",events:{"click .sv-fn-groupadmin-add-admin":"addNewAdmin"},initialize:function(){this.adminTemplate=this.options.adminTemplate;this.list=this.options.list;this.groupId=this.options.groupId;this.collection.on("add",this.prependOne,this)},render:function(){this.clearList();this.collection.each(function(p){this.appendOne(p)},this)},addNewAdmin:function(q){var p=this;k.SearchUserUtil.showSearchPopover({target:q.currentTarget,placeholder:o("searchUser"),group:p.groupId,markAdmins:true,selected:function(s){var r=new c(s);p.collection.create(r,{wait:true,success:function(){d=true}})}});return false},appendOne:function(q){var p=new a({model:q,template:this.adminTemplate});this.list.append(p.render().el)},prependOne:function(q){var p=new a({model:q,template:this.adminTemplate});this.list.prepend(p.render().el)},clearList:function(){this.list.empty()}});var e=function(s,u,r){var p=s.closest(".sv-grouptypeselector-portlet").attr("id");var q=j.getObjectId(p);var t=b.getPortletResourceUri(q,"updateType")+"&groupCommand="+u;f.ajax({type:"PUT",dataType:"JSON",url:t,success:function(){if(r){location.reload()}},error:function(){f(".alert").show()}});return false};var g=f(".sv-grouptypeselector-portlet");g.on("click",".sv-fn-grouptypeselector-closed",function(){return e(f(this),"closed",true)});g.on("click",".sv-fn-grouptypeselector-open",function(){return e(f(this),"open",true)});g.on("click",".sv-fn-grouptypeselector-inactive",function(){return e(f(this),"inactive",true)});g.on("click",".sv-fn-grouptypeselector-active",function(){return e(f(this),"active",true)});g.on("click",".sv-fn-grouptypeselector-member_moderated",function(){return e(f(this),"member_moderated",true)});g.on("click",".sv-fn-grouptypeselector-settings",function(){var r=f(this).closest(".sv-grouptypeselector-portlet"),q=r.find("[data-fn-grouptypeselector]").data("js-namespace"),p=window.sv[q];f.ajax({type:"GET",dataType:"JSON",url:b.getPortletResourceUri(j.getObjectId(r.attr("id")),"getSettings"),success:function(s){n(s,r,p)},error:function(){f(".alert").show()}})});function n(r,t,p){var q=f(f.parseHTML(k.PortletUtil.getTemplate(t,"group-settings")(r.values))),w=q.find("ol.sv-group-admins"),v=j.getObjectId(t.attr("id"));var s=new m(p,{portletId:v});var x=new l({el:q,collection:s,adminTemplate:k.PortletUtil.getTemplate(t,"group-admin"),portletId:v,groupId:w.data("group"),list:w});x.render();if(r.success){var u=[{text:h("ok"),skipDismiss:true,primary:true,callback:function(){f.ajax({type:"POST",dataType:"JSON",data:f(".sv-groupsettings-form").serialize(),url:b.getPortletResourceUri(j.getObjectId(t.attr("id")),"updateSettings"),success:function(y){f(".modal").modal("hide");if(y.reload||d){location.reload()}},error:function(A){var y=f.parseJSON(A.responseText);var z=f(".alert").find(".alert-message");z.text(o(y.messageType));q.find("input").first().focus().closest(".control-group").addClass("error");f(".alert").show()}})}}];k.DialogUtil.showDialog({title:o("group-settingsLabel"),body:q,buttons:u,removeOnHide:true,errorTitle:o("errorTitle"),errorMsg:o("errorText")});f("body").on("submit","form.sv-groupsettings-form",function(){return false})}}}());(function(){var f=window.$svjq,o=window.sv,m=window.Backbone,a=o.PortletUtil,n=o.ObjectUtil,e=o.KeyUtil,g=e.KEY,p=o.Events,q=o.i18n,b=null,j=function(s,r){return q.getText("portlet.social.notifications.notifications",s,r)},k=function(s,r){return q.getText("common",s,r)},c=function(r){p.trigger(p.types.notifyUser,{type:"error",heading:k("error"),message:r});return false};var l=m.Model.extend({defaults:{id:"",isNew:false,message:"",targetUrl:"",notifier:{fullName:"",buddyIconUrl:""}}});var h=m.Collection.extend({model:l,initialize:function(r){this.id=r.id},url:function(){return a.getPortletResourceUri(this.id,"notifications")},parse:function(r){this.hasMore=r.hasMore;return r.notifications}});var d=m.View.extend({tagName:"li",className:"sv-notification sv-clearfix",render:function(){this.$el.html(this.options.template(this.model.toJSON()));if(this.model.get("isNew")){this.$el.find(".sv-notification-text").addClass("sv-notification-new")}return this}});var i=m.View.extend({initialize:function(){this.$list=this.$el.find("ul.sv-notification-list");this.notificationTemplate=o.PortletUtil.getTemplate(this.$el.closest(".sv-notifications-portlet"),"notification");this.collection.on("reset",this.handleDataLoaded,this)},events:{"click .sv-notifications-show-more":"loadMoreNotifications"},handleDataLoaded:function(){this.clearList();this.render()},loadMoreNotifications:function(){var s=this;if(b===false){return}var r=this.$list.closest("div.popover-content");r.css("max-height",r.height()+"px").addClass("sv-show-scroll");f("body").addClass("stop-scrolling");if(b===null){b=s.collection.last().get("id")}f.ajax({type:"GET",dataType:"JSON",url:a.getPortletResourceUri(s.model.id,"notifications")+"&last="+b,success:function(u){var v=s.$el.find("[data-sv-fn-show-more]"),t=u.notifications,w=u.hasMore;f.each(t,function(){s.appendOne(new l(this))});r.scrollTop(r.scrollTop()+r.height());if(f(t).last().length>0){b=f(t).last().get(0).id}else{b=false}if(w){v.removeClass("svhidden")}else{v.addClass("svhidden")}},error:function(){c(j("error-unknown"))}})},render:function(){this.collection.each(function(r){this.appendOne(r)},this)},appendOne:function(s){var r=new d({model:s,template:this.notificationTemplate});this.$list.append(r.render().el)},appendAll:function(r){r.each(this.appendOne,this)},clearList:function(){this.$list.empty()}});f(".sv-notifications-portlet").each(function(){var u=f(this),r=u.find("[data-fn-drop-down]"),s=n.getObjectId(u.attr("id")),w;var v=function(){var x=new h({id:s});new i({el:u,model:x,collection:x});x.fetch({reset:true,success:function(y){var z=u.find("[data-sv-fn-show-more]"),B=y.hasMore,A=u.find("[data-sv-fn-loading]");clearTimeout(w);A.hide();if(B){z.removeClass("svhidden")}else{z.addClass("svhidden")}},error:function(){c(j("error-unknown"))}})};var t=function(A){var y=f(A);b=null;var x=function(B){if(!f(B).is(".popover *")){y.popover("destroy").removeClass("sv-fn-popover-showing");y.find("[data-fn-count]").removeClass("sv-notifications-badge").text("");f("body").removeClass("stop-scrolling");f("body").unbind("click",x)}};if(y.hasClass("sv-fn-popover-showing")){y.popover("destroy").removeClass("sv-fn-popover-showing");f("body").removeClass("stop-scrolling");x(y);return}y.popover("destroy").addClass("sv-fn-popover-showing").popover({html:true,title:j("notifications"),placement:"bottom",content:'<ul class="sv-notification-list sv-defaultlist"></ul><div style="text-align:center; display:none" data-sv-fn-loading><img src="/sitevision/util/images/loading_16_grey.gif" alt="" /></div><div class="sv-notifications-show-more svhidden" data-sv-fn-show-more>'+j("showMore")+"</div>",trigger:"manual"});y.popover("show");y.keydown(function(C){var B=e.getKeyCodeFromEvent(C);if(B===g.UP){return false}else{if(B===g.DOWN){return false}}return true}).keyup(function(C){var B=e.getKeyCodeFromEvent(C);if(B===g.ESC){x(C.target);return false}return true});var z=function(B){x(B.target)};f("body").bind("click",z);w=setTimeout(function(){u.find("[data-sv-fn-loading]").show()},400);v()};r.click(function(x){t(x.currentTarget);return false})})}());(function(){var b=window.$svjq;var a=window.sv;var d=function(f){return a.i18n.getText("portlet.social.personalsettings.personalsettings",f)};var c=function(f){return a.i18n.getText("common",f)};b("[data-fn-personalsettings-profile]").on("click",function(){var g=this;var f=b(g).attr("data-fields");a.UserSettingsUtil.popupUserSettingsDialog(f)});b("[data-fn-personalsettings-general]").on("click",function(){var f=b(this).closest(".sv-personalsettings-portlet");b.ajax({type:"GET",dataType:"JSON",url:a.PortletUtil.getPortletUri(a.ObjectUtil.getObjectId(f.attr("id")),"generalSettings"),success:function(g){e(g,f,"storeGeneralSettings","personalsettings-general")},error:function(){b(".alert").show()}})});b("[data-fn-personalsettings-notification]").on("click",function(){var f=b(this).closest(".sv-personalsettings-portlet");b.ajax({type:"GET",dataType:"JSON",url:a.PortletUtil.getPortletUri(a.ObjectUtil.getObjectId(f.attr("id")),"notificationSettings"),success:function(g){e(g,f,"storeNotificationSettings","personalsettings-notifications")},error:function(){b(".alert").show()}})});function e(h,l,g,f){var i=b(b.parseHTML(a.PortletUtil.getTemplate(l,f)(h.values)));if(h.success){var j=[{text:c("cancel")},{text:c("ok"),skipDismiss:true,primary:true,callback:function(){b.ajax({type:"POST",dataType:"JSON",data:b(".sv-personalsettings-form").serialize(),url:a.PortletUtil.getPortletUri(a.ObjectUtil.getObjectId(l.attr("id")),g),success:function(o){if(o.success){b(".modal").modal("hide")}else{if(o.errors){var p=o.errors;for(var n in p){if(p.hasOwnProperty(n)){var m=b("[data-fn-"+n+"]");if(m.siblings(".error").length===0){m.after(b("<span />").addClass("help-block error").text(p[n]));m.parents(".control-group").addClass("error")}}}}}},error:function(){b(".alert").show()}})}}];var k="";if(f==="personalsettings-notifications"){k=d(f+"Help")}a.DialogUtil.showDialog({title:d(f+"Label"),titleHelp:k,body:i,buttons:j,removeOnHide:true,errorTitle:d("networkErrorTitle"),errorMsg:d("networkErrorText")})}}}());(function(){var c=window.$svjq,a=window.sv,e=a.PortletUtil,d=a.ObjectUtil,b=c(".sv-predefinedcontactsearch-portlet");b.each(function(){var m=c(this),f=m.find("[data-fn-no-result-container]"),r=m.find("[data-fn-search-result-container]"),o=m.find("[data-fn-load-more-container]"),l=f.length>0,n=d.getObjectId(m.attr("id")),i=e.getTemplate(m,"social-entry"),p=e.getTemplate(m,"social-entry-connected"),j=e.getTemplate(m,"more-hits"),h,k="/"+a.PageContext.pageId+"/"+n+".xml?state=",g=k+"ajaxMore",q=k+"ajaxAddContact&newContactId=";if(l){h=e.getTemplate(m,"error")}o.on("click","[data-fn-load-more]",function(){var u=c(this),s=u.attr("data-next-hit"),t=g+"&startAtHit="+s;u.attr("disabled","disabled");c.ajax({dataType:"json",url:t,success:function(v){o.empty();if(v.hits){c.each(v.hits,function(w,x){r.append(i(x))});if(v.hasMoreHits){o.append(j(v))}}else{if(l&&v.message){f.empty().append(h(v))}}}})});r.on("click","[data-fn-add-contact]",function(){var u=c(this),s=u.data("contact-id"),t=q+s;u.attr("disabled","disabled");c.ajax({dataType:"json",url:t,success:function(w){var v;if(w.added){v='[data-contact-id="'+w.added+'"]';c(v).closest(".sv-function-container").html(p(w))}}})})})}());(function(){var g=window.$svjq,j=window.sv,l=j.i18n,i=j.ObjectUtil,c=j.PortletUtil,e=j.DialogUtil,a=j.ImageUtil,k=j.Events,f=function(n,m){return l.getText("portlet.social.profileimage.profileimage",n,m)},h=function(n,m){return l.getText("common",n,m)},d=function(m){k.trigger(k.types.notifyUser,{type:"error",heading:h("error"),message:m});return false};var b=function(m){return g.Deferred(function(n){var o=new Image();o.onload=function(){n.resolve(o)};o.onerror=function(){n.reject()};o.src=m}).promise()};g(".sv-profileimage-portlet").each(function(){var s=g(this),p=s.find("div[data-profile]").data("profile"),o=s.find("div[data-default-image-url]").data("default-image-url"),A=i.getObjectId(s.attr("id")),m=c.getModelObjectUri(p,"profileImage"),D=s.find(".sv-fn-tools"),u=s.find(".sv-fn-upload"),v=s.find(".sv-fn-mouse-menu"),n=s.find(".sv-fn-mouse-dropdown"),E=s.find(".sv-fn-crop"),C=s.find(".sv-fn-buttons"),B=s.find(".sv-fn-change-btn-solo"),y=s.find(".sv-fn-profileimage"),x=y.data("width"),F=s.find(".sv-fn-saving");u.fileupload({dataType:"json",url:m,replaceFileInput:true,formAcceptCharset:"utf-8",submit:function(J,I){var K=I.files[0].type,H=I.files[0].size;if(!K){var G=I.files[0].name,L=G.lastIndexOf(".");if((L===-1)||(L+1>G.length)){return d(f("error-type","?"))}K="image/"+G.substring(L+1).toLowerCase()}if(!H){H=1}if(!/^image\/(jpg|png|jpeg|gif)$/.test(K)){return d(f("error-type",K))}if(H>64000000){return d(f("error-size",64))}D.addClass("svhidden");F.removeClass("svhidden")},done:function(H,G){D.removeClass("svhidden");C&&C.removeClass("svhidden");B&&B.addClass("svhidden");if(G.result.result.width<x){t();return d(f("error-dimension",[x,x]))}z(true)},fail:function(){return d(f("error-unknown"))},always:function(){D.removeClass("svhidden");F.addClass("svhidden")}});var w=function(G){if(y.attr("src")===o){g(".sv-fn-crop").hide()}else{g(".sv-fn-crop").show()}var I=G.pageX-10,H=G.pageY-10;v.css({position:"fixed",left:I,top:H});n.dropdown();n.click();return false};y.click(w);y.on("contextmenu",w);var z=function(G){g.ajax({type:"GET",dataType:"JSON",url:m+"/"+p,success:function(H){q(H.result,G)},error:function(){d(f("error-unknown"))}})};var t=function(){g.ajax({type:"DELETE",dataType:"JSON",url:m+"/"+p,success:function(){g.ajax({type:"GET",dataType:"JSON",url:c.getPortletResourceUri(A,"profileImage"),success:function(G){y.attr("src",G.profileImageUrl);if(!G.profileImageUrl||o===G.profileImageUrl){C&&C.addClass("svhidden");B&&B.removeClass("svhidden")}},error:function(){d(f("error-unknown"))}})},error:function(){d(f("error-unknown"))}})};var r=function(G){g.ajax({type:"PUT",dataType:"JSON",url:m+"/"+p+"?cropX="+G.x+"&cropY="+G.y+"&cropWidth="+G.width+"&cropHeight="+G.height,success:function(){g.ajax({type:"GET",dataType:"JSON",url:c.getPortletResourceUri(A,"profileImage"),success:function(H){y.attr("src",H.profileImageUrl)},error:function(){d(f("error-unknown"))}})},error:function(){d(f("error-unknown"))}})};var q=function(G,I){var L=G.profileImageUrl,K=g("<img/>"),Q=G.cropX,O=G.cropY,M=G.cropWidth,N=G.cropHeight,J=0,H=0,P;b(L).done(function(R){J=R.width;H=R.height;P=a.getImageDimension({maxWidth:530,minWidth:350,width:J,maxHeight:350,minHeight:200,height:H});K.attr("src",L);K.css({width:"100%","max-width":P.width+"px",height:"100%","max-height":P.height+"px"})}).done(function(){K.attr("src",L);var T=g("<div/>").css({"text-align":"center",margin:"0 auto",width:"100%","max-width":P.width+"px",height:"100%","max-height":P.height+"px"});var V=false;T.append(K);var U=[{text:h("cancel")},{text:h("save"),primary:true,callback:function(){V=true;r({x:Q,y:O,width:M,height:N})}}];var S=function(){var X=Q,Z=O,W=Q+M,Y=O+N;if(M===0){if(J<H){X=0.1*J;Z=X;W=J-X;Y=W}else{Z=0.1*H;X=Z;Y=H-Z;W=Y}Q=Math.round(X);O=Math.round(Z);M=Math.round(W-X);N=Math.round(Y-Z)}K.Jcrop({aspectRatio:1,setSelect:[X,Z,W,Y],trueSize:[J,H],onSelect:function(aa){if((aa.w>0)&&(aa.h>0)){Q=Math.round(aa.x);O=Math.round(aa.y);M=Math.round(aa.w);N=Math.round(aa.h)}}})};var R=function(){g(".imgareaselect-handle").parent().remove();g('[class*="imgareaselect"]').remove();if(I&&!V){t()}};e.showDialog({title:f("crop-title"),body:T,buttons:U,removeOnHide:true,shownCallback:S,hiddenCallback:R})})};E.click(function(){z(false)})})}());(function(){var h=window.$svjq,j=window.sv,k=j.i18n,b=j.KeyUtil,e=b.KEY,i=j.ObjectUtil,a=j.PortletUtil,g="portlet.social.taglist.taglist";var f=function(p,m,n){var r=m.val();if(r&&r!=="#"){var q=p.closest(".sv-taglist-portlet"),l=q.attr("id"),o=i.getObjectId(l);h.ajax({type:"POST",dataType:"JSON",url:a.getPortletResourceUri(o,"create"),data:{tag:r},success:function(){var s=q.find(".sv-taglist");a.doGetWithFade(s,a.getPortletUri(o,"viewItems"));m.val("");n.addClass("disabled").attr("disabled","disabled")}})}return false};var d=function(p){var o=p.closest(".sv-taglist-item"),r=o.attr("data-tag-name"),q=p.closest(".sv-taglist-portlet"),l=q.attr("id"),n=i.getObjectId(l),m=a.getPortletResourceUri(n,"remove")+"&tag="+window.encodeURIComponent(r);h.ajax({type:"DELETE",dataType:"JSON",url:m,success:function(){j.Events.trigger(j.Events.types.notifyUser,{type:"success",message:k.getText(g,"removedMessage",r),"transient":true,timer:5});var t=q.find(".sv-taglist"),s=a.getPortletUri(n,"view")+"&onlyRenderListItems=true";a.doGetWithFade(t,s)}});return false};var c=h(".sv-taglist-portlet");c.on("click",".sv-fn-taglist-add-portlet",function(){return f(h(this),h(this).closest(".sv-taglist-portlet").find(".sv-taglist-input"),h(this).closest(".sv-taglist-portlet").find("[data-add-tag-button]"))});c.on("keyup",".sv-taglist-input",function(n){var m=b.getKeyCodeFromEvent(n),l=h(this).closest(".sv-taglist-portlet").find("[data-add-tag-button]");if(h(n.currentTarget).val().length>0){l.removeClass("disabled").removeAttr("disabled")}else{l.addClass("disabled").attr("disabled","disabled")}if(m===e.RETURN){f(h(this),h(this).closest(".sv-taglist-portlet").find(".sv-taglist-input"),l)}else{if(m===e.SPACE){return false}}});c.on("mouseup",".sv-taglist-input",function(o){var n=h(this).closest(".sv-taglist-portlet").find("[data-add-tag-button]"),l=h(o.currentTarget),m=l.val();if(m===0){n.addClass("disabled").attr("disabled","disabled")}else{setTimeout(function(){var p=l.val();if(p.length===0){n.addClass("disabled").attr("disabled","disabled")}},1)}});c.on("click","li.sv-taglist-item",function(){location.href=h(this).find(".sv-fn-tag-link").attr("href")});c.on("click",".sv-fn-taglist-remove-portlet",function(){return d(h(this))})}());(function(){var f=window.$svjq;var i=window.sv;var h=window._;var c=i.DialogUtil;var j=i.i18n;var g=i.ObjectUtil;var a=i.PortletUtil;var e="portlet.social.taglistall.taglistall";var b=function(n){var m=n.closest(".sv-taglist-item");var o=m.attr("data-tag-name");var k=j.getText(e,"removeDialogTitle");var l=j.getText(e,"removeDialogLabel",h.escape(o));c.showConfirmDialog(k,l,function(p){if(p){var s=n.closest(".sv-taglistall-portlet");var q=s.attr("id");var r=g.getObjectId(q);f.ajax({type:"GET",dataType:"JSON",url:a.getPortletUri(r,"remove"),data:{tag:o},success:function(){var t=s.find(".sv-taglistall");a.doGetWithFade(t,a.getPortletUri(r,"view"))}})}});return false};var d=f(".sv-taglistall-portlet");d.on("click",".sv-fn-taglistall-remove-portlet",function(){return b(f(this))})}());(function(){var e=window.$svjq,q=window.sv,i=q.PortletUtil,j=q.KeyUtil,f=q.DialogUtil,b=q.Events,k=q.ObjectUtil,d=q.ActivityUtil,c=window.Backbone,s=window.moment,g=e("html").hasClass("sv-touch"),n="all",h=function(w,v){return q.i18n.getText("common",w,v)},m=function(w,v){return q.i18n.getText("portlet.social.tasks.tasks",w,v)};var p=function(v){var w=this;e(".modal").modal("hide").remove();if(this.model.get("start")){f.showDialog({title:m("confirmRemoveCalendarTitle"),body:m("confirmRemoveCalendarMessage"),buttons:[{text:h("cancel"),callback:function(){e.proxy(v,w)()}},{text:m("confirmRemoveCalendarRemove"),callback:function(){w.model.destroy({success:function(x){b.trigger(b.types.activityDeleted,x.attributes)}});e.proxy(v,w)()}},{text:m("confirmRemoveCalendarSaveInCalendar"),callback:function(){w.model.set("isTask",false);w.model.save(null,{success:function(x){b.trigger(b.types.activityUpdated,x.attributes)}});e.proxy(v,w)()}}],errorTitle:h("networkErrorTitle"),errorMsg:h("networkErrorText")})}else{f.showConfirmDialog(m("confirmRemoveTitle"),m("confirmRemoveMessage"),function(x){if(x){w.model.destroy({success:function(y){b.trigger(b.types.activityDeleted,y.attributes)}});e.proxy(v,w)()}})}return false};var a=d.ActivityModel.extend({allowEmptyStart:true,url:function(){if(this.collection){return this.collection.url()+(this.has("id")?"&id="+this.get("id"):"")}return i.getPortletResourceUri(this.portletId,"task")+(this.has("id")?"&id="+this.get("id"):"")}});var t=c.Collection.extend({model:a,comparator:function(A,y){var x=A.get("start"),v=A.get("createdAt"),w=y.get("start"),z=y.get("createdAt");if(!x){if(!w){return v>=z?-1:1}return -1}if(!w){return 1}if(x===w){return v>=z?-1:1}return x>w?-1:1},initialize:function(w,v){this.portletId=v.portletId},url:function(){return i.getPortletResourceUri(this.portletId,"task")}});var l=d.ActivityEditView.extend({templateName:"edit",memberTemplateName:"member",participantTemplateName:"participant",membersActionName:"members",membersWithOwnerActionName:"membersWithOwner",i18n:m,removeActivity:function(){e.proxy(p,this,function(){e(".modal").modal("hide").remove()})()}});var u=d.ActivityDetailView.extend({templateName:"details",participantsActionName:"participants",createEditView:function(v){var w=new l({model:new a(v.attributes,{portletId:this.options.portletId}),portletId:this.options.portletId,$portlet:this.options.$portlet});w.backingModel=v;return w},i18n:m,removeActivity:function(){e.proxy(p,this,function(){this.closePopover()})()},templateHelpers2:{timeSpan:function(B,w,z){var v=z?"ll":"lll",A=s(B),y=A.format(v);if(w){var x=s(w);if(A.format("YYYY-MM-DD")===x.format("YYYY-MM-DD")){if(!z){return y+" - "+x.format("LT")}}else{if(A.format("YYYY")===x.format("YYYY")){return y+" - "+d.stripYear(w,x.format(v))}else{return y+" - "+x.format(v)}}}return y}}});var o=c.View.extend({template:function(){return i.getTemplate(this.options.$portlet,"task")},tagName:"li",className:"sv-task",events:{"change [data-fn-done]":"toggleDone","click [data-fn-details]":"showDetails","click [data-fn-edit]":"showEdit"},initialize:function(v){this.options=v;this.bindModelEvents();var w=this.template();this.$el.html(w(this.model.toJSON()));this.ui={taskLink:this.$el.find(".sv-task-link")}},render:function(){if(this.model.get("editable")){this.$el.data("eventObject",this.model.attributes);this.$el.draggable({zIndex:999,revert:true,revertDuration:0,helper:"clone",distance:20});this.renderHover(this.$el)}this.toggleVisible();return this},bindModelEvents:function(){this.listenTo(this.model,"filter",this.toggleVisible,this);this.listenTo(this.model,"change",this.render,this);this.listenTo(this.model,"change",this.markOverdue,this)},toggleDone:function(){this.model.set("isDone",!this.model.get("isDone"));this.model.save(null,{success:e.proxy(function(v){this.markOverdue();b.trigger(b.types.activityUpdated,v.attributes)},this)})},showDetails:function(w){var v=e(w.target);new u({model:this.model,portletId:this.options.portletId,$portlet:this.options.$portlet,$target:v,popoverContainer:v.closest(".sv-fn-tasks"),i18n:m}).render();return false},showEdit:function(v){v.stopPropagation();if(this.model.get("editable")){var w=new l({model:new a(this.model.attributes,{portletId:this.options.portletId}),portletId:this.options.portletId,$portlet:this.options.$portlet});w.backingModel=this.model;w.render();if(g){e(window).scrollTop(0)}}else{this.showDetails(v)}return false},markOverdue:function(){var x=this.model.get("end");if(!x){x=this.model.get("start")}if(x){var v=s(x),w=s();if(this.model.get("allDay")){v.startOf("day").add("days",1).subtract("seconds",1)}if(!this.model.get("isDone")&&v.isBefore(w)){this.ui.taskLink.addClass("sv-task-overdue")}else{this.ui.taskLink.removeClass("sv-task-overdue")}}else{this.ui.taskLink.removeClass("sv-task-overdue")}},renderHover:function(v){v.find(".sv-task-title").addClass("sv-task-title-owner")},toggleVisible:function(){var w=this.model.get("isDone"),v=(n==="all")||(w&&n==="done")||(!w&&n==="notDone");this.$el.toggleClass("sv-hidden",!v)}});var r=c.View.extend({events:{"click [data-fn-filter]":"setFilter","keyup [data-fn-create-input]":"handleInputFieldKeyPress","mouseup [data-fn-create-input]":"handleInputIEClearField","click [data-fn-create-button]":"createOnClick"},initialize:function(v){this.options=v;this.$el=v.$el;this.editable=this.$el.find(".sv-fn-tasks").data("editable");this.bindCollectionEvents();this.bindGlobalEvents();this.ui={list:this.$el.find("[data-sv-fn-task-list]"),input:this.$el.find("[data-fn-create-input]"),createButton:this.$el.find("[data-fn-create-button]"),percentDone:this.$el.find(".sv-percentDone"),filter:this.$el.find('[data-toggle="dropdown"]').parent()}},render:function(){this.clearList();if(this.collection.length>0){this.collection.each(function(v){this.prependOne(v)},this);b.trigger(b.types.updateRelativeDates,this.ui.list);this.updateTotalCount(this.collection)}return this},activityUpdated:function(w){var v=this.collection.get(w.id);if(v){if(!w.isTask){this.collection.remove(v)}else{v.set(w);this.doSortAndRender()}}},activityCreated:function(w){var v=this.collection.get(w.id);if(w.isTask&&!v){this.collection.add(new a(w,{portletId:this.options.portletId}))}},activityDeleted:function(w){var v=this.collection.get(w.id);if(v){this.collection.remove(v)}},bindGlobalEvents:function(){b.on(b.types.activityUpdated,e.proxy(this.triggeredUpdateCount,this));b.on(b.types.activityUpdated,e.proxy(this.activityUpdated,this));b.on(b.types.activityCreated,e.proxy(this.activityCreated,this));b.on(b.types.activityDeleted,e.proxy(this.activityDeleted,this));b.on(b.types.groupPageViewed,e.proxy(function(){this.collection.each(function(v){v.set("markAsUnread",false)},this)}),this)},bindCollectionEvents:function(){this.listenTo(this.collection,"add",this.appendOne,this);this.listenTo(this.collection,"remove",this.render,this);this.listenTo(this.collection,"destroy",this.render,this);this.listenTo(this.collection,"change",this.doSortAndRender,this)},doSortAndRender:function(){this.collection.sort();this.render()},appendOne:function(w){var v=this.createAndRenderTaskView(w);this.ui.list.append(v.el);this.updateTotalCount(this.collection)},prependOne:function(w){var v=this.createAndRenderTaskView(w);this.ui.list.prepend(v.el);this.updateTotalCount(this.collection)},createAndRenderTaskView:function(v){return new o({model:v,portletId:this.options.portletId,$portlet:this.$el,editable:this.editable}).render()},handleInputIEClearField:function(){var v=this.ui.input.val(),w=this;if(v.length===0){this.toggleCreateButton(false)}else{setTimeout(function(){var x=w.ui.input.val();if(x.length===0){w.toggleCreateButton(false)}},1)}},handleInputFieldKeyPress:function(w){var v=j.getKeyCodeFromEvent(w),x=e.trim(this.ui.input.val());if(x.length>0){this.toggleCreateButton(true)}else{this.toggleCreateButton(false)}if(v!==j.KEY.RETURN){return}w.preventDefault();this.createTaskIfNotEmpty()},toggleCreateButton:function(v){if(v){this.ui.createButton.removeClass("disabled").removeAttr("disabled")}else{this.ui.createButton.addClass("disabled").attr("disabled","disabled")}},createOnClick:function(){this.createTaskIfNotEmpty()},createTaskIfNotEmpty:function(){var v=e.trim(this.ui.input.val());if(!v){return false}this.collection.create({title:v,owner:"-"},{wait:true,success:function(w){b.trigger(b.types.activityCreated,w.attributes)}});this.ui.input.val("");this.toggleCreateButton(false);this.ui.createButton.addClass("disabled").attr("disabled","disabled");return false},triggeredUpdateCount:function(){this.updateTotalCount(this.collection)},updateTotalCount:function(y){var v=y.size(),w=0;y.forEach(function(z){if(z.get("isDone")){w++}});var x=0;if(v>0){x=Math.round((w/v)*100)}this.ui.percentDone.text(x+"%");this.ui.percentDone.data("fn-finishedCount",w);this.ui.percentDone.data("fn-totalCount",v)},clearList:function(){this.ui.list.empty()},filterOne:function(v){v.trigger("filter")},filterAll:function(){this.collection.each(function(v){this.filterOne(v)},this)},setFilter:function(y){var v=e(y.currentTarget),x=v.closest(".dropdown-menu"),z=v.data("fn-action"),w=x.find("[data-fn-action="+n+"]");if(n===z){return}n=z;this.selectFilterValue(w,false);this.selectFilterValue(v,true);this.filterAll();this.ui.filter.removeClass("open");return false},selectFilterValue:function(w,v){w.find("i").toggleClass("sv-empty-icon",!v);w.find("i").toggleClass("halflings-icon ok",v)}});e(".sv-tasks-portlet").each(function(){var x=e(this),w=k.getObjectId(x.attr("id")),v=x.find(".sv-fn-tasks").data("js-namespace"),y=new t(q[v],{id:w,portletId:w});new r({$el:x,collection:y,portletId:w}).render();x.on("mouseenter",".sv-percentDone",function(){var A=e(this),z=A.data("fn-totalCount"),B=A.data("fn-finishedCount");A.tooltip("destroy");A.tooltip({html:true,title:'<div style="white-space:nowrap">'+m("doneText",[B,z])+"</div>"});A.tooltip("show")});x.on("mouseenter",".sv-task-clock",function(){var D=e(this),z=D.children("time"),A=parseInt(z.attr("dateTime"),10),C=s(A),B=z.attr("data-fn-format");D.tooltip("destroy");D.tooltip({html:true,title:'<div style="white-space:nowrap">'+C.format(B)+"</div>"});D.tooltip("show")})})}());(function(){var g=window.sv,i=g.PortletUtil,m=g.Events,j=g.KeyUtil,y=g.ObjectUtil,f=g.Log,E=j.KEY,t=window.Backbone,I=window._,r=window.$svjq,B=window.moment,n={},x,D,c,d,k,C=I.template('<i class="halflings-icon chevron-<%= direction %>"></i><b class="sv-with-icon"><%= text %></b>'),b={triggers:{"@":{source:i.getUtilityApiUri("socialsearchutil","contacts"),searchKey:"term",allowWhiteSpace:true,parse:function(K){return K.hits}}},minLength:2,replacer:function(K){return K.trigger+'{"value":"'+K.name+'","id":"'+K.id+'"}'}},z=function(N,M,K,L){m.trigger(m.types.notifyUser,{type:N,heading:M,message:K,"transient":L});return false},G=function(K,L){return z("error",K,L)},H=function(K,L){return z("",K,L,true)};var J=function(K,L){var M;if(!L&&n[K]){return n[K]}M=g.i18n.getText("portlet.social.timeline.timeline",K,L);if(!L){n[K]=M}return M};var h=function(L,K){return g.i18n.getText("common",L,K)};var s=function(K,L){K.find("a[data-user-identity]").each(function(){var M=r(this);M.attr("href",L+"?identity="+M.data("user-identity"))})};var F=function(K,L){K.find("a[data-social-tag-id]").each(function(){var M=r(this);M.attr("href",L+"?tag="+M.data("social-tag-name"))})};var A=function(){if((D&&x)||!D){return true}m.trigger(m.types.notifyUser,{type:"error",heading:h("error"),message:J("inactiveGroupMessage")});return false};var p=t.Model.extend({defaults:{comment:"",likes:0,date:0,author:{fullName:"",buddyIconURL:"/sitevision/core/profile_32.png"}},url:function(){if(this.collection){return this.collection.url()+"&commentId="+this.get("id")}return"?commentId="+this.get("id")}});var a=t.Model.extend({defaults:{message:"",likes:0,commentsCount:0,date:0,isRemovable:false,entryOwnerId:null,author:{fullName:"",largeBuddyIconURL:"/sitevision/core/profile.png"},removeTitle:J("removeEntryTitle")},initialize:function(){var L,K;if(this.collection){this.listenTo(this.collection,"markAsRead",this.markAsRead);if(this.collection.isCompoundTimeline){L=this.get("author");K=this.get("entryOwnerId");if((L.id!==d&&K!==d)||L.postedInGroup){this.set("removeTitle",J("hideEntryTitle"))}}}},markAsRead:function(){this.set({markAsUnread:false},{silent:true})},url:function(){if(this.collection){return this.collection.url()+"&entry="+this.get("id")}return"?entry="+this.get("id")}});var w=t.Collection.extend({model:a,page:1,initialize:function(L,K){this.id=K.id;this.portletId=K.portletId;this.addSharedEntries=K.addSharedEntries;this.readTimeout=K.readTimeout;this.bindServerEvents(K.timelineChannel);this.isCompoundTimeline=K.isCompoundTimeline;this.isTagTimeline=K.isTagTimeline;this.activeSession=true;this.updateRead()},bindServerEvents:function(L){var K=this;m.on("server-"+L,function(Q){var P=Q.data,M=P.type,O=P.content,N;if(M==="entry"){O.markAsUnread=O.author.id!==d;if(this.isCompoundTimeline){O.isRemovable=true}else{if(this.isTagTimeline){O.isRemovable=false}else{if(D&&c){O.isRemovable=true}else{if(O.author.id===d){O.isRemovable=true}else{O.isRemovable=false}}}}K.add(O,{append:false})}else{if(M==="comment"){N=K.get(O.entryId);if(O.comment.author.id===d){O.comment.isRemovable=true}else{if(D&&c){O.comment.isRemovable=true}else{O.comment.isRemovable=false}}if(N){N.trigger("update:comments",O)}}else{if(M==="like"){N=K.get(O.entryId);if(N){N.trigger("update:likes",O)}}else{f.warn(null,"message.type "+Q.type+" not supported")}}}})},updateRead:function(){if(D){return}var K=this;this.updateInterval=window.setInterval(function(){var L=K.at(0);if(K.activeSession&&L&&L.get("markAsUnread")){r.ajax({method:"PUT",url:i.getPortletResourceUri(K.portletId,"markAsRead")+"&latestEntry="+L.get("id")}).done(function(){K.trigger("markAsRead")}).fail(function(M){switch(M.status){case 401:case 403:K.activeSession=false;break}})}},K.readTimeout*1000)},comparator:function(L,K){L=B(L.get("date")).unix();K=B(K.get("date")).unix();if(L<K){return 1}else{if(L>K){return -1}}return 0},url:function(){return i.getPortletResourceUri(this.portletId,"timelineEntry")+"&timelineOwner="+this.id}});var q=t.Collection.extend({model:p,initialize:function(L,K){this.id=K.id;this.portletId=K.portletId},url:function(){return i.getPortletResourceUri(this.portletId,"plainComment")+"&entry="+this.id},parse:function(K){this.isAllowedToComment=K.isAllowedToComment;this.trigger("updateCommentArea",this.isAllowedToComment);return K.comments}});var v=t.View.extend({tagName:"li",className:"sv-clearfix sv-timeline-entry",events:{"click [data-fn-toggle-comments]":"toggleComments","click [data-fn-portlet-likable]":"like","click [data-fn-open-comments]":"openComments","click [data-fn-share]":"shareEntry","click [data-fn-destroy-entry]":"showDestroyDialog","click [data-fn-expand-image]":"expandImage"},commentCountTemplate:I.template('<i class="halflings-icon comments"></i> <b class="sv-with-icon"><%= addCommentText %></b> (<%= commentCount %>)'),initialize:function(){this.listenTo(this.model,"destroy",this.remove);this.listenTo(this.model,"update:comments",this.updateComments);this.listenTo(this.model,"update:likes",this.updateLikesCount)},updateComments:function(K){var L;if(this.comments){this.comments.add(K.comment);L=this.comments.length}else{L=K.count}this.updateCommentsCount(L)},updateCommentsCount:function(L){var K=this.$el.find("[data-fn-comment]");K.html(this.commentCountTemplate({addCommentText:J("addComment"),commentCount:L}))},updateLikesCount:function(L){var K=this.$el.find("[data-fn-portlet-likable]").first();K.data({"like-count":L.count,likes:L.usersThatLike});m.trigger(m.types.updateLikables,K)},expandImage:function(L){var K=r(L.currentTarget).attr("href");r.fancybox({padding:5,href:K,titlePosition:"inside",title:this.model.get("message"),transitionIn:"elastic",transitionOut:"elastic"});return false},handleLink:function(M){var K=r(M.currentTarget),L=K.attr("href");if(K.is("[data-fn-expand-image]")){return this.expandImage(L)}else{if(K.is("[data-fn-toggle-comments]")){this.toggleComments(M);return false}}if(L){window.location.href=L;return false}},remove:function(){var K=this;this.$el.fadeOut(function(){K.$el.remove()})},showDestroyDialog:function(){var N=this,O,K,M=this.model.get("author"),L=this.model.get("entryOwnerId");if(!A()){return false}if(this.model.collection.isCompoundTimeline&&((M.id!==d&&L!==d)||M.postedInGroup)){O=J("hideEntryTitle");K=J("hideEntryBody")}else{O=J("removeEntryTitle");K=J("removeEntryBody")}g.DialogUtil.showConfirmDialog(O,K,function(P){if(P){N.model.destroy({wait:true})}});return false},shareEntry:function(){if(!A()){return false}var Q=this,N=r("<div/>").addClass("sv-timeline-portlet"),R=r("<div/>").addClass("sv-timline"),P=r("<blockquote/>").addClass("sv-clearfix sv-timeline-entry").css({margin:"1em 0",padding:"0",border:"none"}),L;if(this.model.get("sharedEntry")){L=this.$el.find("[data-fn-shared-entry]")}else{L=this.$el}P.append(L.find("a").first().clone()).append(L.find("h3,h4").first().clone().css("margin","0")).append(L.find("p").first().clone());P.find("img").css({"margin-right":"1em",width:"48px"});R.append(P);N.append(R);var M=r("<label/>").attr("for","sharecomment").text(J("shareComment"));N.append(M);var K=r("<textarea/>").attr("id","sharecomment").addClass("sv-timeline-input sv-border-box");N.append(K);var O=[{text:J("share"),callback:function(){r.ajax({type:"POST",dataType:"JSON",url:i.getPortletResourceUri(Q.options.portletId,"shareTimelineEntry"),data:{message:K.triggeredInput("getRichContent"),entry:Q.model.get("sharedEntry")?Q.model.get("sharedEntry").id:Q.model.get("id")},success:function(S){if(Q.model.collection.addSharedEntries){Q.model.collection.add(S,{append:false})}else{m.trigger(m.types.notifyUser,{type:"success",heading:J("sharedMessageTitle"),message:J("sharedMessageContent"),"transient":true,timer:5})}}})}}];g.DialogUtil.showDialog({title:J("shareEntry"),body:N,buttons:O,shownCallback:function(){K.triggeredInput(b)}});return false},like:function(K){if(A()){return g.LikableUtil.toggleLike.call(K.currentTarget)}return false},openComments:function(P){var N=this,M=this.model.get("id"),L=this.$el.find(".sv-timeline-comments"),O=this.$el.find(".sv-comments-loading"),K=r(P.currentTarget).is("[data-fn-comment]"),Q;if(!this.comments){this.comments=new q([],{id:M,portletId:this.options.portletId});this.commentsView=new e({el:L,collection:this.comments,profilePageURL:this.options.profilePageURL,tagResultPageURL:this.options.tagResultPageURL});this.listenTo(this.comments,"add destroy",function(){N.updateCommentsCount.call(N,N.comments.length)})}if(L.is(":hidden")){Q=setTimeout(function(){O.show()},400);this.comments.fetch({success:function(R){N.commentsView.render();clearTimeout(Q);O.hide();N.updateCommentsCount(R.length);L.fadeIn("fast",function(){if(K){L.find("textarea").focus()}})}});this.$el.find("[data-fn-toggle-comments]").html(C({text:J("collapse"),direction:"up"}))}else{if(K){L.find("textarea").focus()}}return false},toggleComments:function(L){var K=this.$el.find(".sv-timeline-comments");L.preventDefault();if(K.is(":hidden")){this.openComments(L)}else{K.fadeOut();this.$el.find("[data-fn-toggle-comments]").html(C({text:J("expand"),direction:"down"}))}},fixLinks:function(){var K=this.$el.find("[data-fn-message-content]");s(K,this.options.profilePageURL);F(K,this.options.tagResultPageURL)},render:function(){this.$el.html(this.options.template(this.model.toJSON()));this.fixLinks();m.trigger(m.types.updateLikables,this.$el);m.trigger(m.types.updateRelativeDates,this.$el);return this}});var o=t.View.extend({initialize:function(){this.$list=this.$el.find("ol[data-fn-timeline]");this.bindCollectionEvents();this.bindPlugins();this.listenTo(this.collection,"markAsRead",function(){this.$list.find(".sv-new").removeClass("sv-new")});var K=this;m.on(m.types.groupPageViewed,function(){K.$list.find(".sv-new").removeClass("sv-new")});if(this.collection.length>0){this.render()}},bindPlugins:function(){var K=this,L=this.$el.closest(".sv-timeline-portlet");this.getTextField().triggeredInput(b).elastic();this.$el.find("[data-fn-message-form] input").fileupload({dataType:"json",url:i.getModelObjectUri(K.options.timelineOwner,"timelineFileUpload"),replaceFileInput:true,formAcceptCharset:"utf-8",submit:function(P,O){var N=O.files[0],M=N.size;if(!M){M=1}if(!u(N.name,M,K.options.timelineOwner,y.getObjectId(L.attr("id")))){return false}if(g.SearchFileUtil.fileNameExists({repository:K.options.timelineOwner,fileName:N.name})){return G(h("error-fileExistsHeading"),h("error-fileExists",N.name))}K.$el.find("[data-fn-add-file]").hide();K.$el.find("[data-fn-file-loading]").show();K.disableTextField()},done:function(N,M){K.uploadedFile=M.result.result;K.$el.find("[data-fn-file-loading]").hide();K.$el.find("[data-fn-filename]").text(K.uploadedFile.name);K.$el.find("[data-fn-file-added]").show();K.enableTextField();K.getTextField().focus()}})},resetAttachmentField:function(){this.$el.find("[data-fn-file-added]").hide();this.$el.find("[data-fn-file-loading]").hide();this.$el.find("[data-fn-add-file]").show()},bindCollectionEvents:function(){this.listenTo(this.collection,"add",this.addOne)},render:function(){this.clearList();this.collection.each(function(K){this.appendOne(K)},this)},addOne:function(L,M,K){if(K.append){this.appendOne(L)}else{this.prependOne(L)}},prependOne:function(P){var L=new v({model:P,template:this.options.timelineEntryTemplate,portletId:this.options.portletId,profilePageURL:this.options.profilePageURL,tagResultPageURL:this.options.tagResultPageURL});var K=L.render().$el;var M=K.find(".sv-message-content");var O=M.find(".sv-truncate-more"),N;if(O.length>0){this.addShowMoreLink(O);N=true}this.$list.prepend(K);if(N){this.bindShowMoreEvents(K)}},appendOne:function(P){var L=new v({model:P,template:this.options.timelineEntryTemplate,portletId:this.options.portletId,profilePageURL:this.options.profilePageURL,tagResultPageURL:this.options.tagResultPageURL});var K=L.render().$el;var M=K.find(".sv-message-content");var O=M.find(".sv-truncate-more"),N;if(O.length>0){this.addShowMoreLink(O);N=true}this.$list.append(K);if(N){this.bindShowMoreEvents(K)}},bindShowMoreEvents:function(M){var L={moreText:J("showMore"),lessText:J("showLess")};var O=r(".sv-truncate-more-link",M),N=r(".sv-truncate-more",M),K=r(".sv-truncate-ellipsis",M);O.on("click",function(P){P.preventDefault();if(O.text()===L.moreText){N.show();O.text(L.lessText);K.css("display","none")}else{N.hide();O.text(L.moreText);K.css("display","inline")}})},addShowMoreLink:function(K){r('<span class="sv-truncate-ellipsis">...</span>').insertBefore(K);r('<div><a href="#" class="sv-truncate-more-link">'+J("showMore")+"</a></div>").insertAfter(K);K.css("display","none")},appendAll:function(K){K.each(this.appendOne,this)},clearList:function(){this.$list.empty()},events:{"click [data-fn-message-input]":"expandTextfield","focus [data-fn-message-input]":"expandTextfield","keyup [data-fn-message-input]":"countdownCharactersLeft","keydown [data-fn-message-input]":"checkKeyDown","submit [data-fn-message-form]":"addNewEntry","click [data-fn-load-more]":"loadMoreEntries","click [data-fn-destroy-file]":"destroyFile"},destroyFile:function(){r.ajax({url:i.getModelObjectUri(this.options.timelineOwner,"timelineFileUpload")+"/"+this.uploadedFile.id,type:"DELETE"});this.uploadedFile=undefined;this.$el.find("[data-fn-file-added]").hide();this.$el.find("[data-fn-add-file]").show();return false},loadMoreEntries:function(){var K=this;this.collection.page+=1;this.collection.fetch({add:true,remove:false,data:{page:this.collection.page,lastEntryId:this.collection.at(this.collection.length-1).get("id")},append:true,success:function(M,L){K.collection.sort();if(L.length<K.options.loadMoreCount){K.$el.find("button[data-fn-load-more]").addClass("disabled").attr("disabled","disabled").text(J("noMoreEntries"))}}})},getSubmitButton:function(){if(!this.$submitButton){this.$submitButton=this.$el.find("[data-fn-message-submit]")}return this.$submitButton},getLoader:function(){if(!this.$loader){this.$loader=r('<img src="/sitevision/util/images/loading_16_grey.gif" />').css("vertical-align","middle").appendTo(this.getSubmitButton().parent())}return this.$loader},getTextField:function(){if(!this.$textField){this.$textField=this.$el.find("[data-fn-message-input]")}return this.$textField},isDisabled:function(){return this.getSubmitButton().hasClass("disabled")},disableTextField:function(){this.getSubmitButton().addClass("disabled").attr("disabled","disabled")},enableTextField:function(){var K=this.getTextField();if(K.val()!==""){this.getSubmitButton().removeClass("disabled").removeAttr("disabled")}},addNewEntry:function(){var N=this,K=this.getTextField(),M=K.val(),L=k-M.length,P,O;if(M!==""&&L>=0){if(!A()||this.isDisabled()||this.activeConnection){return false}O=setTimeout(function(){N.getLoader().show()},400);this.disableTextField();this.activeConnection=true;P=new a({message:K.triggeredInput("getRichContent"),file:N.uploadedFile?N.uploadedFile.id:undefined});this.collection.create(P,{wait:true,clearTextField:true,clearUploadedFile:true,success:function(){var Q=N.$el.find("[data-fn-message-input-size]"),R=Q.data("initial-size");N.getTextField().val("");if(N.uploadedFile){m.trigger(m.types.fileAdded)}clearTimeout(O);N.getLoader().hide();N.uploadedFile=undefined;N.resetAttachmentField();Q.text(R);N.activeConnection=false;N.collection.trigger("markAsRead")},error:function(){N.getLoader().hide();N.enableTextField();N.activeConnection=false}})}return false},expandTextfield:function(K){r(K.currentTarget).addClass("sv-message-input-expanded");this.getSubmitControls().show();this.countdownCharactersLeft(K)},getSubmitControls:function(){if(!this.$submitControls){this.$submitControls=this.$el.find(".sv-submit-message-controls")}return this.$submitControls},checkKeyDown:function(L){var K=j.getKeyCodeFromEvent(L);if(K===E.RETURN&&L.ctrlKey){this.$el.find("[data-fn-message-form]").submit();return false}},countdownCharactersLeft:function(M){var K=r(M.currentTarget),N=K.val(),L=k-N.length,O=this.$el.find("[data-fn-message-input-size]");if(L<0){O.addClass("sv-character-limit-exceeded")}else{O.removeClass("sv-character-limit-exceeded")}O.text(L);if(K.val()!==""&&L>=0&&!this.activeConnection){this.enableTextField()}else{this.disableTextField()}}});var u=function(O,K,L,N){var M=false;r.ajax({type:"GET",url:g.PortletUtil.getPortletResourceUri(N,"verifyUpload")+"&repository="+L+"&name="+O+"&size="+K,async:false,success:function(P){M=P.verified},error:function(P){g.ErrorUtil.handleAjaxFailure(P)}});return M};var l=t.View.extend({tagName:"li",className:"sv-clearfix sv-timeline-comment",events:{"click [data-fn-portlet-likable]":"like","click [data-fn-destroy-comment]":"showDestroyDialog"},initialize:function(){this.listenTo(this.model,"destroy",this.remove)},remove:function(){var K=this;this.$el.fadeOut(function(){K.$el.remove()})},showDestroyDialog:function(){var K=this;if(!A()){return false}g.DialogUtil.showConfirmDialog(J("removeCommentTitle"),J("removeCommentBody"),function(L){if(L){K.model.destroy({wait:true})}});return false},like:function(K){if(A()){return g.LikableUtil.toggleLike.call(K.currentTarget)}},fixLinks:function(){var K=this.$el.find("[data-fn-message-content]");s(K,this.options.profilePageURL);F(K,this.options.tagResultPageURL)},render:function(){this.$el.html(this.options.template(this.model.toJSON()));this.fixLinks();return this}});var e=t.View.extend({initialize:function(){this.$list=this.$el.find("ol");this.bindCollectionEvents();this.commentTemplate=g.PortletUtil.getTemplate(this.$el.closest(".sv-timeline-portlet,.sv-tagtimeline-portlet"),"comment");this.getTextField().triggeredInput(b).elastic();if(this.collection.length>0){this.render()}},bindCollectionEvents:function(){this.listenTo(this.collection,"add",this.addNewComment);this.listenTo(this.collection,"updateCommentArea",this.updateCommentArea)},updateCommentArea:function(K){this.$el.find("[data-fn-comment-area]")[K?"removeClass":"addClass"]("sv-hidden")},addNewComment:function(K){this.appendOne(K);m.trigger(m.types.updateRelativeDates,this.$el);m.trigger(m.types.updateLikables,this.$el)},render:function(){this.clearList();this.collection.each(function(K){this.appendOne(K)},this);m.trigger(m.types.updateRelativeDates,this.$el);m.trigger(m.types.updateLikables,this.$el)},appendOne:function(O){var L=new l({model:O,template:this.commentTemplate,profilePageURL:this.options.profilePageURL,tagResultPageURL:this.options.tagResultPageURL});var P=L.render().$el;var K=P.find(".sv-comment-content");var N=K.find(".sv-truncate-more"),M;if(N.length>0){this.addShowMoreLink(N);M=true}this.$list.append(P);if(M){this.bindShowMoreEvents(P)}},bindShowMoreEvents:function(M){var L={moreText:J("showMore"),lessText:J("showLess")};var O=r(".sv-truncate-more-link",M),N=r(".sv-truncate-more",M),K=r(".sv-truncate-ellipsis",M);O.on("click",function(P){P.preventDefault();if(O.text()===L.moreText){N.show();O.text(L.lessText);K.css("display","none")}else{N.hide();O.text(L.moreText);K.css("display","inline")}})},addShowMoreLink:function(K){r('<span class="sv-truncate-ellipsis">...</span>').insertBefore(K);r('<div><a href="#" class="sv-truncate-more-link">'+J("showMore")+"</a></div>").insertAfter(K);K.css("display","none")},appendAll:function(K){K.each(this.appendOne,this)},clearList:function(){this.$list.empty()},getLoader:function(){if(!this.$loader){this.$loader=r('<img src="/sitevision/util/images/loading_16_grey.gif" />').css("vertical-align","middle").appendTo(this.$el.find("[data-fn-comment-input]").parent())}return this.$loader},countdownCharactersLeft:function(M){var K=r(M.currentTarget),N=K.val(),L=k-N.length,O=this.$el.find("[data-fn-comment-input-size]");if(L<0){O.addClass("sv-character-limit-exceeded")}else{O.removeClass("sv-character-limit-exceeded")}O.text(L);if(N!==""&&L>=0&&!this.activeConnection){this.getSubmitButton().removeClass("disabled").removeAttr("disabled")}else{this.getSubmitButton().addClass("disabled").attr("disabled","disabled")}},getSubmitButton:function(){if(!this.$submitButton){this.$submitButton=this.$el.find("[data-fn-comment-submit]")}return this.$submitButton},getTextField:function(){if(!this.$textField){this.$textField=this.$el.find("[data-fn-comment-input]")}return this.$textField},getSubmitControls:function(){if(!this.$submitControls){this.$submitControls=this.$el.find(".sv-submit-controls")}return this.$submitControls},events:{"keydown [data-fn-comment-input]":"expandTextfield","keyup [data-fn-comment-input]":"countdownCharactersLeft","click [data-fn-comment-submit]":"postComment"},checkKeyDown:function(L){var K=j.getKeyCodeFromEvent(L);if(K===E.RETURN&&L.ctrlKey){this.postComment(L)}},expandTextfield:function(K){r(K.currentTarget).addClass("sv-comment-input-expanded");this.getSubmitControls().show();this.countdownCharactersLeft(K);this.checkKeyDown(K)},postComment:function(O){var L=this,P,K,N,M;O.preventDefault();N=this.getTextField();K=N.val().length;if(K>0&&K<=k){this.activeConnection=true;P=new p({comment:N.triggeredInput("getRichContent")});M=setTimeout(function(){L.getLoader().show()},400);this.collection.create(P,{wait:true,success:function(){N.val("").focus().css("height","20px");L.activeConnection=false;L.getLoader().hide();clearTimeout(M);L.getSubmitControls().hide()},error:function(){L.activeConnection=false;L.getLoader().hide();clearTimeout(M)}})}else{if(K>k){H(J("commentToLongHeading"),J("commentToLongBody"))}}return false}});r(".sv-timeline-portlet,.sv-tagtimeline-portlet").each(function(){var O=r(this),P=g.ObjectUtil.getObjectId(O.attr("id")),N=O.find("ol"),K=N.data("js-namespace"),Q=g[K],R,M;if(!Q){return}R=Q.timelineOwner;M=Q.timelineChannel;D=Q.isGroupPage;x=Q.isActiveGroup;c=Q.isGroupAdmin;d=Q.userIdentity;k=Q.maxCharacterCount;var S=new w(Q.entries||[],{id:R,timelineChannel:M,portletId:P,addSharedEntries:R===d,readTimeout:Q.readTimeout,isCompoundTimeline:Q.isCompoundTimeline,isTagTimeline:Q.isTagTimeline}),L=new o({el:O,collection:S,timelineEntryTemplate:i.getTemplate(O,"timeline-entry"),portletId:P,timelineOwner:R,tagResultPageURL:Q.tagResultPageURL,profilePageURL:Q.profilePageURL,loadMoreCount:Q.loadMoreCount});f.debug(null,"initialized portlet "+P+" and it's timelineView "+L.cid)})}());(function(){var q=window.sv,k=q.PortletUtil,m=q.ObjectUtil,l=q.KeyUtil,i=q.Log,c=l.KEY,a=q.Events,f=window.$svjq,b=window.Backbone,t=window._,n={},e,g,s={triggers:{"@":{source:k.getUtilityApiUri("socialsearchutil","contacts"),searchKey:"term",allowWhiteSpace:true,parse:function(v){return v.hits}}},minLength:2,replacer:function(v){return v.trigger+'{"value":"'+v.name+'","id":"'+v.id+'"}'}};var o=function(v,w){var x;if(!w&&n[v]){return n[v]}x=q.i18n.getText("portlet.social.timeline.timeline",v,w);if(!w){n[v]=x}return x};var d=function(v,w){v.find("a[data-user-identity]").each(function(){var x=f(this);x.attr("href",w+"?identity="+x.data("user-identity"))})};var u=function(v,w){v.find("a[data-social-tag-id]").each(function(){var x=f(this);x.attr("href",w+"?tag="+x.data("social-tag-name"))})};var p=b.Model.extend({url:function(){if(this.collection){return this.collection.url()+"&commentId="+this.get("id")}return"?commentId="+this.get("id")}});var j=b.Collection.extend({model:p,initialize:function(w,v){this.options=v},url:function(){return k.getPortletResourceUri(this.options.portletId,"plainComment")+"&entry="+this.options.id}});var h=b.View.extend({tagName:"li",className:"sv-timeline-comment",events:{"click [data-fn-destroy-comment]":"showDestroyDialog"},initialize:function(){this.model.on("destroy",this.remove,this)},remove:function(){var v=this;this.$el.fadeOut(function(){v.$el.remove()})},showDestroyDialog:function(){var v=this;if(!this.model.get("isRemovable")){return false}q.DialogUtil.showConfirmDialog(o("removeEntryTitle"),o("removeEntryBody"),function(w){if(w){v.model.destroy({wait:true})}})},render:function(){this.$el.html(this.options.template(this.model.toJSON()));d(this.$el,this.options.profilePageURL);u(this.$el,this.options.tagResultPageURL);return this}});var r=b.View.extend({initialize:function(){this.$list=this.$el.find("[data-fn-comments]");this.collection.on("add",this.addNewComment,this);this.collection.on("add",this.updateCommentCount,this);this.collection.on("destroy",this.updateCommentCount,this);this.commentCountTemplate=t.template('<i class="halflings-icon comments"></i> <b class="sv-with-icon"><%= addCommentText %></b> (<%= commentCount %>)');this.getTextField().triggeredInput(s).elastic();this.getTextField().css("height","20px");if(this.collection.length>0){this.render()}},render:function(){this.clearList();this.collection.each(function(v){this.appendOne(v)},this);a.trigger(a.types.updateRelativeDates,this.$el);a.trigger(a.types.updateLikables,this.$el)},updateCommentCount:function(){var v=this.$el.find("[data-fn-comments-count]");v.html(this.commentCountTemplate({addCommentText:o("comments"),commentCount:this.collection.length}))},clearList:function(){this.$list.empty()},appendOne:function(A){var w=new h({model:A,template:this.options.commentTemplate,profilePageURL:this.options.profilePageURL,tagResultPageURL:this.options.tagResultPageURL});var z=w.render().$el;var v=z.find(".sv-message-content");var y=v.find(".sv-truncate-more"),x;if(y.length>0){this.addShowMoreLink(y);x=true}this.$list.append(z);if(x){this.bindShowMoreEvents(z)}},bindShowMoreEvents:function(x){var w={moreText:o("showMore"),lessText:o("showLess")};var z=f(".sv-truncate-more-link",x),y=f(".sv-truncate-more",x),v=f(".sv-truncate-ellipsis",x);z.on("click",function(A){A.preventDefault();if(z.text()===w.moreText){y.show();z.text(w.lessText);v.css("display","none")}else{y.hide();z.text(w.moreText);v.css("display","inline")}})},addShowMoreLink:function(v){f('<span class="sv-truncate-ellipsis">...</span>').insertBefore(v);f('<div><a href="#" class="sv-truncate-more-link">'+o("showMore")+"</a></div>").insertAfter(v);v.css("display","none")},addNewComment:function(w){var v=this.$el.find("[data-fn-message-comment-count]");this.appendOne(w);a.trigger(a.types.updateRelativeDates,this.$el);a.trigger(a.types.updateLikables,this.$el);v.text(window.parseInt(v.text(),10)+1)},getLoader:function(){if(!this.$loader){this.$loader=f('<img src="/sitevision/util/images/loading_16_grey.gif" />').css("vertical-align","middle").appendTo(this.$el.find("[data-fn-comment-input]").parent())}return this.$loader},countdownCharactersLeft:function(x){var v=f(x.currentTarget),y=v.val(),w=g-y.length,z=this.$el.find("[data-fn-comment-input-size]");if(w<0){z.addClass("sv-character-limit-exceeded")}else{z.removeClass("sv-character-limit-exceeded")}z.text(w);if(y!==""&&w>=0&&!this.activeConnection){this.getSubmitButton().removeClass("disabled").removeAttr("disabled")}else{this.getSubmitButton().addClass("disabled").attr("disabled","disabled")}},getSubmitButton:function(){if(!this.$submitButton){this.$submitButton=this.$el.find("[data-fn-comment-submit]")}return this.$submitButton},getTextField:function(){if(!this.$textField){this.$textField=this.$el.find("[data-fn-comment-input]")}return this.$textField},getSubmitControls:function(){if(!this.$submitControls){this.$submitControls=this.$el.find(".sv-submit-controls")}return this.$submitControls},events:{"keydown [data-fn-comment-input]":"expandTextfield","keyup [data-fn-comment-input]":"countdownCharactersLeft","click [data-fn-comment-submit]":"postComment"},checkKeyDown:function(w){var v=l.getKeyCodeFromEvent(w);if(v===c.RETURN&&w.ctrlKey){this.postComment(w)}},expandTextfield:function(v){f(v.currentTarget).addClass("sv-comment-input-expanded");this.getSubmitControls().show();this.countdownCharactersLeft(v);this.checkKeyDown(v)},postComment:function(z){var w=this,y,v,A,x;z.preventDefault();if(this.activeConnection){return false}y=this.getTextField();v=y.val().length;if(v>0&&v<=g){this.activeConnection=true;A=new p({comment:y.triggeredInput("getRichContent")});x=setTimeout(function(){w.getLoader().show()},400);this.collection.create(A,{wait:true,success:function(){y.val("").focus().css("height","20px");w.activeConnection=false;w.getLoader().hide();clearTimeout(x);w.getSubmitControls().hide()},error:function(){w.activeConnection=false;w.getLoader().hide();clearTimeout(x)}})}else{if(v>g){a.trigger(a.types.notifyUser,{type:"default",heading:o("commentToLongHeading"),message:o("commentToLongBody"),"transient":true})}}return false},shareEntry:function(){var z=this,x=f("<div/>").addClass("sv-timelineentry-portlet"),C=f("<div/>").addClass("sv-timline"),D=f("<blockquote/>").addClass("sv-clearfix sv-timeline-entry").css({margin:"1em 0",padding:"0",border:"none"}),y;var w=this.$el.find("[data-fn-shared-entry]");if(w.length>0){y=w}else{y=this.$el}D.append(y.find("a").first().clone()).append(y.find("h3,h4").first().clone().css("margin","0")).append(y.find("p").first().clone());D.find("img").css({"margin-right":"1em",width:"48px"});C.append(D);x.append(C);var B=f("<label/>").attr("for","sharecomment").text(o("shareComment"));x.append(B);var v=f("<textarea/>").attr("id","sharecomment").addClass("sv-timeline-input sv-border-box").css("width","100%");x.append(v);var A=[{text:o("share"),callback:function(){f.ajax({type:"POST",dataType:"JSON",url:k.getPortletResourceUri(z.options.portletId,"shareTimelineEntry"),data:{message:v.triggeredInput("getRichContent"),entry:w.length>0?w.data("entry-id"):z.collection.options.id},success:function(){a.trigger(a.types.notifyUser,{type:"success",heading:o("sharedMessageTitle"),message:o("sharedMessageContent"),"transient":true,timer:5})}})}}];q.DialogUtil.showDialog({title:o("shareEntry"),body:x,buttons:A,shownCallback:function(){v.triggeredInput(s)}});return false}});f(".sv-timelineentry-portlet").each(function(){var B=f(this),x=B.find("[data-timeline-entry]"),z=m.getObjectId(B.attr("id")),w=x.data("js-namespace"),y=q[w],A=y.entryId;g=y.maxCharacterCount;e=y.userIdentity;f("[data-fn-expand-image]").on("click",function(){f.fancybox({padding:5,href:f(this).attr("href"),titlePosition:"inside",title:B.find("[data-fn-message-content]").html(),transitionIn:"elastic",transitionOut:"elastic"});return false});var C=new j(y.comments||[],{id:A,portletId:z,active:y.active}),v=new r({el:B,collection:C,commentTemplate:k.getTemplate(B,"comment"),portletId:z,profilePageURL:y.profilePageURL,tagResultPageURL:y.tagResultPageURL});i.debug(null,"Initialized portlet "+z+" with commentsView "+v.cid);d(B,y.profilePageURL);u(B,y.tagResultPageURL)})}());(function(){var h=window.Backbone,j=window.sv,c=j.PortletUtil,g=j.ClientUtil,m=j.Events,d=j.ErrorUtil,i=j.ObjectUtil,e=window.$svjq,l={};var o=function(p,q){var r;if(!q&&l[p]){return l[p]}r=j.i18n.getText("portlet.social.usercontactsall.usercontactsall",p,q);if(!q){l[p]=r}return r};var a=h.Model.extend({defaults:{fullName:"",profileImageURL:"",profilePageURL:"/",userFields:[]},url:function(){return this.collection.url()+"&contact="+this.get("id")},getProfilePageUrl:function(){return this.get("showProfileURL")}});var f=h.Collection.extend({model:a,initialize:function(q,p){this.id=p.id;this.portletId=p.portletId},url:function(){return c.getPortletResourceUri(this.portletId,"contact")},comparator:function(p){if(p.get("fullName")!==null){return p.get("fullName").toLowerCase()}else{return null}}});var n=h.View.extend({tagName:"li",className:"sv-clearfix sv-social-contact",events:{"click [data-fn-destroy]":"destroy",click:"navigate"},initialize:function(){this.bindModelEvents()},bindModelEvents:function(){this.model.on("filter",this.toggleVisible,this);this.model.on("destroy",this.remove,this)},destroy:function(){this.model.destroy({wait:true,error:function(q,r,p){d.handleBackboneError(q,r,p)}});return false},navigate:function(p){if((g.isMac&&p.metaKey)||(!g.isMac&&p.ctrlKey)||p.shiftKey){window.open(this.model.getProfilePageUrl())}else{window.location.href=this.model.getProfilePageUrl()}return},toggleVisible:function(p){this.$el.toggleClass("sv-hidden",!this.isVisible(p.filter))},isVisible:function(q){var p=this.model.get("fullName")+this.model.get("userFields").join("|");return !q||(p&&p.toLowerCase().indexOf(q.toLowerCase())!==-1)},remove:function(){var p=this;this.$el.fadeOut("3000",function(){p.$el.remove();m.trigger(m.types.notifyUser,{type:"success",message:o("successMessage",p.model.get("fullName")),"transient":true,timer:5})})},render:function(){this.$el.html(this.options.template(this.model.toJSON()));return this}});var b=h.View.extend({events:{"click [data-fn-switch-list-style]":"setListStyle","keyup [data-fn-filter]":"setFilter","change [data-fn-filter]":"setFilter","blur [data-fn-filter]":"setFilter"},initialize:function(){this.$list=this.$el.find("ol");this.listStyle=this.options.listStyle;if(this.collection.length>0){this.render()}},render:function(){this.clearList();this.collection.each(function(p){this.appendOne(p)},this)},appendOne:function(q){var p=new n({model:q,template:this.options.socialContactTemplate});this.$list.append(p.render().el)},filterOne:function(q,p){q.trigger("filter",{filter:p})},filterAll:function(p){this.collection.each(function(q){this.filterOne(q,p)},this)},clearList:function(){this.$list.empty()},setListStyle:function(q){var p=e(q.currentTarget).data("list-style");this.$list.removeClass(this.listStyle).addClass(p);this.listStyle=p},setFilter:function(p){this.filterAll(p.currentTarget.value)}});var k=e(".sv-usercontactsall-portlet");k.each(function(){var v=e(this),u=i.getObjectId(v.attr("id")),r=v.find("ol"),q=r.data("js-namespace"),s=r.data("user-identity"),t=c.getTemplate(v,"contact"),p=new f(j[q]||[],{id:s,portletId:u});new b({el:v,collection:p,listStyle:"sv-list-2-columns",socialContactTemplate:t});v.find("li.sv-social-contact").css("height",r.data("item-height"));if(!g.supportsPlaceholder){v.find(".sv-filter-label").removeClass("sv-hidden")}})}());(function(){var b=window.$svjq,a=window.sv.UserSettingsUtil;b(".sv-userfields-portlet").on("click","[data-fn-edit-userfields]",function(){var c=b(this).attr("data-fields");a.popupUserSettingsDialog(c)})}());(function(){var h=window.$svjq;var k=window.sv;var i=window.Backbone;var n=k.Events;var o=k.i18n;var g=k.DialogUtil;var j=k.ObjectUtil;var b=k.PortletUtil;var a=k.ErrorUtil;var l=function(q,p){return o.getText("portlet.social.usergroupsall.usergroupsall",q,p)};var c=i.Model.extend({url:function(){var p=this.get("id");return this.collection.url()+"&group="+p}});var f=i.Collection.extend({model:c,initialize:function(q,p){this.portletId=p.portletId},url:function(){return b.getPortletResourceUri(this.portletId,"groupMembership")}});var d=i.View.extend({tagName:"li",className:"sv-clearfix sv-usergroup-list-item",events:{"click [data-fn-usergroup-leave]":"leaveGroup","click [data-fn-usergroup-remove]":"removeGroup"},initialize:function(){this.template=this.options.template;this.portletId=this.options.portletId;this.bindModelEvents()},bindModelEvents:function(){this.model.on("destroy",this.removeFromView,this);this.model.on("filterModified",this.filterWasModified,this)},render:function(){this.$el.html(this.template(this.model.toJSON(),this.model));return this},leaveGroup:function(){this.model.destroy({wait:true,error:function(q,r,p){a.handleBackboneError(q,r,p)}});return false},removeGroup:function(){var r=this;var q=r.model;var s=q.get("name");var p=q.get("id");g.showConfirmDialog(l("removeGroupTitle"),l("removeGroupMessage",s),function(t){if(t){h.ajax({type:"DELETE",dataType:"JSON",url:b.getPortletResourceUri(r.portletId,"groupAdministration")+"&group="+p,success:function(){r.$el.fadeOut("3000",function(){r.$el.remove();n.trigger(n.types.notifyUser,{type:"success",heading:l("removedGroupHeading"),message:l("removedGroupMessage",s),"transient":true,timer:5})})}})}})},removeFromView:function(){var p=this;var q=this.model.get("name");this.$el.fadeOut("3000",function(){p.$el.remove();n.trigger(n.types.notifyUser,{type:"success",heading:l("leftGroupHeading"),message:l("leftGroupMessage",q),"transient":true,timer:5})})},filterWasModified:function(p){var q=p.filterStr;this.$el.toggleClass("sv-hidden",!this.isVisible(q))},isVisible:function(q){var p=this.model.get("name");return !q||(p&&p.toLowerCase().indexOf(q.toLowerCase())!==-1)}});var m=i.View.extend({tagName:"ol",initialize:function(){this.groupTemplate=this.options.groupTemplate;this.portletId=this.options.portletId;this.list=this.options.list;this.groupPageTemplates=this.options.groupPageTemplates;this.groupFolder=this.options.groupFolder;this.groupTypes=this.options.groupTypes;this.currentListStyle=this.options.list.data("current-list-style");this.collection.on("add",this.groupAddedToModel,this)},events:{"click [data-fn-usergroup-create]":"addGroup","click [data-fn-change-list-style]":"changeListStyle","keyup [data-fn-filter]":"filterWasModified","change [data-fn-filter]":"filterWasModified","blur [data-fn-filter]":"filterWasModified"},render:function(){this.clearList();this.collection.each(function(p){this.appendOne(p)},this);n.trigger(n.types.updateRelativeDates,this.list)},appendOne:function(q){var p=new d({model:q,portletId:this.portletId,template:this.groupTemplate});this.list.append(p.render().el)},prependOne:function(q){var p=new d({model:q,template:this.groupTemplate});this.list.append(p.render().el)},clearList:function(){this.list.empty()},groupAddedToModel:function(q,r,p){if(p.append){this.appendOne(q)}else{this.prependOne(q)}},addGroup:function(p){k.AddGroupUtil.showSearchPopover({target:p.currentTarget,placeholder:l("groupName"),groupTemplates:this.groupPageTemplates,groupFolder:this.groupFolder,groupTypes:this.groupTypes,portletId:this.portletId,selected:function(q){location.href=q.uri}});return false},changeListStyle:function(r){var p=h(r.currentTarget);var q=p.data("list-style");this.list.removeClass(this.currentListStyle).addClass(q);this.currentListStyle=q},filterWasModified:function(p){var q=p.currentTarget.value;this.collection.each(function(r){r.trigger("filterModified",{filterStr:q})},this)}});var e=h(".sv-usergroupsall-portlet");e.each(function(){var x=h(this);var v=j.getObjectId(x.attr("id"));var t=x.find("ol");var p=t.data("js-namespace");var w=window.sv[p];var u=b.getTemplate(x,"usergroupsall-group");if(!k.ClientUtil.supportsPlaceholder){x.find(".sv-filter-label").removeClass("sv-hidden")}var z=t.data("group-folder");var y=t.data("group-types").split(",");var q=w.groups;var s=new f(q,{portletId:v});var r=new m({el:x,portletId:v,collection:s,groupTemplate:u,groupPageTemplates:w.templates,groupFolder:z,groupTypes:y,list:t});r.render();x.find("li.sv-usergroup-list-item").css("height",t.data("item-height"))})}());